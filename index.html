<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduGamer OS v10.0 Phoenix</title>
    
    <!-- Librerie Esterne -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- LAYOUT BASE --- */
        * { box-sizing: border-box; }
        body { 
            background-color: #0a0e17; 
            color: #e2e8f0; 
            font-family: 'Verdana', sans-serif; 
            margin: 0; 
            height: 100dvh;
            width: 100vw;
            overflow: hidden; 
        }
        #root { height: 100%; width: 100%; }

        /* --- ANIMAZIONI --- */
        @keyframes shimmer { 
            0% { background-position: -200% 0; } 
            100% { background-position: 200% 0; } 
        }
        .xp-bar-fill { 
            background: linear-gradient(90deg, #16a34a, #4ade80, #16a34a); 
            background-size: 200% 100%; 
            animation: shimmer 2s infinite linear; 
        }
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-5px); } 
            50% { transform: translateX(5px); } 
            75% { transform: translateX(-5px); } 
        }
        .shake { animation: shake 0.5s; border-color: #ef4444 !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.3); }
            50% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.6); }
        }
        .pulse-glow { animation: pulse-glow 2s infinite; }

        /* --- UI COMPONENTS --- */
        .cyber-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid #334155;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        .cyber-card:hover { 
            border-color: #4ade80; 
            transform: translateY(-2px); 
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }
        
        .cyber-box { 
            background: rgba(15, 23, 42, 0.95); 
            border: 2px solid #475569; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); 
            transition: all 0.3s ease; 
        }
        .cyber-box.connected { border-color: #3b82f6; }

        .msg-user { background: #166534; color: #dcfce7; border-radius: 12px 12px 0 12px; margin-left: auto; }
        .msg-ai { background: #581c87; color: #f3e8ff; border-radius: 12px 12px 12px 0; margin-right: auto; }

        /* --- SMART EDITOR --- */
        .err-span { 
            cursor: pointer; 
            border-bottom: 2px solid; 
            padding: 0 2px; 
            position: relative; 
            display: inline-block; 
            transition: all 0.2s; 
        }
        .err-span:hover { 
            transform: scale(1.1); 
            z-index: 10; 
            background-color: rgba(255,255,255,0.1); 
        }
        .err-ORT { border-color: #ef4444; color: #fca5a5; }
        .err-PUN { border-color: #eab308; color: #fde047; }
        .err-SIN { border-color: #3b82f6; color: #93c5fd; }
        
        .correction-popup {
            position: absolute; 
            bottom: 100%; 
            left: 50%; 
            transform: translateX(-50%);
            background: #1e293b; 
            border: 2px solid #cbd5e1; 
            padding: 12px; 
            border-radius: 12px;
            z-index: 50; 
            width: 220px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            margin-bottom: 8px; 
            font-size: 14px; 
            color: white; 
            text-align: center;
        }
        .fix-input {
            background: #0f172a; 
            border: 1px solid #475569; 
            color: white; 
            padding: 8px;
            border-radius: 4px; 
            width: 100%; 
            margin-top: 5px; 
            text-align: center;
            font-weight: bold; 
            outline: none; 
            font-size: 16px;
        }
        .fix-input:focus { 
            border-color: #4ade80; 
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.3); 
        }

        /* --- BLOCCHI BASE 10 --- */
        .holo-container {
            display: flex; 
            flex-direction: row; 
            flex-wrap: wrap; 
            gap: 8px;
            align-items: flex-end; 
            padding: 10px; 
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px; 
            border: 1px dashed #475569; 
            min-height: 80px; 
            width: 100%;
            overflow-y: auto;
        }
        .unit-block { 
            width: 15px; 
            height: 15px; 
            background: #4ade80; 
            border: 1px solid #166534; 
            margin: 1px; 
            border-radius: 2px;
        }
        .ten-block { 
            display: flex; 
            flex-direction: column; 
            margin: 2px; 
            border: 1px solid #1e3a8a; 
            border-radius: 3px;
        }
        .ten-segment { 
            width: 15px; 
            height: 15px; 
            background: #3b82f6; 
            border-bottom: 1px solid #1e3a8a; 
        }
        .hundred-block { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            width: 80px; 
            margin: 4px; 
            border: 2px solid #a855f7; 
            border-radius: 4px;
        }
        .hundred-segment { 
            width: 8px; 
            height: 8px; 
            background: #a855f7; 
            border: 0.5px solid #581c87; 
        }

        /* --- TAVOLA PITAGORICA --- */
        .matrix-wrapper { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 10px; 
        }
        .matrix-container {
            display: grid; 
            grid-template-columns: repeat(11, 1fr); 
            grid-template-rows: repeat(11, 1fr);
            gap: 2px; 
            width: 80vmin; 
            height: 80vmin; 
            max-height: 100%; 
            max-width: 100%;
        }
        .matrix-cell {
            width: 100%; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: calc(80vmin / 25); 
            border-radius: 3px; 
            user-select: none;
            transition: all 0.15s ease;
            background-color: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
        }
        .matrix-cell.header { 
            background-color: #0f172a; 
            color: #facc15; 
            font-weight: bold; 
            border: 1px solid #334155; 
        }
        .matrix-cell.header.active { 
            background-color: #eab308; 
            color: #000; 
            box-shadow: 0 0 10px #eab308; 
            z-index: 20; 
            transform: scale(1.1); 
        }
        .matrix-cell.path { 
            background-color: #1e3a5f; 
            color: #4ade80; 
            border: 1px solid #4ade80; 
            opacity: 1 !important; 
        }
        .matrix-cell.result { 
            background-color: #4ade80; 
            color: #020617; 
            font-weight: bold; 
            transform: scale(1.2); 
            z-index: 30; 
            box-shadow: 0 0 15px #4ade80; 
            border: 2px solid #fff; 
            opacity: 1 !important; 
        }
        .matrix-cell.dimmed { 
            opacity: 0.15; 
            filter: grayscale(80%); 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #22c55e; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ICONE SVG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const Icons = {
            Brain: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Home: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Play: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Chat: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Book: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Calc: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Magic: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M3 5h4"/><path d="M19 17v4"/><path d="M17 19h4"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Volume: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATABASE (LocalStorage)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key') || '',
            setKey: (key) => localStorage.setItem('gemini_api_key', key),
            getXP: () => parseInt(localStorage.getItem('edu_xp') || '0'),
            getLevel: () => Math.floor(Math.sqrt(parseInt(localStorage.getItem('edu_xp') || '0') / 10)) + 1,
            addXP: (amount) => {
                try {
                    const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                    localStorage.setItem('edu_xp', next.toString());
                    window.dispatchEvent(new Event('xpChanged'));
                    return next;
                } catch (e) {
                    console.error('Errore salvataggio XP:', e);
                    return 0;
                }
            },
            saveMap: (nodes, lines, summary) => {
                try {
                    localStorage.setItem('saved_nodes', JSON.stringify(nodes));
                    localStorage.setItem('saved_lines', JSON.stringify(lines));
                    localStorage.setItem('saved_summary', summary || '');
                } catch (e) {
                    console.error('Errore salvataggio mappa:', e);
                }
            },
            loadMap: () => {
                try {
                    return {
                        nodes: JSON.parse(localStorage.getItem('saved_nodes') || '[]'),
                        lines: JSON.parse(localStorage.getItem('saved_lines') || '[]'),
                        summary: localStorage.getItem('saved_summary') || ''
                    };
                } catch (e) {
                    return { nodes: [], lines: [], summary: '' };
                }
            },
            clearMap: () => {
                localStorage.removeItem('saved_nodes');
                localStorage.removeItem('saved_lines');
                localStorage.removeItem('saved_summary');
            }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SERVIZIO AI (Gemini) - VERSIONE CORRETTA PER MULTI-IMMAGINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const GeminiService = {
            // Generazione testo semplice
            generate: async (prompt, content = "") => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key nelle impostazioni!");
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: content ? `${prompt}\n\nTesto: ${content}` : prompt }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Errore API Gemini");
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Nessuna risposta";
            },

            // Chat (Tutor)
            chat: async (history, message) => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key nelle impostazioni!");
                
                const contents = [
                    ...history.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: msg.text }]
                    })),
                    { role: 'user', parts: [{ text: message }] }
                ];
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });
                
                if (!response.ok) throw new Error("Errore chat AI");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            },

            // ANALISI IMMAGINI (Ora accetta ARRAY di immagini!)
            analyzeToMap: async (imagesInput) => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key!");
                
                // Assicuriamoci che sia sempre un array, anche se arriva una sola foto
                const imagesArray = Array.isArray(imagesInput) ? imagesInput : [imagesInput];

                const prompt = `Analizza queste immagini di un libro scolastico come se fossero un unico contenuto continuo.
                
                OBIETTIVI:
                1. Unisci il testo di tutte le pagine in un discorso logico.
                2. Considera i "Riquadri" o box laterali come dettagli, non titoli principali.
                3. Estrai 4-6 Concetti Chiave.
                
                Rispondi SOLO con questo JSON esatto:
                {
                    "ocr_text": "testo completo...",
                    "summary": "riassunto...",
                    "nodes": [
                        {"id": 1, "label": "Concetto", "explanation": "Spiegazione semplice..."}
                    ],
                    "connections": [
                        {"from": 1, "to": 2}
                    ]
                }`;

                // Prepara TUTTE le immagini per Gemini
                const imageParts = imagesArray.map(img => ({
                    inlineData: { 
                        mimeType: "image/jpeg", 
                        data: img.includes(',') ? img.split(',')[1] : img 
                    }
                }));

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                ...imageParts // Inserisce tutte le immagini
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error("Errore Google: " + (err.error?.message || "Sconosciuto"));
                }

                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            },

            // Analisi Errori (Editor)
            analyzeErrors: async (text) => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key!");
                
                const prompt = `Sei un correttore per bambini DSA. Analizza e trova errori: "${text}".
                Rispondi SOLO JSON array: [{"original": "err", "type": "ORT", "correction": "corr", "explanation": "..."}]`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                if (!response.ok) throw new Error("Errore analisi errori");
                const data = await response.json();
                let result = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
                result = result.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(result);
            },

            // Ristrutturazione Testo
            restructureText: async (text) => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key!");
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Riscrivi in italiano corretto e semplice per un bambino: "${text}"` }] }]
                    })
                });
                
                if (!response.ok) throw new Error("Errore riscrittura");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || text;
            }
        };
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: TAVOLA PITAGORICA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const Matrix = ({ highlight, setHighlight }) => {
            const handleCellClick = (r, c) => {
                if (r === 0 || c === 0) {
                    // Click su header
                    if (r === 0 && c > 0) {
                        setHighlight(prev => ({ ...prev, c: prev.c === c ? null : c }));
                    } else if (c === 0 && r > 0) {
                        setHighlight(prev => ({ ...prev, r: prev.r === r ? null : r }));
                    }
                } else if (highlight.r && highlight.c) {
                    // Leggi il risultato
                    const result = highlight.r * highlight.c;
                    const utterance = new SpeechSynthesisUtterance(`${highlight.r} per ${highlight.c} fa ${result}`);
                    utterance.lang = 'it-IT';
                    window.speechSynthesis.speak(utterance);
                }
            };

            const getCellClass = (r, c) => {
                const classes = ['matrix-cell'];
                
                if (r === 0 || c === 0) {
                    classes.push('header');
                    if ((r === 0 && c === highlight.c) || (c === 0 && r === highlight.r)) {
                        classes.push('active');
                    }
                } else if (highlight.r && highlight.c) {
                    if (r === highlight.r && c === highlight.c) {
                        classes.push('result');
                    } else if (r === highlight.r || c === highlight.c) {
                        classes.push('path');
                    } else {
                        classes.push('dimmed');
                    }
                }
                
                return classes.join(' ');
            };

            const getCellContent = (r, c) => {
                if (r === 0 && c === 0) return '√ó';
                if (r === 0) return c;
                if (c === 0) return r;
                return r * c;
            };

            return (
                <div className="matrix-wrapper">
                    <div className="matrix-container">
                        {[...Array(11)].map((_, r) =>
                            [...Array(11)].map((_, c) => (
                                <div
                                    key={`${r}-${c}`}
                                    className={getCellClass(r, c)}
                                    onClick={() => handleCellClick(r, c)}
                                >
                                    {getCellContent(r, c)}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: CALCOLATRICE CON BLOCCHI BASE 10
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const MathTool = () => {
            const [mode, setMode] = useState('calc');
            const [display, setDisplay] = useState('');
            const [highlight, setHighlight] = useState({ r: null, c: null });

            // Calcola risultato senza eval (sicuro)
            const calculate = (n1, op, n2) => {
                const a = parseFloat(n1);
                const b = parseFloat(n2);
                if (isNaN(a) || isNaN(b)) return null;
                
                switch (op) {
                    case '+': return a + b;
                    case '-': return a - b;
                    case '*': return a * b;
                    case '/': return b !== 0 ? a / b : null;
                    default: return null;
                }
            };

            const handleBtn = (val) => {
                if (val === 'C') {
                    setDisplay('');
                } else {
                    setDisplay(prev => prev + val);
                }
            };

            // Renderer Blocchi Base 10
            const Base10Renderer = ({ num, colorLabel }) => {
                if (!num || isNaN(num)) return null;
                const n = Math.min(Math.floor(Math.abs(Number(num))), 999);
                
                const hundreds = Math.floor(n / 100);
                const tens = Math.floor((n % 100) / 10);
                const units = n % 10;

                if (n > 500) {
                    return (
                        <div className="flex flex-col items-start gap-2 p-3 rounded-lg bg-slate-800/50 border border-slate-700 w-full mb-2">
                            <div className="text-xs text-slate-400 font-bold uppercase">{colorLabel} ({n})</div>
                            <div className="text-yellow-400 text-sm">Numero troppo grande per i blocchi visivi</div>
                        </div>
                    );
                }

                return (
                    <div className="flex flex-col items-start gap-2 p-3 rounded-lg bg-slate-800/50 border border-slate-700 w-full mb-2 animate-fade-in">
                        <div className="text-xs text-slate-400 font-bold uppercase tracking-wider">{colorLabel} ({n})</div>
                        <div className="holo-container">
                            {/* Centinaia (Viola) */}
                            {[...Array(hundreds)].map((_, i) => (
                                <div key={`h-${i}`} className="hundred-block">
                                    {[...Array(100)].map((_, j) => (
                                        <div key={j} className="hundred-segment"></div>
                                    ))}
                                </div>
                            ))}
                            {/* Decine (Blu) */}
                            {[...Array(tens)].map((_, i) => (
                                <div key={`t-${i}`} className="ten-block">
                                    {[...Array(10)].map((_, j) => (
                                        <div key={j} className="ten-segment"></div>
                                    ))}
                                </div>
                            ))}
                            {/* Unit√† (Verdi) */}
                            <div className="flex flex-wrap gap-1" style={{ minWidth: '20px' }}>
                                {[...Array(units)].map((_, i) => (
                                    <div key={`u-${i}`} className="unit-block"></div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // Visualizzazione in tempo reale
            const renderVisuals = () => {
                if (!display) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full opacity-30 text-center">
                            <Icons.Brain className="w-16 h-16 mb-4" />
                            <p className="text-lg">Digita un numero...</p>
                            <p className="text-sm text-slate-500 mt-2">I blocchi appariranno qui!</p>
                        </div>
                    );
                }

                // Cerca pattern: numero operatore numero
                const match = display.match(/^(\d+(?:\.\d+)?)([\+\-\*\/])(\d+(?:\.\d+)?)$/);

                if (match) {
                    const [_, n1Str, op, n2Str] = match;
                    const n1 = parseFloat(n1Str);
                    const n2 = parseFloat(n2Str);
                    const result = calculate(n1, op, n2);

                    // Divisione speciale
                    if (op === '/') {
                        if (n2 === 0) {
                            return <div className="text-red-400 text-xl text-center p-4">‚ö†Ô∏è Impossibile dividere per zero!</div>;
                        }
                        
                        const quotient = Math.floor(n1 / n2);
                        const remainder = Math.floor(n1 % n2);

                        return (
                            <div className="flex flex-col w-full animate-fade-in overflow-y-auto pb-20">
                                <div className="text-green-400 font-bold text-sm mb-2">üì¶ HAI {n1} OGGETTI:</div>
                                <Base10Renderer num={n1} colorLabel="Totale" />
                                
                                <div className="text-2xl font-bold text-center text-yellow-400 my-4">
                                    ‚¨áÔ∏è Dividi in gruppi da {n2} ‚¨áÔ∏è
                                </div>
                                
                                <div className="text-green-400 font-bold text-sm mb-2">üìä RISULTATO:</div>
                                <div className="flex flex-wrap gap-4 justify-center mb-4">
                                    {[...Array(Math.min(quotient, 20))].map((_, g) => (
                                        <div key={g} className="flex flex-col items-center gap-1">
                                            <div className="text-xs text-slate-500">Gruppo {g + 1}</div>
                                            <div className="bg-slate-800 p-2 rounded border border-blue-500/50 flex flex-wrap gap-1 justify-center" style={{ minWidth: '40px' }}>
                                                {[...Array(Math.min(Math.floor(n2), 10))].map((_, i) => (
                                                    <div key={i} className="unit-block" style={{ background: '#3b82f6' }}></div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {remainder > 0 && (
                                        <div className="flex flex-col items-center gap-1">
                                            <div className="text-xs text-yellow-500 font-bold">RESTO</div>
                                            <div className="bg-slate-800 p-2 rounded border border-yellow-500 flex flex-wrap gap-1 justify-center">
                                                {[...Array(remainder)].map((_, i) => (
                                                    <div key={i} className="unit-block" style={{ background: '#eab308' }}></div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="mt-4 text-center bg-slate-800 p-4 rounded-xl border border-green-500/50">
                                    <div className="text-3xl text-white font-bold">
                                        {quotient}
                                        {remainder > 0 && (
                                            <span className="text-lg font-normal text-slate-400">
                                                {' '}resto <span className="text-yellow-400 font-bold">{remainder}</span>
                                            </span>
                                        )}
                                    </div>
                                    {result % 1 !== 0 && (
                                        <div className="text-sm text-slate-500 mt-1">
                                            Risultato esatto: {Math.round(result * 100) / 100}
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    }

                    // Altre operazioni (+, -, *)
                    return (
                        <div className="flex flex-col w-full animate-fade-in overflow-y-auto pb-10">
                            <div className="text-green-400 font-bold text-sm mb-1">1Ô∏è‚É£ PRIMO NUMERO:</div>
                            <Base10Renderer num={n1} colorLabel={`Inizio (${n1})`} />
                            
                            <div className="text-4xl font-bold text-center text-yellow-400 my-2">
                                {op === '+' ? '‚ûï' : op === '-' ? '‚ûñ' : '‚úñÔ∏è'}
                            </div>
                            
                            <div className="text-blue-400 font-bold text-sm mb-1">2Ô∏è‚É£ SECONDO NUMERO:</div>
                            <Base10Renderer num={n2} colorLabel={`${op === '+' ? 'Aggiungi' : op === '-' ? 'Togli' : 'Moltiplica'} (${n2})`} />
                            
                            <div className="text-4xl font-bold text-center text-white my-2">=</div>
                            
                            <div className="text-purple-400 font-bold text-sm mb-1">3Ô∏è‚É£ RISULTATO:</div>
                            {result >= 0 ? (
                                <Base10Renderer num={result} colorLabel="Finale" />
                            ) : (
                                <div className="text-red-400 text-center p-4 bg-slate-800 rounded-lg">
                                    Risultato negativo: {result}
                                </div>
                            )}
                            
                            <div className="text-center text-4xl font-bold text-green-400 mt-4 pulse-glow p-4 rounded-xl bg-slate-800">
                                {Math.round(result * 100) / 100}
                            </div>
                        </div>
                    );
                }

                // Solo numero (mentre digita)
                const currentNum = display.replace(/[^\d.]/g, '') || display.match(/\d+(?:\.\d+)?$/)?.[0];
                if (currentNum && !isNaN(parseFloat(currentNum))) {
                    return (
                        <div className="flex flex-col w-full animate-fade-in">
                            <div className="text-green-400 font-bold text-sm mb-2">NUMERO ATTUALE:</div>
                            <Base10Renderer num={currentNum} colorLabel="Quantit√†" />
                        </div>
                    );
                }

                return (
                    <div className="text-center text-slate-400 p-4">
                        Continua a digitare...
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col gap-4 p-4 overflow-hidden">
                    {/* Tab Switcher */}
                    <div className="flex gap-2 shrink-0 h-12">
                        <button
                            onClick={() => setMode('calc')}
                            className={`rounded-xl border-2 flex-1 font-bold transition-all flex items-center justify-center gap-2 ${
                                mode === 'calc'
                                    ? 'bg-slate-800 border-yellow-400 text-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)]'
                                    : 'border-slate-700 text-slate-500 hover:border-slate-500'
                            }`}
                        >
                            <Icons.Calc className="w-5 h-5" /> CALCOLATRICE
                        </button>
                        <button
                            onClick={() => setMode('matrix')}
                            className={`rounded-xl border-2 flex-1 font-bold transition-all flex items-center justify-center gap-2 ${
                                mode === 'matrix'
                                    ? 'bg-slate-800 border-yellow-400 text-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)]'
                                    : 'border-slate-700 text-slate-500 hover:border-slate-500'
                            }`}
                        >
                            <span className="text-lg">√ó</span> TABELLINE
                        </button>
                    </div>

                    <div className="flex-1 bg-slate-950 rounded-xl border-2 border-slate-700 overflow-hidden flex">
                        {mode === 'calc' ? (
                            <div className="flex w-full h-full">
                                {/* Tastierino */}
                                <div className="w-2/5 md:w-1/3 p-3 border-r border-slate-700 flex flex-col gap-2 bg-slate-900/50">
                                    <div className="bg-slate-900 p-3 rounded-xl mb-2 text-right text-2xl md:text-3xl font-mono border border-slate-600 text-yellow-400 h-16 flex items-center justify-end overflow-hidden">
                                        {display || <span className="animate-pulse opacity-50">0</span>}
                                    </div>

                                    <div className="grid grid-cols-4 gap-2 flex-1">
                                        {['7', '8', '9', '/', '4', '5', '6', '*', '1', '2', '3', '-', '0', '.', 'C', '+'].map(b => (
                                            <button
                                                key={b}
                                                onClick={() => handleBtn(b)}
                                                className={`text-xl md:text-2xl font-bold rounded-lg shadow-lg active:scale-95 transition-all ${
                                                    b === 'C'
                                                        ? 'bg-red-600 hover:bg-red-500 text-white border border-red-400'
                                                        : ['/', '*', '-', '+'].includes(b)
                                                        ? 'bg-slate-700 text-yellow-400 border border-slate-600 hover:bg-slate-600'
                                                        : 'bg-slate-800 text-white border border-slate-700 hover:bg-slate-700'
                                                }`}
                                            >
                                                {b === '*' ? '√ó' : b === '/' ? '√∑' : b}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Visualizzazione */}
                                <div className="flex-1 p-4 overflow-y-auto bg-slate-900">
                                    {renderVisuals()}
                                </div>
                            </div>
                        ) : (
                            <Matrix highlight={highlight} setHighlight={setHighlight} />
                        )}
                    </div>

                    {/* Legenda */}
                    {mode === 'calc' && (
                        <div className="flex gap-4 justify-center text-xs text-slate-400 shrink-0 flex-wrap">
                            <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-green-500 rounded"></div> Unit√†
                            </div>
                            <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-blue-500 rounded"></div> Decine
                            </div>
                            <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-purple-500 rounded"></div> Centinaia
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: SMART EDITOR (Correttore Ortografico)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const ReadingTool = () => {
            const [text, setText] = useState('');
            const [analyzedParts, setAnalyzedParts] = useState(null);
            const [loading, setLoading] = useState(false);
            const [activeError, setActiveError] = useState(null);
            const [shakeOption, setShakeOption] = useState(null);
            const [errorsFixed, setErrorsFixed] = useState(0);
            const [totalErrors, setTotalErrors] = useState(0);

            // Funzione per analizzare gli errori con AI
            const analyzeWithAI = async (inputText) => {
                const key = DB.getKey();
                if (!key) throw new Error("Inserisci prima la API Key nelle impostazioni!");

                console.log("ü§ñ [AI] Input testo:", inputText);

                const prompt = `Sei un correttore ortografico per un bambino italiano di 9 anni con dislessia.

ANALIZZA questo testo e trova TUTTI gli errori:
"${inputText}"

REGOLE IMPORTANTI:
1. ORTOGRAFIA (ORT): lettere sbagliate, doppie mancanti/extra, accenti mancanti (√®, √©, √≤, √†, √π, √¨), maiuscole mancanti a inizio frase o nei nomi propri
2. PUNTEGGIATURA (PUN): virgole mancanti, punti mancanti, punti interrogativi/esclamativi mancanti. SE MANCA PUNTEGGIATURA, includi la parola PRIMA nel blocco (es: "mamma pero" se manca virgola dopo mamma)
3. SINTASSI (SIN): parole in ordine sbagliato, verbi coniugati male, accordi sbagliati (il mela, le cane)

Per ogni errore genera 4 OPZIONI: 1 corretta e 3 sbagliate ma plausibili (errori simili che un bambino potrebbe fare).

Rispondi SOLO con un JSON array valido, senza altro testo:
[
  {
    "original": "testo sbagliato",
    "type": "ORT|PUN|SIN",
    "correction": "testo corretto",
    "explanation": "spiegazione semplice per bambino",
    "options": ["opzione1", "opzione2", "opzione3", "opzione4"]
  }
]

Se il testo √® perfetto, rispondi: []

IMPORTANTE: 
- Le options devono SEMPRE contenere la correction come una delle 4 opzioni
- Mescola la posizione della risposta corretta
- Per punteggiatura mancante, includi sempre il contesto (parola prima + correzione)`;

                console.log("ü§ñ [AI] Invio richiesta...");

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3 }
                    })
                });

                console.log("ü§ñ [AI] Status risposta:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("ü§ñ [AI] Errore risposta:", errorText);
                    throw new Error("Errore API: " + response.status);
                }
                
                const data = await response.json();
                console.log("ü§ñ [AI] Risposta completa:", data);
                
                let result = data.candidates?.[0]?.content?.parts?.[0]?.text || '[]';
                console.log("ü§ñ [AI] Testo estratto:", result);
                
                // Pulisci il JSON
                result = result.replace(/```json/g, '').replace(/```/g, '').trim();
                console.log("ü§ñ [AI] Dopo pulizia:", result);
                
                // Trova l'array JSON
                const jsonMatch = result.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    console.log("ü§ñ [AI] JSON trovato:", jsonMatch[0]);
                    const parsed = JSON.parse(jsonMatch[0]);
                    console.log("ü§ñ [AI] Parsed:", parsed);
                    return parsed;
                }
                
                console.log("ü§ñ [AI] Nessun JSON trovato, ritorno array vuoto");
                return [];
            };

            // Costruisci le parti del testo con errori evidenziati
        const buildParts = (originalText, errors) => {
    if (!originalText) return [{ type: 'text', content: '' }];
    if (!errors || errors.length === 0) return [{ type: 'text', content: originalText }];

    const parts = [];
    let remaining = originalText;
    
    // Ordina gli errori per lunghezza decrescente per evitare che errori brevi "mangino" quelli lunghi,
    // oppure mantieni l'ordine posizionale se preferisci. L'importante √® il matching sicuro.
    // Qui usiamo un approccio posizionale sicuro.
    
    let currentIndex = 0;
    
    // Ordina errori in base alla loro posizione nel testo
    const sortedErrors = [...errors]
        .map(err => {
            if (!err.original) return null;
            const index = originalText.toLowerCase().indexOf(err.original.toLowerCase(), 0); // Cerca dall'inizio per ordinare
            return { ...err, tempIndex: index };
        })
        .filter(err => err && err.tempIndex !== -1 && err.original.length > 0) // Rimuove errori non trovati o vuoti
        .sort((a, b) => a.tempIndex - b.tempIndex);

    let lastCursor = 0;

    for (const error of sortedErrors) {
        // Cerca la parola sbagliata PARTENDO dall'ultima posizione trovata (evita loop e sovrapposizioni)
        const lowerRemaining = originalText.toLowerCase();
        const foundIndex = lowerRemaining.indexOf(error.original.toLowerCase(), lastCursor);

        if (foundIndex !== -1) {
            // Aggiungi il testo "buono" prima dell'errore
            if (foundIndex > lastCursor) {
                parts.push({ 
                    type: 'text', 
                    content: originalText.substring(lastCursor, foundIndex) 
                });
            }

            // Aggiungi l'errore
            parts.push({
                type: 'error',
                id: Math.random().toString(36).substr(2, 9),
                original: originalText.substring(foundIndex, foundIndex + error.original.length), // Prende il testo originale con le maiuscole corrette
                errType: (error.type || 'ORT').toUpperCase(),
                correction: error.correction,
                explanation: error.explanation,
                options: error.options && error.options.length >= 2 
                    ? shuffleArray(error.options) 
                    : shuffleArray([error.correction, error.original, error.original + '?', error.original + '!'])
            });

            // Sposta il cursore in avanti
            lastCursor = foundIndex + error.original.length;
        }
    }

    // Aggiungi l'eventuale testo rimanente alla fine
    if (lastCursor < originalText.length) {
        parts.push({ type: 'text', content: originalText.substring(lastCursor) });
    }

    return parts;
};

            // Mescola array (Fisher-Yates)
            const shuffleArray = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            const handleRestructure = async () => {
                if (!text.trim()) return;
                setLoading(true);
                try {
                    const result = await GeminiService.restructureText(text);
                    setText(result);
                    DB.addXP(10);
                } catch (e) {
                    alert(e.message);
                }
                setLoading(false);
            };

            const handleAnalyze = async () => {
                if (!text.trim()) {
                    alert("Scrivi qualcosa prima di controllare!");
                    return;
                }
                
                setLoading(true);
                setErrorsFixed(0);

                // IMPORTANTE: Salva il testo PRIMA di tutto
                const savedText = text;
                console.log("üìù [CONTROLLA] Testo salvato:", savedText);

                try {
                    console.log("üîç [CONTROLLA] Chiamo API AI...");
                    
                    let errors = [];
                    try {
                        errors = await analyzeWithAI(savedText);
                    } catch (apiError) {
                        console.error("‚ùå [CONTROLLA] Errore API:", apiError);
                        alert("Errore connessione AI: " + apiError.message);
                        setLoading(false);
                        return; // Esci senza toccare il testo
                    }
                    
                    console.log("üìä [CONTROLLA] Risposta AI:", JSON.stringify(errors, null, 2));
                    
                    // Nessun errore trovato
                    if (!errors || !Array.isArray(errors) || errors.length === 0) {
                        alert("üéâ Perfetto! Non ho trovato errori!");
                        setLoading(false);
                        return; // Esci senza toccare il testo
                    }

                    // Costruisci le parti
                    console.log("üîß [CONTROLLA] Costruisco parti...");
                    let parts = [];
                    try {
                        parts = buildParts(savedText, errors);
                    } catch (buildError) {
                        console.error("‚ùå [CONTROLLA] Errore buildParts:", buildError);
                        alert("Errore elaborazione. Riprova.");
                        setLoading(false);
                        return;
                    }
                    
                    console.log("üì¶ [CONTROLLA] Parti create:", parts.length);
                    
                    // Verifica parti valide
                    if (!parts || parts.length === 0) {
                        console.error("‚ùå [CONTROLLA] Parti vuote!");
                        alert("Errore: nessuna parte creata. Riprova.");
                        setLoading(false);
                        return;
                    }

                    // Verifica che il contenuto totale non sia vuoto
                    const totalContent = parts.map(p => p.original || p.content || '').join('');
                    console.log("üìè [CONTROLLA] Contenuto totale:", totalContent.length, "caratteri");
                    
                    if (totalContent.trim().length === 0) {
                        console.error("‚ùå [CONTROLLA] Contenuto vuoto dopo elaborazione!");
                        alert("Errore elaborazione testo. Riprova.");
                        setLoading(false);
                        return;
                    }

                    const errorCount = parts.filter(p => p.type === 'error').length;
                    console.log("‚úÖ [CONTROLLA] Successo! Errori:", errorCount);
                    
                    setAnalyzedParts(parts);
                    setTotalErrors(errorCount);
                    DB.addXP(10);
                    
                } catch (e) {
                    console.error("‚ùå [CONTROLLA] Errore generale:", e);
                    alert("Errore imprevisto: " + e.message);
                }
                
                setLoading(false);
            };

            const handleOptionSelect = (partIndex, selectedOption) => {
                const part = analyzedParts[partIndex];
                
                // Verifica se la scelta √® corretta
                const isCorrect = selectedOption.trim().toLowerCase() === part.correction.trim().toLowerCase();

                if (isCorrect) {
                    // Risposta corretta!
                    const newParts = [...analyzedParts];
                    newParts[partIndex] = { 
                        type: 'fixed', 
                        content: part.correction,
                        wasError: part.errType
                    };
                    setAnalyzedParts(newParts);
                    setActiveError(null);
                    setErrorsFixed(prev => prev + 1);
                    DB.addXP(25);

                    // Feedback vocale
                    const utterance = new SpeechSynthesisUtterance("Giusto!");
                    utterance.lang = 'it-IT';
                    utterance.rate = 1.2;
                    window.speechSynthesis.speak(utterance);
                } else {
                    // Risposta sbagliata - shake
                    setShakeOption(selectedOption);
                    setTimeout(() => setShakeOption(null), 500);

                    // Feedback vocale
                    const utterance = new SpeechSynthesisUtterance("Riprova!");
                    utterance.lang = 'it-IT';
                    utterance.rate = 1.2;
                    window.speechSynthesis.speak(utterance);
                }
            };

            const handleReset = () => {
                const fullText = analyzedParts
                    .map(p => {
                        if (p.type === 'error') return p.original;
                        if (p.type === 'fixed') return p.content;
                        return p.content;
                    })
                    .join('');
                setText(fullText);
                setAnalyzedParts(null);
                setActiveError(null);
                setErrorsFixed(0);
                setTotalErrors(0);
            };

            const speakText = () => {
                window.speechSynthesis.cancel();
                const textToSpeak = analyzedParts
                    ? analyzedParts.map(p => (p.type === 'error' ? p.original : p.content)).join('')
                    : text;
                if (!textToSpeak) return;
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'it-IT';
                utterance.rate = 0.85;
                window.speechSynthesis.speak(utterance);
            };

            // Conta errori rimanenti
            const remainingErrors = analyzedParts 
                ? analyzedParts.filter(p => p.type === 'error').length 
                : 0;

            return (
                <div className="h-full flex flex-col p-4 gap-4 max-w-4xl mx-auto w-full overflow-hidden relative">
                    {/* Toolbar */}
                    <div className="flex gap-2 shrink-0 h-14">
                        {!analyzedParts ? (
                            <>
                                <button
                                    onClick={handleRestructure}
                                    disabled={loading}
                                    className="flex-1 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 text-white rounded-xl font-bold flex items-center justify-center gap-2 text-sm transition-all"
                                >
                                    <Icons.Magic className="w-5 h-5" />
                                    {loading ? 'Elaboro...' : 'RISCRIVI'}
                                </button>
                                <button
                                    onClick={handleAnalyze}
                                    disabled={loading}
                                    className="flex-1 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white rounded-xl font-bold flex items-center justify-center gap-2 text-sm transition-all"
                                >
                                    <Icons.Check className="w-5 h-5" />
                                    {loading ? 'Controllo...' : 'CONTROLLA'}
                                </button>
                            </>
                        ) : (
                            <button
                                onClick={handleReset}
                                className="flex-1 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all"
                            >
                                <Icons.Book className="w-5 h-5" /> MODIFICA TESTO
                            </button>
                        )}
                        <button
                            onClick={speakText}
                            className="w-16 bg-green-600 hover:bg-green-500 text-white rounded-xl flex items-center justify-center transition-all"
                        >
                            <Icons.Volume className="w-6 h-6" />
                        </button>
                    </div>

                    {/* Barra progresso errori */}
                    {analyzedParts && totalErrors > 0 && (
                        <div className="bg-slate-800 rounded-xl p-3 border border-slate-600">
                            <div className="flex justify-between text-sm mb-2">
                                <span className="text-slate-400">Errori corretti:</span>
                                <span className="text-green-400 font-bold">{errorsFixed} / {totalErrors}</span>
                            </div>
                            <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-500"
                                    style={{ width: `${(errorsFixed / totalErrors) * 100}%` }}
                                ></div>
                            </div>
                            {remainingErrors === 0 && (
                                <div className="text-center text-green-400 font-bold mt-2 animate-pulse">
                                    üéâ TUTTI GLI ERRORI CORRETTI! +{errorsFixed * 25} XP
                                </div>
                            )}
                        </div>
                    )}

                    {/* Area testo */}
                    <div
                        className="flex-1 bg-slate-800 rounded-xl border-2 border-slate-600 p-6 text-lg leading-relaxed overflow-y-auto relative"
                        onClick={() => setActiveError(null)}
                    >
                        {!analyzedParts ? (
                            <textarea
                                value={text}
                                onChange={(e) => setText(e.target.value)}
                                placeholder="Scrivi qui o usa il microfono üé§ della tastiera per dettare..."
                                className="w-full h-full bg-transparent resize-none outline-none text-slate-200 placeholder-slate-500 text-xl leading-relaxed"
                                style={{ lineHeight: '2' }}
                            />
                        ) : (
                            <div className="text-slate-200 text-xl" style={{ lineHeight: '2.2' }}>
                                {analyzedParts.map((p, i) => {
                                    // Testo normale
                                    if (p.type === 'text') {
                                        return <span key={i}>{p.content}</span>;
                                    }
                                    
                                    // Errore gi√† corretto
                                    if (p.type === 'fixed') {
                                        return (
                                            <span 
                                                key={i} 
                                                className="bg-green-500/20 text-green-300 px-1 rounded border-b-2 border-green-500"
                                            >
                                                {p.content}
                                            </span>
                                        );
                                    }

                                    // Errore da correggere
                                    return (
                                        <span
                                            key={i}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setActiveError(activeError === i ? null : i);
                                            }}
                                            className={`err-span err-${p.errType} rounded-md px-1 cursor-pointer ${activeError === i ? 'ring-2 ring-white' : ''}`}
                                        >
                                            {p.original}
                                            
                                            {/* Popup con opzioni */}
                                            {activeError === i && (
                                                <div 
                                                    className="correction-popup"
                                                    onClick={(e) => e.stopPropagation()}
                                                    style={{ width: '280px' }}
                                                >
                                                    {/* Header tipo errore */}
                                                    <div className={`font-bold mb-2 text-sm px-2 py-1 rounded ${
                                                        p.errType === 'ORT' ? 'bg-red-500/20 text-red-400' :
                                                        p.errType === 'PUN' ? 'bg-yellow-500/20 text-yellow-400' :
                                                        'bg-blue-500/20 text-blue-400'
                                                    }`}>
                                                        {p.errType === 'ORT' ? '‚úèÔ∏è ORTOGRAFIA' : 
                                                         p.errType === 'PUN' ? 'üìù PUNTEGGIATURA' : 
                                                         'üìñ SINTASSI'}
                                                    </div>
                                                    
                                                    {/* Spiegazione */}
                                                    <div className="text-slate-300 text-sm mb-3 px-1">
                                                        {p.explanation}
                                                    </div>
                                                    
                                                    {/* Opzioni */}
                                                    <div className="text-xs text-slate-400 mb-2">Scegli la forma corretta:</div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {p.options.map((opt, optIdx) => (
                                                            <button
                                                                key={optIdx}
                                                                onClick={() => handleOptionSelect(i, opt)}
                                                                className={`p-3 rounded-lg font-bold text-sm transition-all ${
                                                                    shakeOption === opt 
                                                                        ? 'bg-red-600 shake' 
                                                                        : 'bg-slate-700 hover:bg-slate-600 hover:scale-105'
                                                                } text-white border border-slate-500`}
                                                            >
                                                                {opt}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </span>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Legenda errori */}
                    {analyzedParts && (
                        <div className="flex gap-4 justify-center text-xs text-slate-400 shrink-0 flex-wrap">
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-red-500/30 border-2 border-red-500 rounded"></div> 
                                <span>Ortografia</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-yellow-500/30 border-2 border-yellow-500 rounded"></div> 
                                <span>Punteggiatura</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-blue-500/30 border-2 border-blue-500 rounded"></div> 
                                <span>Sintassi</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 bg-green-500/30 border-2 border-green-500 rounded"></div> 
                                <span>Corretto ‚úì</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: LAVAGNA AI (Mappe Mentali - Versione Multi-Pagina)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CyberBoard = () => {
            const [stage, setStage] = useState('upload');
            const [images, setImages] = useState([]); // Ora gestisce un array di immagini!
            const [data, setData] = useState(null);
            const [nodes, setNodes] = useState([]);
            const [lines, setLines] = useState([]);
            const [dragging, setDragging] = useState(null);

            // Carica salvataggio precedente
            useEffect(() => {
                const saved = DB.loadMap();
                if (saved.nodes.length > 0) {
                    setNodes(saved.nodes);
                    setLines(saved.lines);
                    setData({ summary: saved.summary });
                    setStage('playing');
                }
            }, []);

            // Gestisce l'upload di una singola immagine e la aggiunge alla lista
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    setImages(prev => [...prev, evt.target.result]);
                };
                reader.readAsDataURL(file);
            };

            // Lancia l'analisi su TUTTE le immagini caricate
            const startAnalysis = async () => {
                if (images.length === 0) return;
                setStage('scanning');

                try {
                    const aiData = await GeminiService.analyzeToMap(images);
                    setData(aiData);

                    // Calcolo posizioni nodi (a cerchio)
                    const cx = window.innerWidth / 2;
                    const cy = window.innerHeight / 2.5;
                    const radius = Math.min(cx, cy) / 1.8;

                    const newNodes = aiData.nodes.map((n, i) => ({
                        ...n,
                        x: cx + radius * Math.cos((i / aiData.nodes.length) * 2 * Math.PI - Math.PI / 2) - 75,
                        y: cy + radius * Math.sin((i / aiData.nodes.length) * 2 * Math.PI - Math.PI / 2) - 40,
                        w: 150,
                        h: 80
                    }));

                    const newLines = (aiData.connections || []).map(conn => {
                        const from = newNodes.find(n => n.id === conn.from);
                        const to = newNodes.find(n => n.id === conn.to);
                        if (from && to) {
                            return {
                                x1: from.x + 75, y1: from.y + 40,
                                x2: to.x + 75, y2: to.y + 40,
                                from: conn.from, to: conn.to
                            };
                        }
                        return null;
                    }).filter(Boolean);

                    setNodes(newNodes);
                    setLines(newLines);
                    DB.saveMap(newNodes, newLines, aiData.summary);
                    DB.addXP(30);
                    setStage('playing');
                } catch (e) {
                    alert("Errore AI: " + e.message);
                    setStage('upload');
                }
            };

            const handleNodeClick = (node) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(node.explanation || node.label);
                utterance.lang = 'it-IT';
                window.speechSynthesis.speak(utterance);
            };

            const handleReset = () => {
                setStage('upload');
                DB.clearMap();
                setNodes([]);
                setLines([]);
                setData(null);
                setImages([]); // Pulisce le immagini
            };

            // --- FASE 1: CARICAMENTO (Carrello Immagini) ---
            if (stage === 'upload') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-6 text-center overflow-y-auto">
                        <div className="border-2 border-dashed border-slate-600 rounded-3xl p-8 flex flex-col items-center gap-6 bg-slate-800/30 max-w-2xl w-full">
                            
                            <div>
                                <h2 className="text-2xl font-bold text-slate-200">CARICA PAGINE LIBRO</h2>
                                <p className="text-slate-400 text-sm mt-1">
                                    Fai le foto a tutte le pagine del paragrafo (anche i riquadri!).
                                </p>
                            </div>

                            {/* Anteprima Immagini Caricate */}
                            {images.length > 0 && (
                                <div className="flex gap-2 overflow-x-auto w-full p-2 bg-slate-900/50 rounded-xl border border-slate-700 min-h-[100px] items-center">
                                    {images.map((img, idx) => (
                                        <div key={idx} className="relative shrink-0 group">
                                            <img src={img} className="h-20 w-auto rounded border border-slate-500" />
                                            <div className="absolute -top-2 -right-2 bg-green-500 text-black text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
                                                {idx + 1}
                                            </div>
                                        </div>
                                    ))}
                                    <div className="text-slate-500 text-xs px-2">
                                        {images.length} pagine
                                    </div>
                                </div>
                            )}

                            {/* Pulsanti Azione */}
                            <div className="flex gap-4 flex-wrap justify-center">
                                <label className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-xl cursor-pointer shadow-lg transition-all border border-slate-500 flex items-center gap-2">
                                    <input type="file" onChange={handleImageUpload} className="hidden" accept="image/*" />
                                    <Icons.Upload className="w-5 h-5" />
                                    AGGIUNGI FOTO
                                </label>

                                {images.length > 0 && (
                                    <button 
                                        onClick={startAnalysis}
                                        className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-xl shadow-[0_0_15px_rgba(74,222,128,0.5)] transition-all animate-pulse flex items-center gap-2"
                                    >
                                        <Icons.Brain className="w-5 h-5" />
                                        GENERA MAPPA
                                    </button>
                                )}
                            </div>
                            
                            {images.length > 0 && (
                                <button onClick={() => setImages([])} className="text-xs text-red-400 underline hover:text-red-300">
                                    Cancella tutto e ricomincia
                                </button>
                            )}

                            {nodes.length > 0 && images.length === 0 && (
                                <button onClick={() => setStage('playing')} className="mt-4 text-sm text-green-400 underline">
                                    Torna all'ultima mappa salvata
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // --- FASE 2: ANALISI IN CORSO ---
            if (stage === 'scanning') {
                return (
                    <div className="h-full flex flex-col items-center justify-center gap-4">
                        <div className="w-16 h-16 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                        <h2 className="text-green-400 font-bold text-2xl">ANALISI AI IN CORSO...</h2>
                        <p className="text-slate-400">Sto leggendo {images.length} pagine...</p>
                    </div>
                );
            }

            // --- FASE 3: VISUALIZZAZIONE MAPPA ---
            return (
                <div className="h-full relative bg-slate-950 overflow-hidden">
                    {/* Sfondo sfocato della prima immagine */}
                    {images.length > 0 && (
                        <div
                            className="absolute inset-0 opacity-10 pointer-events-none"
                            style={{ backgroundImage: `url(${images[0]})`, backgroundSize: 'cover', backgroundPosition: 'center' }}
                        />
                    )}

                    <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                        {lines.map((l, i) => (
                            <line key={i} x1={l.x1} y1={l.y1} x2={l.x2} y2={l.y2} stroke="#4ade80" strokeWidth="3" strokeOpacity="0.6" />
                        ))}
                    </svg>

                    {nodes.map(n => (
                        <div
                            key={n.id}
                            className="absolute flex items-center justify-center p-3 text-xs font-bold text-white rounded-xl cyber-box z-10 cursor-pointer hover:border-green-400 transition-all text-center"
                            style={{ left: n.x, top: n.y, width: n.w, height: n.h }}
                            onClick={() => handleNodeClick(n)}
                        >
                            {n.label}
                        </div>
                    ))}

                    <div className="absolute bottom-4 left-4 right-4 bg-slate-800/95 border border-slate-600 rounded-xl p-4 max-h-32 overflow-y-auto z-20">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-green-400 font-bold text-sm">üìù RIASSUNTO</span>
                            <button onClick={handleReset} className="text-xs text-red-400 border border-red-900 px-3 py-1 rounded hover:bg-red-900/30 transition-all">
                                RESET
                            </button>
                        </div>
                        <p className="text-slate-300 text-sm">{data?.summary}</p>
                    </div>

                    <div className="absolute top-4 left-4 bg-slate-800/80 px-3 py-2 rounded-lg text-xs text-slate-400">
                        üí° Tocca un nodo per ascoltare
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: TUTOR AI (Chat)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const CyberTutor = () => {
            const [messages, setMessages] = useState([
                { role: 'model', text: 'Ciao! üëã Sono il tuo Tutor AI. Dimmi cosa stai studiando e ti aiuter√≤ a capire tutto!' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const endRef = useRef(null);

            useEffect(() => {
                endRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || loading) return;

                const userMessage = input.trim();
                const newHistory = [...messages, { role: 'user', text: userMessage }];
                setMessages(newHistory);
                setInput('');
                setLoading(true);

                try {
                    const systemPrompt = "Sei un tutor gentile e paziente per un bambino di 9 anni con DSA. Usa frasi semplici, esempi concreti e incoraggiamento. Rispondi sempre in italiano.";
                    const response = await GeminiService.chat(
                        [{ role: 'model', text: systemPrompt }, ...messages],
                        userMessage
                    );
                    setMessages([...newHistory, { role: 'model', text: response }]);
                    DB.addXP(5);
                } catch (e) {
                    setMessages([...newHistory, { role: 'model', text: '‚ùå ' + e.message }]);
                }
                setLoading(false);
            };

            return (
                <div className="h-full flex flex-col bg-slate-900">
                    {/* Chat messages */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((m, i) => (
                            <div
                                key={i}
                                className={`p-4 max-w-[85%] text-sm rounded-xl animate-fade-in ${
                                    m.role === 'user' ? 'msg-user' : 'msg-ai'
                                }`}
                            >
                                <div className="font-bold text-xs mb-1 opacity-70">
                                    {m.role === 'user' ? 'üë§ TU' : 'ü§ñ TUTOR'}
                                </div>
                                {m.text}
                            </div>
                        ))}
                        {loading && (
                            <div className="msg-ai p-4 max-w-[85%] text-sm rounded-xl">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                </div>
                            </div>
                        )}
                        <div ref={endRef}></div>
                    </div>

                    {/* Input */}
                    <div className="p-3 bg-slate-800 flex gap-2 shrink-0 border-t border-slate-700">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                            className="flex-1 bg-slate-900 border border-slate-600 rounded-xl p-3 text-white placeholder-slate-500 outline-none focus:border-purple-500 transition-all"
                            placeholder="Scrivi la tua domanda..."
                        />
                        <button
                            onClick={sendMessage}
                            disabled={loading}
                            className="bg-purple-600 hover:bg-purple-500 disabled:opacity-50 text-white p-3 rounded-xl font-bold transition-all flex items-center justify-center w-14"
                        >
                            <Icons.Send className="w-5 h-5" />
                        </button>
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: IMPOSTAZIONI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const SettingsScreen = ({ onClose }) => {
            const [key, setKey] = useState(DB.getKey());
            const [saved, setSaved] = useState(false);

            const saveKey = () => {
                DB.setKey(key);
                setSaved(true);
                setTimeout(() => {
                    setSaved(false);
                    onClose();
                }, 1000);
            };

            return (
                <div className="h-full w-full flex flex-col items-center justify-center p-4 bg-slate-900/95 absolute inset-0 z-50">
                    <div className="bg-slate-800 p-8 rounded-2xl border border-slate-600 max-w-md w-full text-center shadow-2xl animate-fade-in">
                        <h2 className="text-2xl font-bold mb-2 text-purple-400">‚öôÔ∏è CONFIGURAZIONE</h2>
                        <p className="text-slate-400 text-sm mb-6">Inserisci la tua chiave API di Google AI Studio</p>

                        <input
                            type="password"
                            value={key}
                            onChange={(e) => setKey(e.target.value)}
                            placeholder="Incolla qui la API Key..."
                            className="w-full bg-slate-900 border border-slate-600 p-4 rounded-xl mb-4 text-white placeholder-slate-500 outline-none focus:border-purple-500 transition-all"
                        />

                        <button
                            onClick={saveKey}
                            className={`w-full p-4 rounded-xl font-bold text-white transition-all ${
                                saved
                                    ? 'bg-green-600'
                                    : 'bg-purple-600 hover:bg-purple-500'
                            }`}
                        >
                            {saved ? '‚úì SALVATO!' : 'SALVA CHIAVE'}
                        </button>

                        <button
                            onClick={onClose}
                            className="mt-4 text-slate-400 text-sm underline"
                        >
                            Chiudi
                        </button>

                        <div className="mt-6 p-4 bg-slate-900 rounded-xl text-left">
                            <p className="text-xs text-slate-500">
                                üìå Ottieni la chiave gratis su:<br />
                                <a
                                    href="https://aistudio.google.com/apikey"
                                    target="_blank"
                                    className="text-purple-400 underline"
                                >
                                    aistudio.google.com/apikey
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE: HOME MENU
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const HomeMenu = ({ setActiveTab }) => {
            const cards = [
                {
                    id: 'math',
                    title: 'CYBER MATRIX',
                    icon: Icons.Calc,
                    desc: 'Calcoli visuali e Tabelline',
                    color: 'border-yellow-500 text-yellow-400',
                    bg: 'from-yellow-900/20 to-transparent'
                },
                {
                    id: 'board',
                    title: 'LAVAGNA AI',
                    icon: Icons.Brain,
                    desc: 'Mappe mentali da immagini',
                    color: 'border-green-500 text-green-400',
                    bg: 'from-green-900/20 to-transparent'
                },
                {
                    id: 'reader',
                    title: 'SMART EDITOR',
                    icon: Icons.Book,
                    desc: 'Correttore e Ghostwriter',
                    color: 'border-blue-500 text-blue-400',
                    bg: 'from-blue-900/20 to-transparent'
                },
                {
                    id: 'tutor',
                    title: 'TUTOR AI',
                    icon: Icons.Chat,
                    desc: 'Chat con il Copilota',
                    color: 'border-purple-500 text-purple-400',
                    bg: 'from-purple-900/20 to-transparent'
                }
            ];

            return (
                <div className="h-full w-full overflow-y-auto p-6 flex flex-col items-center justify-center">
                    <div className="mb-8 text-center">
                        <h1 className="text-4xl md:text-5xl font-black text-white mb-2">
                            üéÆ EDUGAMER
                        </h1>
                        <p className="text-slate-400">Seleziona un modulo per iniziare</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl">
                        {cards.map(card => (
                            <button
                                key={card.id}
                                onClick={() => setActiveTab(card.id)}
                                className={`cyber-card p-6 min-h-[140px] rounded-2xl flex flex-col items-center justify-center gap-3 text-center group ${card.color} border-2 bg-gradient-to-br ${card.bg} hover:scale-[1.02] transition-all`}
                            >
                                <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <card.icon className="w-6 h-6" />
                                </div>
                                <h2 className="text-xl font-bold">{card.title}</h2>
                                <p className="text-slate-400 text-sm">{card.desc}</p>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // APP PRINCIPALE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const EduGamer = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [showSettings, setShowSettings] = useState(false);
            const [xp, setXP] = useState(DB.getXP());
            const [level, setLevel] = useState(DB.getLevel());

            useEffect(() => {
                const handleXPChange = () => {
                    setXP(DB.getXP());
                    setLevel(DB.getLevel());
                };
                window.addEventListener('xpChanged', handleXPChange);
                return () => window.removeEventListener('xpChanged', handleXPChange);
            }, []);

            const Content = () => {
                if (showSettings) return <SettingsScreen onClose={() => setShowSettings(false)} />;
                switch (activeTab) {
                    case 'math': return <MathTool />;
                    case 'board': return <CyberBoard />;
                    case 'reader': return <ReadingTool />;
                    case 'tutor': return <CyberTutor />;
                    default: return <HomeMenu setActiveTab={setActiveTab} />;
                }
            };

            return (
                <div className="h-full flex flex-col font-mono selection:bg-green-900 selection:text-white overflow-hidden">
                    {/* Header */}
                    <header className="h-16 px-4 border-b border-slate-700 flex justify-between items-center bg-slate-950 shrink-0 z-50">
                        <div className="flex items-center gap-4">
                            <div
                                className="text-xl md:text-2xl font-bold tracking-tighter flex items-center gap-2 cursor-pointer text-green-400 hover:text-green-300 transition-colors"
                                onClick={() => setActiveTab('home')}
                            >
                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                EDUGAMER
                            </div>

                            {/* XP Bar */}
                            <div className="hidden md:flex flex-col w-32 md:w-48">
                                <div className="flex justify-between text-xs text-yellow-400 font-bold mb-1">
                                    <span>LVL {level}</span>
                                    <span>{xp} XP</span>
                                </div>
                                <div className="h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-600">
                                    <div
                                        className="h-full xp-bar-fill transition-all duration-500"
                                        style={{ width: `${Math.min(100, (xp % 100))}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-2">
                            {activeTab !== 'home' && !showSettings && (
                                <button
                                    onClick={() => setActiveTab('home')}
                                    className="px-4 py-2 rounded-lg border border-slate-600 hover:bg-slate-800 text-sm flex items-center gap-2 transition-all"
                                >
                                    <Icons.Home className="w-4 h-4" />
                                    <span className="hidden md:inline">BASE</span>
                                </button>
                            )}
                            <button
                                onClick={() => setShowSettings(!showSettings)}
                                className="p-2 rounded-lg border border-slate-600 hover:bg-slate-800 transition-all"
                            >
                                <Icons.Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 overflow-hidden relative bg-slate-900">
                        <Content />
                    </main>
                </div>
            );
        };

        // Mount App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EduGamer />);
    </script>
</body>
</html>