<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematica - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0a0e17; color: white; font-family: 'Verdana', sans-serif; height: 100dvh; overflow: hidden; }
        .btn-calc { font-size: 1.5rem; font-weight: bold; border-radius: 12px; transition: 0.1s; }
        .btn-calc:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;
        const MODEL = "gemini-2.0-flash";

        const solveProblem = async (img) => {
            const key = localStorage.getItem('gemini_api_key');
            if(!key) throw new Error("Manca API Key!");
            
            const prompt = "Risolvi questo problema di matematica passo dopo passo per un bambino delle elementari. Usa emoji. Spiega le formule.";
            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }] }] };
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        const App = () => {
            const [mode, setMode] = useState('calc'); // calc, matrix, solver
            const [display, setDisplay] = useState('');
            const [solverImg, setSolverImg] = useState(null);
            const [solution, setSolution] = useState(null);
            const [loading, setLoading] = useState(false);

            // --- CALCOLATRICE ---
            const handleBtn = (v) => {
                if(v === 'C') setDisplay('');
                else if(v === '=') {
                    try { setDisplay(eval(display).toString()); } catch { setDisplay('Error'); }
                } else setDisplay(p => p + v);
            };

            // --- RISOLUTORE ---
            const handleUpload = (e) => {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (evt) => setSolverImg(evt.target.result);
                r.readAsDataURL(f);
                setSolution(null);
            };
            
            const runSolver = async () => {
                if(!solverImg) return;
                setLoading(true);
                try {
                    const text = await solveProblem(solverImg);
                    setSolution(text);
                } catch(e) { alert("Errore: " + e.message); }
                setLoading(false);
            };

            return (
                <div className="h-full flex flex-col p-4 gap-4">
                    {/* Header Nav */}
                    <div className="flex gap-2 shrink-0">
                        <a href="index.html" className="bg-slate-700 text-white p-3 rounded-xl font-bold">üè†</a>
                        <button onClick={()=>setMode('calc')} className={`flex-1 rounded-xl font-bold ${mode==='calc'?'bg-blue-600':'bg-slate-800'}`}>CALCOLA</button>
                        <button onClick={()=>setMode('solver')} className={`flex-1 rounded-xl font-bold ${mode==='solver'?'bg-green-600':'bg-slate-800'}`}>RISOLVI</button>
                    </div>

                    {/* CONTENT */}
                    <div className="flex-1 bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden p-4">
                        {mode === 'calc' && (
                            <div className="h-full flex flex-col">
                                <div className="bg-slate-950 p-4 rounded-xl text-right text-4xl font-mono mb-4 text-yellow-400 border border-slate-700 h-24 flex items-center justify-end">
                                    {display || '0'}
                                </div>
                                <div className="grid grid-cols-4 gap-3 flex-1">
                                    {['7','8','9','/','4','5','6','*','1','2','3','-','C','0','.','+','='].map(b => (
                                        <button key={b} onClick={() => handleBtn(b)} 
                                            className={`btn-calc ${b==='='?'col-span-2 bg-green-600':b==='C'?'bg-red-600':'bg-slate-700'}`}>
                                            {b}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {mode === 'solver' && (
                            <div className="h-full flex flex-col items-center overflow-y-auto">
                                {!solverImg ? (
                                    <div className="flex flex-col items-center justify-center h-full gap-6">
                                        <div className="text-6xl">üìê</div>
                                        <label className="bg-blue-600 px-8 py-4 rounded-xl font-bold text-xl cursor-pointer">
                                            <input type="file" onChange={handleUpload} className="hidden" capture="environment" />
                                            üì∑ FOTO PROBLEMA
                                        </label>
                                    </div>
                                ) : (
                                    <div className="w-full max-w-2xl flex flex-col gap-4">
                                        <div className="flex gap-4 items-center">
                                            <img src={solverImg} className="h-32 rounded border" />
                                            <button onClick={runSolver} disabled={loading} className="bg-green-600 px-6 py-3 rounded-xl font-bold flex-1">
                                                {loading ? 'RAGIONO...' : 'RISOLVI ORA üöÄ'}
                                            </button>
                                            <button onClick={()=>setSolverImg(null)} className="bg-red-600 px-4 py-3 rounded-xl">üóëÔ∏è</button>
                                        </div>
                                        {solution && (
                                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-600 prose prose-invert" 
                                                 dangerouslySetInnerHTML={{__html: marked.parse(solution)}}>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>