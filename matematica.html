<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematica DSA - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">

    <style>
        * { letter-spacing: 0.02em; }

        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body { 
            background-color: #0a0e17; 
            color: white; 
            font-family: 'OpenDyslexic', Verdana, sans-serif;
        }
        
        /* BLOCCHI VISIVI CON MIGLIAIA */
        .holo-container {
            display: flex; flex-direction: row; flex-wrap: wrap; gap: 8px;
            align-items: center; padding: 10px; background: rgba(0, 0, 0, 0.2);
            border-radius: 10px; border: 1px dashed #475569; 
            width: 100%; min-height: 50px;
        }
        
        /* UNIT√Ä (verde) */
        .unit-block { 
            width: 16px; height: 16px; 
            background: #4ade80; 
            border: 1px solid #166534; 
            border-radius: 3px; 
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(74, 222, 128, 0.3);
        }
        
        /* DECINE (blu) */
        .ten-block { 
            display: flex; flex-direction: row; 
            border: 2px solid #1e3a8a; 
            border-radius: 4px; 
            overflow: hidden; 
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }
        .ten-segment { 
            width: 12px; height: 16px; 
            background: #3b82f6; 
            border-right: 1px solid #1e3a8a; 
        }
        .ten-segment:last-child { border-right: none; }

        /* CENTINAIA (viola) */
        .hundred-block { 
            display: grid; 
            grid-template-columns: repeat(10, 1fr); 
            width: 80px; 
            border: 2px solid #a855f7; 
            border-radius: 4px; 
            flex-shrink: 0; 
            background: #581c87;
            box-shadow: 0 3px 8px rgba(168, 85, 247, 0.5);
        }
        .hundred-segment { 
            width: 100%; 
            height: 8px; 
            border: 0.5px solid rgba(168, 85, 247, 0.3); 
        }

        /* MIGLIAIA (arancione) - NUOVO! */
        .thousand-block {
            position: relative;
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border: 3px solid #c2410c;
            border-radius: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.6);
        }
        .thousand-block::before {
            content: '1000';
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .group-section { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 6px; 
            align-items: center; 
            padding-right: 8px; 
            border-right: 2px solid #334155; 
            margin-right: 6px; 
        }
        .group-section:last-child { border-right: none; }

        /* Legenda blocchi */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* TASTIERA COMPATTA */
        .btn-calc { 
            font-size: 1.2rem; 
            font-weight: bold; 
            border-radius: 10px; 
            transition: 0.1s; 
            box-shadow: 0 2px 0 #1e293b; 
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-calc:active { 
            transform: translateY(2px); 
            box-shadow: none; 
        }

        /* TABELLINA GAMER STYLE */
        .table-cell {
            transition: all 0.2s ease;
        }
        
        .table-cell-selected {
            background: #10b981 !important;
            color: #000 !important;
            transform: scale(1.15);
            z-index: 10;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 
                        0 0 40px rgba(16, 185, 129, 0.4);
            font-weight: 900;
            border: 3px solid #00ff88 !important;
            animation: pulse-glow 1s infinite;
        }
        
        .table-cell-row-highlight {
            background: #6366f1 !important;
            color: #00ff88 !important;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
            font-weight: 700;
        }
        
        .table-cell-col-highlight {
            background: #ec4899 !important;
            color: #00ffff !important;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
            font-weight: 700;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 
                            0 0 40px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 0 30px rgba(16, 185, 129, 1), 
                            0 0 60px rgba(16, 185, 129, 0.6);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .prose h1, .prose h2 { color: #facc15; font-weight: bold; margin-top: 10px; font-size: 1.1rem; }
        .prose strong { color: #4ade80; font-weight: bold; }
        .prose p { margin-bottom: 8px; line-height: 1.6; color: #e2e8f0; }

        /* AREA SCROLLABILE */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* SHARE BUTTONS */
        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .share-btn:active { transform: scale(0.95); }

        /* DISCOVER BUTTON STYLE */
        .discover-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .discover-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .discover-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .discover-btn:active {
            transform: translateY(0);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .thousand-block {
                width: 100px;
                height: 100px;
            }
            .thousand-block::before {
                font-size: 20px;
            }
            .hundred-block {
                width: 70px;
            }
            .btn-calc {
                height: 38px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const MODEL = "gemini-2.5-flash-lite"; 

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        const solveProblem = async (img) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            const prompt = `Sei un maestro di sostegno per un ragazzo di 9-10 anni con DSA.
            Risolvi questo problema in modo CHIARO e SEMPLICE.
            
            Struttura la risposta cos√¨:
            # TESTO DEL PROBLEMA
            # DATI (cosa sappiamo)
            # RAGIONAMENTO (come lo risolvo)
            # CALCOLI (passo per passo)
            # RISPOSTA FINALE
            
            Usa linguaggio semplice, frasi corte.
            Puoi usare emoji ma solo all'inizio delle sezioni.`;
            
            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }] }] };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Errore AI");
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        const cleanTextForSpeech = (text) => {
            return text
                .replace(/[*#_`~]/g, '')
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2300}-\u{23FF}]/gu, '')
                .replace(/[\u{2B50}]/gu, '')
                .replace(/[\u{1F4D0}-\u{1F4FF}]/gu, '')
                .replace(/[\u{270F}-\u{2712}]/gu, '')
                .replace(/[\u{2705}]/gu, '')
                .replace(/[\u{1F9E0}]/gu, '')
                .replace(/[\u{1F50D}]/gu, '')
                .replace(/\n+/g, '. ')
                .replace(/\.+/g, '.')
                .replace(/\s+/g, ' ')
                .trim();
        };

        const cleanTextForShare = (text) => {
            return text
                .replace(/#{1,3}\s*/g, '')
                .replace(/\*\*/g, '')
                .replace(/\*/g, '')
                .replace(/_/g, '')
                .trim();
        };

        const generateExerciseVersion = (text) => {
            let exercise = cleanTextForShare(text);
            
            exercise = exercise
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2300}-\u{23FF}]/gu, '')
                .replace(/[\u{2B50}]/gu, '')
                .replace(/[\u{1F4D0}-\u{1F4FF}]/gu, '')
                .replace(/[\u{270F}-\u{2712}]/gu, '')
                .replace(/[\u{2705}]/gu, '')
                .replace(/[\u{1F9E0}]/gu, '')
                .replace(/[\u{1F50D}]/gu, '')
                .replace(/[\u{00A9}\u{00AE}]/gu, '')
                .replace(/[\u{203C}\u{2049}]/gu, '')
                .replace(/[\u{20E3}]/gu, '')
                .replace(/[\u{FE00}-\u{FE0F}]/gu, '')
                .replace(/[\u{1F000}-\u{1FFFF}]/gu, '');
            
            exercise = exercise.replace(/(\d+\s*[\+\-\√ó\*x√∑\/]\s*\d+)\s*=\s*(\d+)/gi, '$1 = ______');
            exercise = exercise.replace(/=\s*(\d+)(\s|\.|\,|$)/g, '= ______$2');
            exercise = exercise.replace(/(RISPOSTA FINALE[:\s]*)([\s\S]*?)(?=\n\n|$)/gi, '$1\n\n______________________________\n\n(Scrivi qui la tua risposta)');
            
            return exercise;
        };

        const Base10Renderer = ({ num, label }) => {
            if (!num || isNaN(num)) return null;
            const n = Math.min(Math.floor(Math.abs(Number(num))), 9999);
            
            if (n > 9999) {
                return (
                    <div className="p-4 bg-slate-800/50 rounded-xl text-center border border-yellow-500">
                        <div className="text-yellow-400 font-bold mb-2">Numero grande</div>
                        <div className="text-4xl font-bold text-white">{n.toLocaleString('it-IT')}</div>
                    </div>
                );
            }
            
            const thousands = Math.floor(n / 1000);
            const hundreds = Math.floor((n % 1000) / 100);
            const tens = Math.floor((n % 100) / 10);
            const units = n % 10;

            return (
                <div className="bg-slate-800/40 p-4 rounded-xl border border-slate-700 w-full animate-fade-in mb-3">
                    <div className="flex justify-between items-center mb-3">
                        {label && (
                            <div className="text-base text-slate-300 font-bold uppercase">
                                {label}: <span className="text-white text-2xl">{n.toLocaleString('it-IT')}</span>
                            </div>
                        )}
                        <div className="flex gap-3 text-[10px] flex-wrap justify-end">
                            <div className="legend-item">
                                <div className="w-4 h-4 rounded" style={{background: 'linear-gradient(135deg, #f97316, #ea580c)'}}></div>
                                1000
                            </div>
                            <div className="legend-item">
                                <div className="w-3 h-3 border-2 border-[#a855f7] bg-[#581c87]"></div>
                                100
                            </div>
                            <div className="legend-item">
                                <div className="w-3 h-3 bg-[#3b82f6]"></div>
                                10
                            </div>
                            <div className="legend-item">
                                <div className="w-3 h-3 bg-[#4ade80]"></div>
                                1
                            </div>
                        </div>
                    </div>
                    <div className="holo-container">
                        {thousands > 0 && (
                            <div className="group-section">
                                {[...Array(thousands)].map((_, i) => (
                                    <div key={`th-${i}`} className="thousand-block"></div>
                                ))}
                            </div>
                        )}
                        {hundreds > 0 && (
                            <div className="group-section">
                                {[...Array(hundreds)].map((_, i) => (
                                    <div key={`h-${i}`} className="hundred-block">
                                        {[...Array(100)].map((_, j) => (
                                            <div key={j} className="hundred-segment"></div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}
                        {tens > 0 && (
                            <div className="group-section">
                                {[...Array(tens)].map((_, i) => (
                                    <div key={`t-${i}`} className="ten-block">
                                        {[...Array(10)].map((_, j) => (
                                            <div key={j} className="ten-segment"></div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        )}
                        {units > 0 && (
                            <div className="group-section" style={{borderRight:'none'}}>
                                {[...Array(units)].map((_, i) => (
                                    <div key={`u-${i}`} className="unit-block"></div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('calc');
            const [display, setDisplay] = useState('');
            const [solverImg, setSolverImg] = useState(null);
            const [solution, setSolution] = useState(null);
            const [loading, setLoading] = useState(false);
            const [visualizerNum, setVisualizerNum] = useState('');
            const [highlight, setHighlight] = useState({ r: null, c: null });
            const [showShareMenu, setShowShareMenu] = useState(false);

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const cleanText = cleanTextForSpeech(text);
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'it-IT'; 
                u.rate = 0.85;
                u.pitch = 1.0;
                window.speechSynthesis.speak(u);
            };

            const handleBtn = (v) => {
                if(v === 'C') setDisplay('');
                else if(v === '‚å´') setDisplay(p => p.slice(0, -1));
                else if(v === '=') {
                    try { 
                        let resVal = eval(display);
                        resVal = Math.round(resVal * 100) / 100;
                        setDisplay(resVal.toString()); 
                    } catch { setDisplay('Err'); }
                } else {
                    setDisplay(p => p + v);
                }
            };

            const handleUpload = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => setSolverImg(evt.target.result);
                r.readAsDataURL(f);
                setSolution(null);
            };
            
            const runSolver = async () => {
                if(!solverImg) return;
                setLoading(true);
                try {
                    const text = await solveProblem(solverImg);
                    setSolution(text);
                    if(window.EduGamer) EduGamer.addXP(50, 'matematica', 'problem'); else DB.addXP(50);
                    speak("Ho trovato la soluzione.");
                } catch(e) { alert("Errore: " + e.message); }
                setLoading(false);
            };

            const shareViaWhatsApp = () => {
                if(!solution) return;
                const text = cleanTextForShare(solution);
                const msg = encodeURIComponent(`üìö PROBLEMA RISOLTO\n\n${text}\n\n‚úÖ Risolto con EduGamer`);
                window.open(`https://wa.me/?text=${msg}`, '_blank');
                setShowShareMenu(false);
            };

            const shareViaEmail = () => {
                if(!solution) return;
                const text = cleanTextForShare(solution);
                const subject = encodeURIComponent('Problema di matematica risolto - EduGamer');
                const body = encodeURIComponent(`Ciao!\n\nEcco il problema che ho risolto:\n\n${text}\n\n---\nRisolto con EduGamer üìö`);
                window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
                setShowShareMenu(false);
            };

            const saveAsFile = () => {
                if(!solution) return;
                const text = cleanTextForShare(solution);
                const content = `PROBLEMA RISOLTO - EduGamer\n${'='.repeat(40)}\n\n${text}\n\n${'='.repeat(40)}\nData: ${new Date().toLocaleDateString('it-IT')}`;
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `problema_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setShowShareMenu(false);
            };

            const saveAsExercise = () => {
                if(!solution) return;
                const exercise = generateExerciseVersion(solution);
                const content = `ESERCIZIO DA COMPLETARE - EduGamer\n${'='.repeat(40)}\n\nIstruzioni: Leggi il problema e completa i calcoli!\nPoi confronta con la soluzione completa.\n\n${'='.repeat(40)}\n\n${exercise}\n\n${'='.repeat(40)}\nData: ${new Date().toLocaleDateString('it-IT')}\n\nBuon lavoro!`;
                
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `esercizio_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setShowShareMenu(false);
            };

            const renderCalcVisuals = () => {
                if (!display) return (
                    <div className="flex flex-col items-center justify-center h-full opacity-40 py-8">
                        <div className="text-5xl mb-3">üî¢</div>
                        <p className="text-base">Scrivi un numero o un'operazione</p>
                        <p className="text-xs text-slate-500 mt-1">Es: 1250 + 3400</p>
                    </div>
                );
                
                const match = display.match(/^(\d+(?:\.\d+)?)([\+\-\*\/])(\d+(?:\.\d+)?)$/);
                
                if (match) {
                    const [_, n1, op, n2] = match;
                    const a = parseFloat(n1), b = parseFloat(n2);
                    
                    let resVal = 0;
                    if (op==='+') resVal = a+b; 
                    if (op==='-') resVal = a-b; 
                    if (op==='*') resVal = a*b; 
                    if (op==='/') resVal = b!==0 ? a/b : 0;
                    const res = Math.round(resVal * 100) / 100;

                    if (op === '/') {
                        const divisor = Math.floor(b);
                        const floorQuotient = Math.floor(a / b);
                        const rem = Math.round((a % b) * 100) / 100;
                        
                        const showExactBlocks = divisor <= 15;
                        
                        return (
                            <div className="flex flex-col gap-3 w-full pb-8">
                                <Base10Renderer num={a} label="Totale" />
                                <div className="text-center text-yellow-400 font-bold py-2 bg-slate-800/50 rounded-xl">
                                    ‚¨áÔ∏è DIVIDO IN GRUPPI DA {divisor} ‚¨áÔ∏è
                                </div>
                                <div className="flex flex-wrap gap-2 justify-center p-3 bg-slate-800/30 rounded-xl">
                                    {[...Array(Math.min(floorQuotient, 12))].map((_, i) => (
                                        <div key={i} className="bg-slate-800 p-2 rounded-lg border-2 border-blue-500 flex flex-col items-center">
                                            <span className="text-[10px] text-slate-400 mb-1">Gr.{i+1}</span>
                                            <div className="flex flex-wrap gap-1 justify-center" style={{maxWidth:'80px'}}>
                                                {showExactBlocks ? (
                                                    [...Array(divisor)].map((_,j) => (
                                                        <div key={j} className="w-3 h-3 bg-blue-500 rounded-sm"></div>
                                                    ))
                                                ) : (
                                                    <>
                                                        {[...Array(6)].map((_,j) => (
                                                            <div key={j} className="w-3 h-3 bg-blue-500 rounded-sm"></div>
                                                        ))}
                                                        <span className="text-slate-400 text-xs">...</span>
                                                    </>
                                                )}
                                            </div>
                                            <span className="text-xs text-blue-300 mt-1 font-bold">= {divisor}</span>
                                        </div>
                                    ))}
                                    {floorQuotient > 12 && (
                                        <div className="bg-slate-800 p-2 rounded-lg border-2 border-dashed border-slate-500 flex flex-col items-center justify-center">
                                            <span className="text-slate-400 text-lg">...</span>
                                            <span className="text-xs text-slate-400">+{floorQuotient - 12} altri</span>
                                        </div>
                                    )}
                                </div>
                                {rem > 0 && (
                                    <div className="bg-slate-800 p-3 rounded-xl border-2 border-yellow-500 self-center">
                                        <div className="text-sm text-yellow-500 font-bold text-center mb-1">‚ö†Ô∏è RESTO</div>
                                        <div className="flex gap-1 justify-center flex-wrap" style={{maxWidth:'100px'}}>
                                            {[...Array(Math.min(Math.floor(rem), 15))].map((_,i)=><div key={i} className="w-3 h-3 bg-yellow-500 rounded-sm"></div>)}
                                        </div>
                                        <div className="text-center text-yellow-400 font-bold mt-1">= {rem}</div>
                                    </div>
                                )}
                                <div className="bg-slate-800 p-3 rounded-xl border-2 border-green-500 text-center">
                                    <div className="text-sm text-slate-400 mb-1">Ho fatto</div>
                                    <div className="text-xl font-bold text-green-400">
                                        {floorQuotient} gruppi
                                        {rem > 0 && <span className="text-yellow-400 text-base ml-2">+ resto {rem}</span>}
                                    </div>
                                    <div className="text-base text-cyan-400 font-mono border-t border-slate-700 pt-1 mt-1">
                                        {a} √∑ {divisor} = {res}
                                    </div>
                                </div>
                            </div>
                        );
                    }
                    
                    return (
                        <div className="flex flex-col w-full animate-fade-in gap-2 pb-8">
                            <Base10Renderer num={a} label="Primo" />
                            <div className="text-2xl font-bold text-center text-yellow-400 py-1">{op}</div>
                            <Base10Renderer num={b} label="Secondo" />
                            <div className="text-2xl font-bold text-center text-white py-1">=</div>
                            <div className="text-center text-3xl font-bold text-green-400 p-3 bg-slate-800 rounded-xl border-2 border-green-500">
                                {res.toLocaleString('it-IT')}
                            </div>
                            {res > 0 && res <= 9999 && <Base10Renderer num={res} label="Risultato" />}
                        </div>
                    );
                }
                
                const num = parseFloat(display);
                if (!isNaN(num)) return <Base10Renderer num={num} label="Quantit√†" />;
                return null;
            };

            const renderKeyboard = () => {
                return (
                    <div className="flex gap-2 p-2 bg-slate-900 border-b border-slate-700 shrink-0">
                        <div className="bg-slate-950 px-3 rounded-xl text-right text-2xl font-mono text-yellow-400 border-2 border-slate-600 h-12 flex items-center justify-end overflow-hidden min-w-[120px]">
                            {display || '0'}
                        </div>

                        <div className="grid grid-cols-3 gap-1 flex-1">
                            {['1','2','3','4','5','6','7','8','9','.','0','='].map(b => (
                                <button 
                                    key={b} 
                                    onClick={() => handleBtn(b)} 
                                    className={`btn-calc ${b === '=' ? 'bg-green-600 text-white' : 'bg-slate-800 text-white'}`}
                                >
                                    {b}
                                </button>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 gap-1 w-12">
                            {[{l:'√∑',v:'/'},{l:'√ó',v:'*'},{l:'‚àí',v:'-'},{l:'+',v:'+'}].map(op => (
                                <button key={op.v} onClick={() => handleBtn(op.v)} className="btn-calc bg-blue-600 text-white">{op.l}</button>
                            ))}
                        </div>

                        <div className="grid grid-cols-1 gap-1 w-12">
                            <button onClick={() => handleBtn('‚å´')} className="btn-calc bg-orange-600 text-white text-base">‚å´</button>
                            <button onClick={() => handleBtn('C')} className="btn-calc bg-red-600 text-white row-span-3 h-full">C</button>
                        </div>
                    </div>
                );
            };

            const renderShareMenu = () => {
                if(!showShareMenu) return null;
                
                return (
                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowShareMenu(false)}>
                        <div className="bg-slate-800 rounded-2xl p-4 w-full max-w-sm border-2 border-slate-600" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-center text-white mb-4">üì§ Condividi Soluzione</h3>
                            
                            <div className="flex flex-col gap-3">
                                <button onClick={shareViaWhatsApp} className="share-btn bg-green-600 text-white">
                                    <span className="text-xl">üí¨</span> WhatsApp
                                </button>
                                
                                <button onClick={shareViaEmail} className="share-btn bg-blue-600 text-white">
                                    <span className="text-xl">üìß</span> Email
                                </button>
                                
                                <button onClick={saveAsFile} className="share-btn bg-purple-600 text-white">
                                    <span className="text-xl">üíæ</span> Salva Soluzione
                                </button>

                                <button onClick={saveAsExercise} className="share-btn bg-yellow-600 text-white">
                                    <span className="text-xl">üìù</span> Salva Esercizio
                                </button>
                                
                                <button onClick={() => setShowShareMenu(false)} className="share-btn bg-slate-600 text-white mt-2">
                                    ‚úï Chiudi
                                </button>
                            </div>

                            <div className="mt-4 p-3 bg-slate-700/50 rounded-xl text-xs text-slate-400">
                                <p><strong className="text-yellow-400">üìù Esercizio:</strong> Versione da stampare con spazi bianchi per i calcoli. Il ragazzo pu√≤ esercitarsi e poi confrontare con la soluzione!</p>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col p-2 gap-2 bg-slate-900">
                    <div className="flex gap-2 shrink-0 h-11">
                        <a href="index.html" className="bg-slate-700 text-white px-3 rounded-xl font-bold flex items-center justify-center text-lg active:scale-95">üè†</a>
                        <button onClick={()=>setMode('calc')} className={`flex-1 rounded-xl font-bold active:scale-95 ${mode==='calc'?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}`}>CALCOLA</button>
                        <button onClick={()=>setMode('matrix')} className={`flex-1 rounded-xl font-bold active:scale-95 ${mode==='matrix'?'bg-yellow-600 text-white':'bg-slate-800 text-slate-400'}`}>TABELLINE</button>
                        <button onClick={()=>setMode('solver')} className={`flex-1 rounded-xl font-bold active:scale-95 ${mode==='solver'?'bg-green-600 text-white':'bg-slate-800 text-slate-400'}`}>RISOLVI</button>
                    </div>

                    <div className="flex-1 bg-slate-950 rounded-2xl border-2 border-slate-700 overflow-hidden flex flex-col">
                        
                        {mode === 'calc' && (
                            <>
                                {renderKeyboard()}
                                <div className="scroll-area p-3 bg-slate-900">
                                    {renderCalcVisuals()}
                                </div>
                            </>
                        )}

                        {mode === 'matrix' && (
                            <div className="scroll-area p-2">
                                <div className="grid grid-cols-11 gap-1 min-h-full">
                                    {[...Array(11)].map((_,r)=>[...Array(11)].map((_,c)=>(
                                        <div key={`${r}-${c}`} 
                                            onClick={() => { 
                                                if(r>0 && c>0) { 
                                                    setHighlight({r,c}); 
                                                    speak(`${r} per ${c} fa ${r*c}`); 
                                                }
                                            }}
                                            className={`table-cell flex items-center justify-center rounded cursor-pointer text-base h-9 active:scale-95
                                                ${r===0||c===0 ? 'bg-slate-900 text-yellow-400 font-bold' : 
                                                  (highlight.r===r && highlight.c===c) ? 'table-cell-selected' : 
                                                  ((highlight.r===r && c>0)) ? 'table-cell-row-highlight' :
                                                  ((highlight.c===c && r>0)) ? 'table-cell-col-highlight' : 'bg-slate-800 text-slate-400'}
                                            `}
                                        >
                                            {r===0&&c===0?'√ó':r===0?c:c===0?r:r*c}
                                        </div>
                                    )))}
                                </div>
                            </div>
                        )}

                        {mode === 'solver' && (
                            <div className="scroll-area p-3">
                                
                                {/* DISCOVER CARD */}
                                <div className="discover-card">
                                    <div className="text-center mb-3">
                                        <h3 className="text-xl font-bold text-blue-300 mb-2">üéØ METODO DISCOVER</h3>
                                        <p className="text-sm text-slate-300 mb-3">
                                            Vuoi risolvere il problema <strong>guidato passo-passo</strong>?
                                            <br/>Il metodo DISCOVER ti aiuta a imparare il ragionamento!
                                        </p>
                                        <a href="discover.html" className="discover-btn">
                                            üéØ Apri METODO DISCOVER
                                        </a>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mt-4">
                                        <div className="bg-slate-900/50 p-2 rounded">
                                            <strong className="text-green-400">‚ö° Risoluzione Rapida</strong><br/>
                                            L'AI spiega subito (qui sotto ‚¨áÔ∏è)
                                        </div>
                                        <div className="bg-slate-900/50 p-2 rounded border border-blue-500">
                                            <strong className="text-blue-400">üéØ DISCOVER</strong><br/>
                                            Impari il metodo completo
                                        </div>
                                    </div>
                                </div>

                                {!solverImg ? (
                                    <div className="flex flex-col items-center justify-center min-h-[300px] gap-4 text-center">
                                        <div className="text-5xl animate-bounce">üìê</div>
                                        <h2 className="text-xl font-bold text-white">FOTO AL PROBLEMA</h2>
                                        <p className="text-slate-400 text-sm">Scatta una foto al problema di matematica</p>
                                        <label className="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl cursor-pointer shadow-lg flex items-center gap-2 active:scale-95">
                                            <input type="file" onChange={handleUpload} className="hidden" accept="image/*" />
                                            üì∑ SCATTA FOTO
                                        </label>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-3">
                                        <div className="flex gap-2 items-center bg-slate-800 p-2 rounded-xl border border-slate-600 shrink-0">
                                            <img src={solverImg} className="h-14 w-14 rounded-lg object-cover border-2 border-slate-500" />
                                            <button onClick={runSolver} disabled={loading} className="flex-1 bg-green-600 text-white font-bold py-2 rounded-xl active:scale-95">
                                                {loading ? '‚è≥ Leggo...' : 'üöÄ RISOLVI'}
                                            </button>
                                            <button onClick={()=>{setSolverImg(null); setSolution(null);}} className="bg-red-600 text-white px-3 py-2 rounded-xl font-bold active:scale-95">üóëÔ∏è</button>
                                        </div>
                                        
                                        {solution && (
                                            <div className="bg-slate-800/50 rounded-xl border border-slate-600 p-3">
                                                <div className="flex gap-2 mb-3 flex-wrap">
                                                    <button onClick={() => speak(solution)} className="share-btn bg-purple-600 text-white text-sm py-2 px-3">
                                                        üîä Leggi
                                                    </button>
                                                    <button onClick={() => window.speechSynthesis.cancel()} className="share-btn bg-red-600 text-white text-sm py-2 px-3">
                                                        ‚èπÔ∏è Stop
                                                    </button>
                                                    <button onClick={() => setShowShareMenu(true)} className="share-btn bg-green-600 text-white text-sm py-2 px-3">
                                                        üì§ Condividi
                                                    </button>
                                                </div>
                                                
                                                <div className="prose prose-invert text-sm" dangerouslySetInnerHTML={{__html: marked.parse(solution)}}></div>
                                            </div>
                                        )}
                                        
                                        {!solution && !loading && (
                                            <div className="flex flex-col items-center justify-center py-8 text-slate-500">
                                                <div className="text-4xl mb-3">‚ú®</div>
                                                <p>Premi RISOLVI per vedere la soluzione</p>
                                            </div>
                                        )}

                                        <div className="bg-slate-900 rounded-xl border-2 border-dashed border-slate-600 p-3">
                                            <div className="text-center text-yellow-400 font-bold mb-2 text-sm">üëÄ VISUALIZZA NUMERO</div>
                                            <div className="text-xs text-slate-400 text-center mb-2">Se dice "1250 mele", scrivi 1250:</div>
                                            <input 
                                                type="number" 
                                                value={visualizerNum}
                                                onChange={(e) => setVisualizerNum(e.target.value)}
                                                placeholder="Es: 1250"
                                                className="w-full bg-slate-800 border-2 border-slate-500 rounded-lg p-2 text-center text-lg font-bold text-white mb-2 focus:border-green-400 outline-none"
                                            />
                                            {visualizerNum && <Base10Renderer num={visualizerNum} label="Blocchi" />}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {renderShareMenu()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script src="game-system.js"></script>
</body>
</html>