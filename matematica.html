<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematica DSA - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0a0e17; color: white; font-family: 'Verdana', sans-serif; height: 100dvh; overflow: hidden; }
        
        /* STILI BLOCCHI VISIVI */
        .holo-container {
            display: flex; flex-direction: row; flex-wrap: wrap; gap: 4px;
            align-items: flex-end; padding: 10px; background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; border: 1px dashed #475569; min-height: 60px; width: 100%;
        }
        .unit-block { width: 12px; height: 12px; background: #4ade80; border: 1px solid #166534; margin: 1px; border-radius: 1px; }
        .ten-block { display: flex; flex-direction: column; margin: 1px; border: 1px solid #1e3a8a; border-radius: 2px; }
        .ten-segment { width: 12px; height: 12px; background: #3b82f6; border-bottom: 1px solid #1e3a8a; }
        .hundred-block { display: grid; grid-template-columns: repeat(10, 1fr); width: 64px; margin: 2px; border: 2px solid #a855f7; border-radius: 2px; }
        .hundred-segment { width: 6px; height: 6px; background: #a855f7; border: 0.5px solid #581c87; }

        /* Animazioni */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* Stile Soluzione Passo-Passo (Simil Video) */
        .step-card {
            background: #1e293b; border: 2px solid #475569; padding: 20px; margin-bottom: 15px;
            border-radius: 15px; transition: all 0.3s; cursor: pointer;
        }
        .step-card.active { border-color: #4ade80; background: #0f172a; transform: scale(1.02); box-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .step-number { font-size: 1.5em; font-weight: bold; color: #facc15; margin-bottom: 5px; }
        
        .btn-calc { font-size: 1.5rem; font-weight: bold; border-radius: 12px; transition: 0.1s; box-shadow: 0 4px 0 #1e293b; }
        .btn-calc:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // AGGIORNATO AL MODELLO PI√ô POTENTE (Dicembre 2025)
        const MODEL = "gemini-2.0-flash"; 

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        // --- RISOLUTORE "VIDEO OVERVIEW" ---
        // Chiediamo a Gemini di creare uno script diviso in scene
        const solveProblem = async (img) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            
            const prompt = `Sei un tutor per un bambino con DSA.
            Analizza l'immagine del problema e crea una spiegazione divisa in 4 "SCENE" chiare, come se fosse un video.
            
            Rispondi SOLO con questo JSON:
            [
              { "title": "üîç 1. I Dati", "text": "Leggi i dati...", "visual_hint": "Cerca i numeri" },
              { "title": "üß† 2. L'Idea", "text": "Dobbiamo capire...", "visual_hint": "Immagina..." },
              { "title": "‚úèÔ∏è 3. Il Calcolo", "text": "Facciamo...", "visual_hint": "Operazione" },
              { "title": "‚úÖ 4. Risultato", "text": "La risposta √®...", "visual_hint": "Soluzione" }
            ]`;

            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }] }] };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Errore AI");
            const data = await res.json();
            let text = data.candidates[0].content.parts[0].text;
            text = text.replace(/```json|```/g, '').trim();
            return JSON.parse(text);
        };

        // --- COMPONENTE: BLOCCHI BASE 10 ---
        const Base10Renderer = ({ num, label }) => {
            if (!num || isNaN(num)) return null;
            const n = Math.min(Math.floor(Math.abs(Number(num))), 999);
            if (n > 500) return <div className="p-2 bg-slate-800 rounded text-xs text-yellow-400">Numero troppo grande! ({n})</div>;
            
            const hundreds = Math.floor(n / 100);
            const tens = Math.floor((n % 100) / 10);
            const units = n % 10;

            return (
                <div className="bg-slate-800/80 p-2 rounded-lg border border-slate-600 w-full animate-fade-in">
                    {label && <div className="text-xs text-slate-400 font-bold mb-1 uppercase">{label}: {n}</div>}
                    <div className="holo-container">
                        {[...Array(hundreds)].map((_, i) => <div key={`h-${i}`} className="hundred-block">{[...Array(100)].map((_, j) => <div key={j} className="hundred-segment"></div>)}</div>)}
                        {[...Array(tens)].map((_, i) => <div key={`t-${i}`} className="ten-block">{[...Array(10)].map((_, j) => <div key={j} className="ten-segment"></div>)}</div>)}
                        <div className="flex flex-wrap gap-1">{[...Array(units)].map((_, i) => <div key={`u-${i}`} className="unit-block"></div>)}</div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPALE ---
        const App = () => {
            const [mode, setMode] = useState('calc');
            const [display, setDisplay] = useState('');
            const [solverImg, setSolverImg] = useState(null);
            const [steps, setSteps] = useState(null); // Passaggi del "video"
            const [activeStep, setActiveStep] = useState(0);
            const [loading, setLoading] = useState(false);
            const [visualizerNum, setVisualizerNum] = useState('');
            const [highlight, setHighlight] = useState({ r: null, c: null });

            // Sintesi Vocale Pulita
            const speak = (text) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'it-IT'; u.rate = 0.95;
                window.speechSynthesis.speak(u);
            };

            // Riproduce il "Video" (Autoplay dei passaggi)
            const playOverview = async () => {
                if(!steps) return;
                for (let i = 0; i < steps.length; i++) {
                    setActiveStep(i);
                    speak(steps[i].text);
                    // Attesa stimata per la lettura (semplificata)
                    await new Promise(r => setTimeout(r, steps[i].text.length * 80 + 1000));
                }
            };

            const handleBtn = (v) => {
                if(v === 'C') { setDisplay(''); speak("Cancella"); }
                else if(v === '=') {
                    try { const res = eval(display).toString(); setDisplay(res); speak("Fa " + res); } 
                    catch { setDisplay('Err'); }
                } else {
                    setDisplay(p => p + v);
                    const map = {'+':'pi√π','-':'meno','*':'per','/':'diviso'};
                    speak(map[v] || v);
                }
            };

            const handleUpload = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => setSolverImg(evt.target.result);
                r.readAsDataURL(f);
                setSteps(null);
            };
            
            const runSolver = async () => {
                if(!solverImg) return;
                setLoading(true);
                try {
                    const resSteps = await solveProblem(solverImg);
                    setSteps(resSteps);
                    DB.addXP(50);
                    // Avvia subito la spiegazione
                    setTimeout(() => {
                        setActiveStep(0);
                        speak("Ecco la soluzione. Ascolta bene.");
                    }, 500);
                } catch(e) { alert("Errore: " + e.message); }
                setLoading(false);
            };

            // Render Calcolatrice (omesso per brevit√†, identico alla v4 ma con logica base 10)
            const renderCalcVisuals = () => {
                 if (!display) return <div className="flex flex-col items-center justify-center h-full opacity-30"><div className="text-4xl">üî¢</div><p>Scrivi un numero...</p></div>;
                const match = display.match(/^(\d+)([\+\-\*\/])(\d+)$/);
                if (match) {
                     const [_, n1, op, n2] = match;
                     const a = parseInt(n1), b = parseInt(n2);
                     let res = 0;
                     if (op==='+') res = a+b; if (op==='-') res = a-b; if (op==='*') res = a*b; if (op==='/') res = b!==0 ? Math.floor(a/b) : 0;
                     
                     // Visualizzazione Divisione
                     if (op === '/') {
                        return (
                            <div className="pb-20">
                                <Base10Renderer num={a} label="Totale" />
                                <div className="text-center text-yellow-400 font-bold my-2">‚¨áÔ∏è GRUPPI DA {b} ‚¨áÔ∏è</div>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {[...Array(Math.min(res, 12))].map((_,i) => (
                                        <div key={i} className="bg-slate-800 p-1 rounded border border-blue-500 text-center">
                                            <div className="text-[10px] text-slate-500">Gr.{i+1}</div>
                                            <div className="flex flex-wrap gap-0.5 w-8 justify-center">{[...Array(Math.min(b,9))].map((_,j)=><div key={j} className="w-2 h-2 bg-blue-500 rounded-sm"></div>)}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 text-center text-2xl font-bold bg-slate-800 p-2 rounded-xl">Risultato: <span className="text-green-400">{res}</span></div>
                            </div>
                        );
                     }
                     return (
                         <div className="pb-10">
                            <Base10Renderer num={a} label="Primo" />
                            <div className="text-center text-2xl font-bold text-yellow-400">{op}</div>
                            <Base10Renderer num={b} label="Secondo" />
                            <div className="text-center text-2xl font-bold text-white">=</div>
                            <div className="text-center text-4xl font-bold text-green-400 p-2 bg-slate-800 rounded-xl">{res}</div>
                         </div>
                     );
                }
                const num = parseInt(display);
                return !isNaN(num) ? <Base10Renderer num={num} label="Quantit√†" /> : null;
            };

            return (
                <div className="h-full flex flex-col p-4 gap-3 bg-slate-900">
                    <div className="flex gap-2 shrink-0 h-12">
                        <a href="index.html" className="bg-slate-700 text-white px-4 rounded-xl font-bold flex items-center justify-center text-2xl">üè†</a>
                        <button onClick={()=>setMode('calc')} className={`flex-1 rounded-xl font-bold ${mode==='calc'?'bg-blue-600':'bg-slate-800'}`}>CALCOLATRICE</button>
                        <button onClick={()=>setMode('matrix')} className={`flex-1 rounded-xl font-bold ${mode==='matrix'?'bg-yellow-600':'bg-slate-800'}`}>TABELLINE</button>
                        <button onClick={()=>setMode('solver')} className={`flex-1 rounded-xl font-bold ${mode==='solver'?'bg-green-600':'bg-slate-800'}`}>RISOLVI</button>
                    </div>

                    <div className="flex-1 bg-slate-950 rounded-2xl border-2 border-slate-700 overflow-hidden relative">
                        
                        {mode === 'calc' && (
                            <div className="h-full flex flex-col md:flex-row">
                                <div className="w-full md:w-1/3 p-4 flex flex-col gap-2 border-b md:border-r border-slate-700 bg-slate-900 z-10">
                                    <div className="bg-slate-950 p-4 rounded-xl text-right text-4xl font-mono text-yellow-400 border border-slate-600 h-20 flex items-center justify-end overflow-hidden">{display || '0'}</div>
                                    <div className="grid grid-cols-4 gap-2 flex-1">
                                        {['7','8','9','/','4','5','6','*','1','2','3','-','C','0','.','+'].map(b => (
                                            <button key={b} onClick={() => handleBtn(b)} className={`btn-calc ${b==='C'?'bg-red-600':['/','*','-','+'].includes(b)?'bg-slate-700 text-yellow-400':'bg-slate-800'}`}>{b==='*'?'√ó':b==='/'?'√∑':b}</button>
                                        ))}
                                        <button onClick={() => handleBtn('=')} className="col-span-4 btn-calc bg-green-600">=</button>
                                    </div>
                                </div>
                                <div className="flex-1 p-4 overflow-y-auto bg-slate-900">{renderCalcVisuals()}</div>
                            </div>
                        )}

                        {mode === 'matrix' && (
                            <div className="grid grid-cols-11 gap-1 h-full w-full overflow-auto p-2">
                                {[...Array(11)].map((_,r)=>[...Array(11)].map((_,c)=>(
                                    <div key={`${r}-${c}`} onClick={()=>{if(r>0&&c>0){setHighlight({r,c});speak(`${r} per ${c} fa ${r*c}`)}}} 
                                        className={`flex items-center justify-center rounded cursor-pointer text-lg h-10 ${r===0||c===0?'bg-slate-900 text-yellow-400':(highlight.r===r&&highlight.c===c)?'bg-green-500 text-black scale-110 border-2 border-white':((highlight.r===r&&c>0)||(highlight.c===c&&r>0))?'bg-slate-700 text-green-300':'bg-slate-800 text-slate-400'}`}>
                                        {r===0&&c===0?'√ó':r===0?c:c===0?r:r*c}
                                    </div>
                                )))}
                            </div>
                        )}

                        {mode === 'solver' && (
                            <div className="h-full flex flex-col p-4 overflow-y-auto">
                                {!solverImg ? (
                                    <div className="flex flex-col items-center justify-center h-full gap-6 text-center">
                                        <div className="text-6xl animate-bounce">üìê</div>
                                        <h2 className="text-2xl font-bold">FOTO PROBLEMA</h2>
                                        <label className="bg-blue-600 hover:bg-blue-500 px-8 py-4 rounded-2xl cursor-pointer font-bold text-xl shadow-lg flex items-center gap-2">
                                            <input type="file" onChange={handleUpload} className="hidden" accept="image/*" capture="environment" />
                                            üì∑ SCATTA FOTO
                                        </label>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-4 h-full">
                                        <div className="flex gap-3 items-center bg-slate-800 p-2 rounded-xl border border-slate-600 shrink-0">
                                            <img src={solverImg} className="h-20 w-20 rounded-lg object-cover border border-slate-500" />
                                            <button onClick={runSolver} disabled={loading} className="flex-1 bg-green-600 py-3 rounded-lg font-bold">{loading?'Sto analizzando...':'RISOLVI üöÄ'}</button>
                                            <button onClick={()=>setSolverImg(null)} className="bg-red-600 px-4 py-3 rounded-lg font-bold">üóëÔ∏è</button>
                                        </div>
                                        
                                        <div className="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
                                            {/* SINISTRA: SPIEGAZIONE A STEP (VIDEO STYLE) */}
                                            <div className="flex-1 bg-slate-900 p-2 overflow-y-auto">
                                                {steps ? (
                                                    <div>
                                                        <div className="flex justify-between items-center mb-4">
                                                            <h3 className="text-yellow-400 font-bold">SPIEGAZIONE</h3>
                                                            <button onClick={playOverview} className="bg-blue-600 px-3 py-1 rounded text-sm font-bold">‚ñ∂Ô∏è RIPRODUCI TUTTO</button>
                                                        </div>
                                                        {steps.map((step, i) => (
                                                            <div key={i} onClick={() => { setActiveStep(i); speak(step.text); }} 
                                                                className={`step-card ${activeStep === i ? 'active' : ''}`}>
                                                                <div className="step-number">{step.title}</div>
                                                                <p className="text-slate-300 text-lg">{step.text}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="text-center text-slate-500 mt-10">Fai tap su RISOLVI per vedere la spiegazione passo-passo ‚ú®</div>
                                                )}
                                            </div>

                                            {/* DESTRA: VISUALIZZATORE BLOCCHI */}
                                            <div className="w-full md:w-1/3 bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 p-3 flex flex-col">
                                                <div className="text-center text-green-400 font-bold mb-2 text-sm">üëÄ VISUALIZZA NUMERI</div>
                                                <input type="number" value={visualizerNum} onChange={(e) => setVisualizerNum(e.target.value)} placeholder="Es: 25" className="w-full bg-slate-900 border border-slate-500 rounded-lg p-2 text-center text-xl font-bold mb-3 outline-none" />
                                                <div className="flex-1 overflow-y-auto">
                                                    {visualizerNum ? <Base10Renderer num={visualizerNum} label="Blocchi" /> : <div className="text-center text-slate-500 mt-4">Inserisci un numero del problema...</div>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>