<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematica DSA - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #0a0e17; color: white; font-family: 'Verdana', sans-serif; height: 100dvh; overflow: hidden; }
        
        /* STILI BLOCCHI VISIVI (Orizzontali) */
        .holo-container {
            display: flex; flex-direction: row; flex-wrap: wrap; gap: 8px;
            align-items: center; /* Allineamento centrale verticale */
            padding: 10px; background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; border: 1px dashed #475569; 
            min-height: 50px; width: 100%;
        }
        
        /* Unit√† (Verdi) */
        .unit-block { 
            width: 16px; height: 16px; 
            background: #4ade80; border: 1px solid #166534; 
            border-radius: 2px; flex-shrink: 0; 
        }

        /* Decine (Blu) - ORA ORIZZONTALI */
        .ten-block { 
            display: flex; flex-direction: row; /* Sdraiate */
            border: 1px solid #1e3a8a; border-radius: 3px; 
            overflow: hidden; flex-shrink: 0;
        }
        .ten-segment { 
            width: 12px; height: 16px; /* Larghezza ridotta per compattezza */
            background: #3b82f6; 
            border-right: 1px solid #1e3a8a; /* Linea separatrice verticale */
        }
        .ten-segment:last-child { border-right: none; }

        /* Centinaia (Viola) */
        .hundred-block { 
            display: grid; grid-template-columns: repeat(10, 1fr); 
            width: 80px; /* Compatto */
            border: 2px solid #a855f7; border-radius: 3px; 
            flex-shrink: 0; background: #581c87;
        }
        .hundred-segment { 
            width: 100%; height: 8px; 
            border: 0.5px solid rgba(168, 85, 247, 0.3); 
        }

        /* Gruppi separati per ordine mentale */
        .group-section {
            display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
            padding-right: 8px; border-right: 1px solid #334155;
            margin-right: 4px;
        }
        .group-section:last-child { border-right: none; }

        /* Animazioni e Pulsanti */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .btn-calc { font-size: 1.5rem; font-weight: bold; border-radius: 12px; transition: 0.1s; box-shadow: 0 4px 0 #1e293b; }
        .btn-calc:active { transform: translateY(4px); box-shadow: none; }
        
        /* Stile Soluzione */
        .prose h1, .prose h2 { color: #facc15; font-weight: bold; margin-top: 10px; }
        .prose strong { color: #4ade80; font-weight: bold; }
        .prose p { margin-bottom: 8px; line-height: 1.6; color: #e2e8f0; }
        .prose ul { list-style: none; padding: 0; }
        .prose li { margin-bottom: 6px; padding-left: 12px; border-left: 3px solid #3b82f6; background: rgba(30, 41, 59, 0.3); padding: 8px; border-radius: 0 8px 8px 0; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const MODEL = "gemini-2.0-flash"; // Modello stabile

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        // --- PROMPT RISOLUTORE ---
        const solveProblem = async (img) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            
            const prompt = `Sei un maestro di sostegno esperto in DSA.
            Analizza l'immagine e risolvi il problema.
            
            IMPORTANTE: La tua risposta deve seguire ESATTAMENTE questa struttura:

            # üìñ TESTO DEL PROBLEMA
            (Qui trascrivi fedelmente il testo che leggi nell'immagine)

            # üîç I DATI
            (Elenca i numeri e cosa rappresentano)

            # üß† RAGIONAMENTO
            (Spiega a parole semplici quale operazione useremo e perch√©. Usa emoji)

            # ‚úèÔ∏è I CALCOLI
            (Mostra l'operazione in riga e il risultato)

            # ‚úÖ RISPOSTA
            (La frase finale completa)
            
            Usa un linguaggio semplice e chiaro.`;

            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }] }] };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Errore AI");
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        // --- COMPONENTE: BLOCCHI BASE 10 (ORIZZONTALE) ---
        const Base10Renderer = ({ num, label }) => {
            if (!num || isNaN(num)) return null;
            const n = Math.min(Math.floor(Math.abs(Number(num))), 999);
            if (n > 500) return <div className="p-2 bg-slate-800 rounded text-xs text-yellow-400">Numero troppo grande per i blocchi! ({n})</div>;
            
            const hundreds = Math.floor(n / 100);
            const tens = Math.floor((n % 100) / 10);
            const units = n % 10;

            return (
                <div className="bg-slate-800/80 p-2 rounded-lg border border-slate-600 w-full animate-fade-in">
                    <div className="flex justify-between items-center mb-2">
                        {label && <div className="text-xs text-slate-200 font-bold uppercase">{label}: <span className="text-yellow-400 text-lg">{n}</span></div>}
                        
                        {/* LEGENDA */}
                        <div className="flex gap-2 text-[9px] uppercase tracking-wider text-slate-400">
                            <div className="flex items-center gap-1"><div className="w-3 h-3 border border-[#a855f7] bg-[#581c87]"></div>100</div>
                            <div className="flex items-center gap-1"><div className="w-4 h-2 bg-[#3b82f6]"></div>10</div>
                            <div className="flex items-center gap-1"><div className="w-2 h-2 bg-[#4ade80]"></div>1</div>
                        </div>
                    </div>

                    <div className="holo-container">
                        {/* Sezione Centinaia */}
                        {hundreds > 0 && (
                            <div className="group-section">
                                {[...Array(hundreds)].map((_, i) => (
                                    <div key={`h-${i}`} className="hundred-block">
                                        {[...Array(100)].map((_, j) => <div key={j} className="hundred-segment"></div>)}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Sezione Decine (Orizzontali) */}
                        {tens > 0 && (
                            <div className="group-section">
                                {[...Array(tens)].map((_, i) => (
                                    <div key={`t-${i}`} className="ten-block">
                                        {[...Array(10)].map((_, j) => <div key={j} className="ten-segment"></div>)}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Sezione Unit√† */}
                        {units > 0 && (
                            <div className="group-section" style={{borderRight:'none'}}>
                                {[...Array(units)].map((_, i) => <div key={`u-${i}`} className="unit-block"></div>)}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPALE ---
        const App = () => {
            const [mode, setMode] = useState('calc');
            const [display, setDisplay] = useState('');
            const [solverImg, setSolverImg] = useState(null);
            const [solution, setSolution] = useState(null);
            const [loading, setLoading] = useState(false);
            const [visualizerNum, setVisualizerNum] = useState('');
            const [highlight, setHighlight] = useState({ r: null, c: null });

            // Sintesi Vocale
            const speak = (text) => {
                window.speechSynthesis.cancel();
                let cleanText = text
                    .replace(/[*#_`~-]/g, '') 
                    .replace(/[\u{1F300}-\u{1F9FF}]/gu, '') 
                    .replace(/[\u{2600}-\u{26FF}]/gu, '') 
                    .replace(/[\u{2700}-\u{27BF}]/gu, '')
                    .replace(/\n+/g, '. ');

                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'it-IT'; u.rate = 0.95;
                window.speechSynthesis.speak(u);
            };

            const handleBtn = (v) => {
                if(v === 'C') { 
                    setDisplay(''); 
                    speak("Cancella");
                } else if(v === '=') {
                    try { 
                        let resVal = eval(display);
                        resVal = Math.round(resVal * 100) / 100; 
                        const res = resVal.toString();
                        setDisplay(res); 
                        speak("Uguale a " + res);
                    } catch { setDisplay('Err'); speak("Errore"); }
                } else {
                    setDisplay(p => p + v);
                    const names = {'+':'pi√π', '-':'meno', '*':'per', '/':'diviso', '.':'virgola'};
                    if(names[v]) speak(names[v]);
                }
            };

            const handleUpload = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => setSolverImg(evt.target.result);
                r.readAsDataURL(f);
                setSolution(null);
            };
            
            const runSolver = async () => {
                if(!solverImg) return;
                setLoading(true);
                try {
                    const text = await solveProblem(solverImg);
                    setSolution(text);
                    DB.addXP(50);
                    speak("Problema risolto! Premi il tasto leggi per ascoltare la soluzione.");
                } catch(e) { alert("Errore: " + e.message); }
                setLoading(false);
            };

            const renderCalcVisuals = () => {
                if (!display) return <div className="flex flex-col items-center justify-center h-full opacity-30"><div className="text-4xl">üî¢</div><p>Scrivi un numero...</p></div>;
                const match = display.match(/^(\d+(?:\.\d+)?)([\+\-\*\/])(\d+(?:\.\d+)?)$/);
                
                if (match) {
                    const [_, n1, op, n2] = match;
                    const a = parseFloat(n1), b = parseFloat(n2);
                    
                    let resVal = 0;
                    if (op==='+') resVal = a+b; 
                    if (op==='-') resVal = a-b; 
                    if (op==='*') resVal = a*b; 
                    if (op==='/') resVal = b!==0 ? a/b : 0;
                    const res = Math.round(resVal * 100) / 100;

                    if (op === '/') {
                        const floorQuotient = Math.floor(a / b);
                        const rem = a % b;
                        
                        return (
                            <div className="flex flex-col gap-2 w-full pb-20">
                                <Base10Renderer num={a} label="Totale" />
                                <div className="text-center text-yellow-400 font-bold">‚¨áÔ∏è GRUPPI DA {b} ‚¨áÔ∏è</div>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {[...Array(Math.min(floorQuotient, 15))].map((_, i) => (
                                        <div key={i} className="bg-slate-800 p-1 rounded border border-blue-500 flex flex-col items-center">
                                            <span className="text-[10px] text-slate-500">Gr.{i+1}</span>
                                            <div className="flex flex-wrap gap-1 justify-center">
                                                {/* Blocchi decina orizzontali anche qui, se serve, o unit√† per semplicit√† nel gruppo */}
                                                {[...Array(Math.min(b, 10))].map((_,j)=><div key={j} className="w-2 h-2 bg-blue-500 rounded-sm"></div>)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {rem > 0 && (
                                    <div className="bg-slate-800 p-2 rounded border border-yellow-500 self-center mt-2">
                                        <div className="text-xs text-yellow-500 font-bold text-center">RESTO ({rem})</div>
                                        <div className="flex gap-1 justify-center">{[...Array(rem)].map((_,i)=><div key={i} className="w-3 h-3 bg-yellow-500 rounded-sm"></div>)}</div>
                                    </div>
                                )}
                                <div className="mt-4 bg-slate-800 p-3 rounded-xl border border-green-500 text-center">
                                    <div className="text-xl font-bold text-white">
                                        {floorQuotient} <span className="text-sm font-normal text-slate-400">con resto di</span> <span className="text-yellow-400">{rem}</span>
                                    </div>
                                    <div className="text-sm text-cyan-400 mt-1 font-mono border-t border-slate-700 pt-1">
                                        Risultato esatto: {res}
                                    </div>
                                </div>
                            </div>
                        );
                    }
                    
                    return (
                        <div className="flex flex-col w-full animate-fade-in pb-10">
                            <Base10Renderer num={a} label="Primo" />
                            <div className="text-4xl font-bold text-center text-yellow-400 my-1">{op === '+' ? '‚ûï' : op === '-' ? '‚ûñ' : '‚úñÔ∏è'}</div>
                            <Base10Renderer num={b} label="Secondo" />
                            <div className="text-4xl font-bold text-center text-white my-1">=</div>
                            <div className="text-center text-4xl font-bold text-green-