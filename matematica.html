<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematica DSA - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- FONT OPENDYSLEXIC -->
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">

    <style>
        * {
            letter-spacing: 0.02em;
        }

        body { 
            background-color: #0a0e17; 
            color: white; 
            font-family: 'OpenDyslexic', Verdana, sans-serif; 
            height: 100dvh; 
            overflow: hidden; 
        }
        
        /* STILI BLOCCHI VISIVI */
        .holo-container {
            display: flex; flex-direction: row; flex-wrap: wrap; gap: 6px;
            align-items: center; padding: 8px; background: rgba(0, 0, 0, 0.2);
            border-radius: 8px; border: 1px dashed #475569; 
            width: 100%; min-height: 40px;
        }
        
        .unit-block { width: 14px; height: 14px; background: #4ade80; border: 1px solid #166534; border-radius: 2px; flex-shrink: 0; }
        
        .ten-block { display: flex; flex-direction: row; border: 1px solid #1e3a8a; border-radius: 2px; overflow: hidden; flex-shrink: 0; }
        .ten-segment { width: 10px; height: 14px; background: #3b82f6; border-right: 1px solid #1e3a8a; }
        .ten-segment:last-child { border-right: none; }

        .hundred-block { display: grid; grid-template-columns: repeat(10, 1fr); width: 70px; border: 2px solid #a855f7; border-radius: 2px; flex-shrink: 0; background: #581c87; }
        .hundred-segment { width: 100%; height: 7px; border: 0.5px solid rgba(168, 85, 247, 0.3); }

        /* Gruppi */
        .group-section { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; padding-right: 6px; border-right: 1px solid #334155; margin-right: 4px; }
        .group-section:last-child { border-right: none; }

        /* Animazioni */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* TASTIERA CALCOLATRICE */
        .btn-calc { 
            font-size: 1.4rem; 
            font-weight: bold; 
            border-radius: 12px; 
            transition: 0.1s; 
            box-shadow: 0 3px 0 #1e293b; 
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-calc:active { 
            transform: translateY(3px); 
            box-shadow: none; 
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        .prose h1, .prose h2 { color: #facc15; font-weight: bold; margin-top: 10px; }
        .prose strong { color: #4ade80; font-weight: bold; }
        .prose p { margin-bottom: 8px; line-height: 1.6; color: #e2e8f0; }

        /* AREA RISULTATO SCROLLABILE */
        .visual-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 80px;
        }

        /* GRUPPO DIVISIONE */
        .division-group {
            background: #1e293b;
            padding: 8px;
            border-radius: 12px;
            border: 2px solid #3b82f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 70px;
        }
        .division-group .blocks-container {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            max-width: 90px;
            min-height: 20px;
        }
        .division-group .block-unit {
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 2px;
            border: 1px solid #1e40af;
        }
        .division-group .group-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        .division-group .group-count {
            font-size: 12px;
            color: #60a5fa;
            font-weight: bold;
            margin-top: 4px;
            background: #0f172a;
            padding: 2px 8px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const MODEL = "gemini-2.5-flash"; 

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        const solveProblem = async (img) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            const prompt = `Sei un maestro di sostegno per un ragazzo di 9-10 anni con DSA.
            Risolvi questo problema in modo CHIARO e SEMPLICE.
            
            Struttura la risposta cos√¨:
            # TESTO DEL PROBLEMA
            # DATI (cosa sappiamo)
            # RAGIONAMENTO (come lo risolvo)
            # CALCOLI (passo per passo)
            # RISPOSTA FINALE
            
            Usa linguaggio semplice, frasi corte.
            Puoi usare emoji ma solo all'inizio delle sezioni.`;
            
            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }] }] };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Errore AI");
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        // PULIZIA TESTO PER SINTESI VOCALE (rimuove emoji)
        const cleanTextForSpeech = (text) => {
            return text
                .replace(/[*#_`~]/g, '')
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2300}-\u{23FF}]/gu, '')
                .replace(/[\u{2B50}]/gu, '')
                .replace(/[\u{1F4D0}-\u{1F4FF}]/gu, '')
                .replace(/[\u{270F}-\u{2712}]/gu, '')
                .replace(/[\u{2705}]/gu, '')
                .replace(/[\u{1F9E0}]/gu, '')
                .replace(/[\u{1F50D}]/gu, '')
                .replace(/\n+/g, '. ')
                .replace(/\.+/g, '.')
                .replace(/\s+/g, ' ')
                .trim();
        };

        const Base10Renderer = ({ num, label }) => {
            if (!num || isNaN(num)) return null;
            const n = Math.min(Math.floor(Math.abs(Number(num))), 999);
            if (n > 500) return <div className="p-2 bg-slate-800/50 rounded text-xs text-yellow-400 mb-1">Numero grande: {n}</div>;
            
            const hundreds = Math.floor(n / 100);
            const tens = Math.floor((n % 100) / 10);
            const units = n % 10;

            return (
                <div className="bg-slate-800/40 p-3 rounded-xl border border-slate-700 w-full animate-fade-in mb-3">
                    <div className="flex justify-between items-center mb-2">
                        {label && <div className="text-sm text-slate-300 font-bold uppercase">{label}: <span className="text-white text-lg">{n}</span></div>}
                        <div className="flex gap-3 text-[10px] uppercase tracking-wider text-slate-500">
                            <div className="flex items-center gap-1"><div className="w-3 h-3 border border-[#a855f7] bg-[#581c87]"></div>100</div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-[#3b82f6]"></div>10</div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-[#4ade80]"></div>1</div>
                        </div>
                    </div>
                    <div className="holo-container">
                        {hundreds > 0 && <div className="group-section">{[...Array(hundreds)].map((_, i) => <div key={`h-${i}`} className="hundred-block">{[...Array(100)].map((_, j) => <div key={j} className="hundred-segment"></div>)}</div>)}</div>}
                        {tens > 0 && <div className="group-section">{[...Array(tens)].map((_, i) => <div key={`t-${i}`} className="ten-block">{[...Array(10)].map((_, j) => <div key={j} className="ten-segment"></div>)}</div>)}</div>}
                        {units > 0 && <div className="group-section" style={{borderRight:'none'}}>{[...Array(units)].map((_, i) => <div key={`u-${i}`} className="unit-block"></div>)}</div>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('calc');
            const [display, setDisplay] = useState('');
            const [solverImg, setSolverImg] = useState(null);
            const [solution, setSolution] = useState(null);
            const [loading, setLoading] = useState(false);
            const [visualizerNum, setVisualizerNum] = useState('');
            const [highlight, setHighlight] = useState({ r: null, c: null });
            const [showShareMenu, setShowShareMenu] = useState(false);

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const cleanText = cleanTextForSpeech(text);
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'it-IT'; 
                u.rate = 0.85;
                u.pitch = 1.0;
                window.speechSynthesis.speak(u);
            };

            // === FUNZIONI CONDIVISIONE ===
            const getShareText = () => {
                if (!solution) return '';
                let content = `PROBLEMA RISOLTO - EduGamer\n${'='.repeat(30)}\n\n`;
                content += cleanTextForSpeech(solution);
                content += `\n\n${'='.repeat(30)}\nRisolto con EduGamer`;
                return content;
            };

            const shareViaWhatsApp = () => {
                const msg = encodeURIComponent(getShareText());
                window.open(`https://wa.me/?text=${msg}`, '_blank');
                setShowShareMenu(false);
            };

            const shareViaEmail = () => {
                const subject = encodeURIComponent('Problema risolto - EduGamer');
                const body = encodeURIComponent(getShareText());
                window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
                setShowShareMenu(false);
            };

            const saveAsFile = () => {
                const content = getShareText();
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `problema_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setShowShareMenu(false);
            };

            const handleBtn = (v) => {
                if(v === 'C') setDisplay('');
                else if(v === '‚å´') setDisplay(p => p.slice(0, -1));
                else if(v === '=') {
                    try { 
                        let resVal = eval(display);
                        resVal = Math.round(resVal * 100) / 100;
                        setDisplay(resVal.toString()); 
                    } catch { setDisplay('Err'); }
                } else {
                    setDisplay(p => p + v);
                }
            };

            const handleUpload = (e) => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => setSolverImg(evt.target.result);
                r.readAsDataURL(f);
                setSolution(null);
            };
            
            const runSolver = async () => {
                if(!solverImg) return;
                setLoading(true);
                try {
                    const text = await solveProblem(solverImg);
                    setSolution(text);
                    DB.addXP(50);
                    speak("Ho trovato la soluzione. Tocca il pulsante leggi per ascoltarla.");
                } catch(e) { alert("Errore: " + e.message); }
                setLoading(false);
            };

            const renderCalcVisuals = () => {
                if (!display) return (
                    <div className="flex flex-col items-center justify-center h-full opacity-40">
                        <div className="text-6xl mb-4">üî¢</div>
                        <p className="text-lg">Scrivi un numero o un'operazione...</p>
                        <p className="text-sm text-slate-500 mt-2">Es: 25 + 13</p>
                    </div>
                );
                
                const match = display.match(/^(\d+(?:\.\d+)?)([\+\-\*\/])(\d+(?:\.\d+)?)$/);
                
                if (match) {
                    const [_, n1, op, n2] = match;
                    const a = parseFloat(n1), b = parseFloat(n2);
                    
                    let resVal = 0;
                    if (op==='+') resVal = a+b; 
                    if (op==='-') resVal = a-b; 
                    if (op==='*') resVal = a*b; 
                    if (op==='/') resVal = b!==0 ? a/b : 0;
                    const res = Math.round(resVal * 100) / 100;

                    if (op === '/') {
                        const divisor = Math.floor(b);
                        const floorQuotient = Math.floor(a / b);
                        const rem = Math.round((a % b) * 100) / 100;
                        
                        // Limite gruppi visibili (max 15 gruppi)
                        const maxGroupsToShow = Math.min(floorQuotient, 15);
                        const hasMoreGroups = floorQuotient > 15;
                        
                        // Limite blocchi per gruppo (max 15 blocchi, poi solo numero)
                        const maxBlocksToShow = Math.min(divisor, 15);
                        const showBlocksVisually = divisor <= 15;
                        
                        return (
                            <div className="flex flex-col gap-3 w-full">
                                <Base10Renderer num={a} label="Totale da dividere" />
                                
                                <div className="text-center text-yellow-400 font-bold text-lg py-2 bg-slate-800/50 rounded-xl">
                                    ‚¨áÔ∏è DIVIDO IN GRUPPI DA {divisor} ‚¨áÔ∏è
                                </div>
                                
                                {/* GRUPPI DIVISIONE */}
                                <div className="flex flex-wrap gap-3 justify-center p-4 bg-slate-800/30 rounded-xl">
                                    {[...Array(maxGroupsToShow)].map((_, i) => (
                                        <div key={i} className="division-group">
                                            <span className="group-label">Gruppo {i+1}</span>
                                            
                                            {showBlocksVisually ? (
                                                /* Mostra blocchi esatti */
                                                <div className="blocks-container">
                                                    {[...Array(divisor)].map((_,j) => (
                                                        <div key={j} className="block-unit"></div>
                                                    ))}
                                                </div>
                                            ) : (
                                                /* Troppi blocchi: mostra simbolico */
                                                <div className="blocks-container">
                                                    {[...Array(6)].map((_,j) => (
                                                        <div key={j} className="block-unit"></div>
                                                    ))}
                                                    <span className="text-slate-400 text-xs">...</span>
                                                </div>
                                            )}
                                            
                                            <span className="group-count">= {divisor}</span>
                                        </div>
                                    ))}
                                    
                                    {hasMoreGroups && (
                                        <div className="division-group border-dashed border-slate-500">
                                            <span className="text-slate-400 text-2xl">...</span>
                                            <span className="group-count text-slate-400">+{floorQuotient - 15} altri</span>
                                        </div>
                                    )}
                                </div>
                                
                                {/* RESTO */}
                                {rem > 0 && (
                                    <div className="bg-slate-800 p-3 rounded-xl border-2 border-yellow-500 self-center">
                                        <div className="text-sm text-yellow-500 font-bold text-center mb-2">‚ö†Ô∏è RESTO</div>
                                        <div className="flex gap-1 justify-center flex-wrap" style={{maxWidth: '120px'}}>
                                            {[...Array(Math.min(Math.floor(rem), 15))].map((_,i) => (
                                                <div key={i} className="w-4 h-4 bg-yellow-500 rounded-sm border border-yellow-600"></div>
                                            ))}
                                        </div>
                                        <div className="text-center text-yellow-400 font-bold mt-2 text-lg">= {rem}</div>
                                    </div>
                                )}
                                
                                {/* RISULTATO FINALE */}
                                <div className="mt-3 bg-slate-800 p-4 rounded-xl border-2 border-green-500 text-center">
                                    <div className="text-sm text-slate-400 mb-1">Ho fatto</div>
                                    <div className="text-2xl font-bold text-green-400">
                                        {floorQuotient} gruppi
                                        {rem > 0 && <span className="text-yellow-400 text-lg ml-2">+ resto {rem}</span>}
                                    </div>
                                    <div className="text-lg text-cyan-400 font-mono border-t border-slate-700 pt-2 mt-2">
                                        {a} √∑ {divisor} = {res}
                                    </div>
                                </div>
                            </div>
                        );
                    }
                    
                    return (
                        <div className="flex flex-col w-full animate-fade-in gap-2">
                            <Base10Renderer num={a} label="Primo numero" />
                            <div className="text-3xl font-bold text-center text-yellow-400 py-2">{op}</div>
                            <Base10Renderer num={b} label="Secondo numero" />
                            <div className="text-3xl font-bold text-center text-white py-2">=</div>
                            <div className="text-center text-4xl font-bold text-green-400 p-4 bg-slate-800 rounded-xl border-2 border-green-500">
                                {res}
                            </div>
                            {res > 0 && res < 1000 && <Base10Renderer num={res} label="Risultato" />}
                        </div>
                    );
                }
                
                const num = parseFloat(display);
                if (!isNaN(num)) return <Base10Renderer num={num} label="Quantit√†" />;
                return null;
            };

            // TASTIERA RIORGANIZZATA: Numeri a sinistra, comandi a destra
            const renderKeyboard = () => {
                const numbers = [
                    ['7', '8', '9'],
                    ['4', '5', '6'],
                    ['1', '2', '3'],
                    ['0', '.', '=']
                ];
                
                const operators = [
                    { label: '√∑', value: '/' },
                    { label: '√ó', value: '*' },
                    { label: '‚àí', value: '-' },
                    { label: '+', value: '+' }
                ];
                
                return (
                    <div className="flex gap-2 p-3 bg-slate-900 border-b border-slate-700">
                        {/* DISPLAY */}
                        <div className="bg-slate-950 px-4 rounded-xl text-right text-3xl font-mono text-yellow-400 border-2 border-slate-600 h-16 flex items-center justify-end overflow-hidden min-w-[180px] flex-shrink-0">
                            {display || '0'}
                        </div>

                        {/* NUMERI (griglia 4x3) */}
                        <div className="grid grid-cols-3 gap-2 flex-1">
                            {numbers.flat().map(b => (
                                <button 
                                    key={b} 
                                    onClick={() => handleBtn(b)} 
                                    className={`btn-calc ${b === '=' ? 'bg-green-600 text-white' : 'bg-slate-800 text-white hover:bg-slate-700'}`}
                                >
                                    {b}
                                </button>
                            ))}
                        </div>

                        {/* OPERATORI (colonna) */}
                        <div className="grid grid-cols-1 gap-2 w-16">
                            {operators.map(op => (
                                <button 
                                    key={op.value} 
                                    onClick={() => handleBtn(op.value)} 
                                    className="btn-calc bg-blue-600 text-white hover:bg-blue-500"
                                >
                                    {op.label}
                                </button>
                            ))}
                        </div>

                        {/* COMANDI (colonna) */}
                        <div className="grid grid-cols-1 gap-2 w-16">
                            <button onClick={() => handleBtn('‚å´')} className="btn-calc bg-orange-600 text-white hover:bg-orange-500">‚å´</button>
                            <button onClick={() => handleBtn('C')} className="btn-calc bg-red-600 text-white hover:bg-red-500 row-span-3 h-full">C</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col p-3 gap-3 bg-slate-900">
                    {/* Header Navigation */}
                    <div className="flex gap-2 shrink-0 h-12">
                        <a href="index.html" className="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded-xl font-bold flex items-center justify-center text-xl active:scale-95">üè†</a>
                        <button onClick={()=>setMode('calc')} className={`flex-1 rounded-xl font-bold text-lg active:scale-95 ${mode==='calc'?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}`}>CALCOLA</button>
                        <button onClick={()=>setMode('matrix')} className={`flex-1 rounded-xl font-bold text-lg active:scale-95 ${mode==='matrix'?'bg-yellow-600 text-white':'bg-slate-800 text-slate-400'}`}>TABELLINE</button>
                        <button onClick={()=>setMode('solver')} className={`flex-1 rounded-xl font-bold text-lg active:scale-95 ${mode==='solver'?'bg-green-600 text-white':'bg-slate-800 text-slate-400'}`}>RISOLVI</button>
                    </div>

                    <div className="flex-1 bg-slate-950 rounded-2xl border-2 border-slate-700 overflow-hidden relative flex flex-col">
                        
                        {mode === 'calc' && (
                            <>
                                {/* TASTIERA RIORGANIZZATA */}
                                {renderKeyboard()}

                                {/* AREA VISUALE SCROLLABILE */}
                                <div className="visual-area bg-slate-900">
                                    {renderCalcVisuals()}
                                </div>
                            </>
                        )}

                        {mode === 'matrix' && (
                            <div className="grid grid-cols-11 gap-1 h-full w-full overflow-auto p-2">
                                {[...Array(11)].map((_,r)=>[...Array(11)].map((_,c)=>(
                                    <div key={`${r}-${c}`} 
                                        onClick={() => { if(r>0 && c>0) { setHighlight({r,c}); speak(`${r} per ${c} fa ${r*c}`); }}}
                                        className={`flex items-center justify-center rounded cursor-pointer text-lg h-10 active:scale-95
                                            ${r===0||c===0 ? 'bg-slate-900 text-yellow-400 font-bold' : 
                                              (highlight.r===r && highlight.c===c) ? 'bg-green-500 text-black scale-110 z-10 font-bold border-2 border-white' : 
                                              ((highlight.r===r && c>0) || (highlight.c===c && r>0)) ? 'bg-slate-700 text-green-300' : 'bg-slate-800 text-slate-400'}
                                        `}
                                    >
                                        {r===0&&c===0?'√ó':r===0?c:c===0?r:r*c}
                                    </div>
                                )))}
                            </div>
                        )}

                        {mode === 'solver' && (
                            <div className="h-full flex flex-col p-4 overflow-y-auto">
                                {!solverImg ? (
                                    <div className="flex flex-col items-center justify-center h-full gap-6 text-center">
                                        <div className="text-6xl animate-bounce">üìê</div>
                                        <h2 className="text-2xl font-bold text-white">FOTO AL PROBLEMA</h2>
                                        <p className="text-slate-400">Scatta una foto al problema di matematica</p>
                                        <label className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-xl cursor-pointer shadow-lg flex items-center gap-2 border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
                                            <input type="file" onChange={handleUpload} className="hidden" accept="image/*" />
                                            üì∑ SCATTA FOTO
                                        </label>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-4 h-full">
                                        <div className="flex gap-3 items-center bg-slate-800 p-3 rounded-xl border border-slate-600 shrink-0">
                                            <img src={solverImg} className="h-20 w-20 rounded-lg object-cover border-2 border-slate-500" />
                                            <button onClick={runSolver} disabled={loading} className="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl text-lg active:scale-95">
                                                {loading ? '‚è≥ Sto leggendo...' : 'üöÄ RISOLVI'}
                                            </button>
                                            <button onClick={()=>{setSolverImg(null); setSolution(null);}} className="bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded-xl font-bold active:scale-95">üóëÔ∏è</button>
                                        </div>
                                        
                                        <div className="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
                                            {/* SOLUZIONE */}
                                            <div className="flex-1 bg-slate-800/50 rounded-xl border border-slate-600 p-4 overflow-y-auto relative">
                                                {solution ? (
                                                    <div>
                                                        <div className="flex gap-2 float-right mb-2">
                                                            <button 
                                                                onClick={() => window.speechSynthesis.cancel()} 
                                                                className="bg-red-600 hover:bg-red-500 p-3 rounded-xl text-sm font-bold text-white active:scale-95"
                                                            >
                                                                ‚èπÔ∏è
                                                            </button>
                                                            <button 
                                                                onClick={() => speak(solution)} 
                                                                className="bg-purple-600 hover:bg-purple-500 p-3 rounded-xl text-sm font-bold text-white flex items-center gap-2 active:scale-95"
                                                            >
                                                                üîä LEGGI
                                                            </button>
                                                            <button 
                                                                onClick={() => setShowShareMenu(true)} 
                                                                className="bg-green-600 hover:bg-green-500 p-3 rounded-xl text-sm font-bold text-white flex items-center gap-2 active:scale-95"
                                                            >
                                                                üì§ CONDIVIDI
                                                            </button>
                                                        </div>
                                                        <div className="prose prose-invert text-base clear-both" dangerouslySetInnerHTML={{__html: marked.parse(solution)}}></div>
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                                        <div className="text-4xl mb-4">‚ú®</div>
                                                        <p>Premi RISOLVI per vedere la soluzione spiegata</p>
                                                    </div>
                                                )}
                                            </div>

                                            {/* VISUALIZZATORE */}
                                            <div className="w-full md:w-1/3 bg-slate-900 rounded-xl border-2 border-dashed border-slate-600 p-3 flex flex-col">
                                                <div className="text-center text-yellow-400 font-bold mb-2">üëÄ VISUALIZZA NUMERO</div>
                                                <div className="text-xs text-slate-400 text-center mb-2">Se il problema dice "25 mele", scrivi 25:</div>
                                                <input 
                                                    type="number" 
                                                    value={visualizerNum}
                                                    onChange={(e) => setVisualizerNum(e.target.value)}
                                                    placeholder="Es: 25"
                                                    className="w-full bg-slate-800 border-2 border-slate-500 rounded-lg p-3 text-center text-xl font-bold text-white mb-3 focus:border-green-400 outline-none"
                                                />
                                                <div className="flex-1 overflow-y-auto bg-slate-950 rounded-lg p-2 border border-slate-800">
                                                    {visualizerNum ? (
                                                        <Base10Renderer num={visualizerNum} label="Blocchi" />
                                                    ) : (
                                                        <div className="text-center text-slate-600 mt-10">I blocchi appariranno qui...</div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                    </div>

                    {/* MENU CONDIVISIONE */}
                    {showShareMenu && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowShareMenu(false)}>
                            <div className="bg-slate-800 rounded-2xl p-5 w-full max-w-sm border-2 border-slate-600" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-center text-white mb-4">üì§ Condividi Soluzione</h3>
                                
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={shareViaWhatsApp} 
                                        className="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded-xl active:scale-95"
                                    >
                                        üí¨ WhatsApp
                                    </button>
                                    
                                    <button 
                                        onClick={shareViaEmail} 
                                        className="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl active:scale-95"
                                    >
                                        üìß Email
                                    </button>
                                    
                                    <button 
                                        onClick={saveAsFile} 
                                        className="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-xl active:scale-95"
                                    >
                                        üíæ Salva File
                                    </button>
                                    
                                    <button 
                                        onClick={() => setShowShareMenu(false)} 
                                        className="flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-4 rounded-xl mt-2 active:scale-95"
                                    >
                                        ‚úï Chiudi
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
