<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italiano - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">

    <style>
        * { letter-spacing: 0.03em; word-spacing: 0.05em; }

        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body { 
            background-color: #0a0e17; 
            color: white; 
            font-family: 'OpenDyslexic', Verdana, sans-serif;
            line-height: 1.6;
        }

        /* SCROLL */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* TEXTAREA */
        .editor-area {
            font-family: 'OpenDyslexic', Verdana, sans-serif;
            font-size: 1.1rem;
            line-height: 1.8;
            letter-spacing: 0.03em;
        }

        /* ERRORI */
        .error-card { transition: all 0.2s; }
        .error-card:active { transform: scale(0.98); }

        /* TIPO ERRORE */
        .badge-ort { background: #dc2626; }
        .badge-pun { background: #f59e0b; }
        .badge-sin { background: #8b5cf6; }

        /* SHARE BUTTONS */
        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .share-btn:active { transform: scale(0.95); }

        /* ANIMAZIONI */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef } = React;
        const MODEL = "gemini-2.5-flash"; // MODELLO AGGIORNATO

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key')
        };

        // PULIZIA TESTO PER SINTESI VOCALE
        const cleanTextForSpeech = (text) => {
            return text
                .replace(/[*#_`~]/g, '')
                .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                .replace(/\n+/g, '. ')
                .replace(/\.+/g, '.')
                .replace(/\s+/g, ' ')
                .trim();
        };

        const checkText = async (text) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key! Vai su Home.");
            
            // NUOVO PROMPT "SEGUGIO"
            const prompt = `Sei un correttore esperto e RIGOROSO per la scuola primaria.
            Analizza questo testo: "${text}"
            
            OBIETTIVO: Trova TUTTI gli errori in un unico passaggio. Sii ossessivo sulla PUNTEGGIATURA.
            
            CATEGORIE ERRORE:
            - ORT (Ortografia): Accenti, doppie, 'h' mancanti, apostrofi, maiuscole.
            - PUN (Punteggiatura): Virgole negli elenchi, punti fine frase, spazi dopo la virgola.
            - SIN (Sintassi): Frasi contorte, verbi sbagliati, ripetizioni.

            ISTRUZIONI:
            1. Se mancano virgole o punti, SEGNALO.
            2. Spiegazioni TELEGRAFICHE (max 6 parole).
            3. Se il testo √® perfetto, array vuoto.

            Rispondi SOLO con un JSON array valido:
            [{"original":"testo errato", "type":"ORT", "correction":"correzione", "explanation":"spiegazione"}]`;
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            if(!res.ok) throw new Error("Errore AI");
            const data = await res.json();
            const jsonText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            return JSON.parse(jsonText);
        };

        const App = () => {
            const [text, setText] = useState('');
            const [correctedText, setCorrectedText] = useState('');
            const [errors, setErrors] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showShareMenu, setShowShareMenu] = useState(false);
            const [viewMode, setViewMode] = useState('edit'); // 'edit' o 'review'
            const textareaRef = useRef(null);

            // Funzione XP
            const addXP = (amount, action) => {
                if (window.EduGamer) {
                    window.EduGamer.addXP(amount, 'italiano', action);
                } else {
                    const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                    localStorage.setItem('edu_xp', next.toString());
                    window.dispatchEvent(new Event('xpChanged'));
                }
            };

            // NUOVA FUNZIONE VOCE CON FIX GOOGLE
            const speak = (text) => {
                window.speechSynthesis.cancel();
                const cleanText = cleanTextForSpeech(text);
                const u = new SpeechSynthesisUtterance(cleanText);
                
                // FORZA VOCE GOOGLE
                const voices = window.speechSynthesis.getVoices();
                const googleVoice = voices.find(v => v.lang.includes('it') && v.name.includes('Google'));
                const itVoice = voices.find(v => v.lang.includes('it'));
                if (googleVoice) u.voice = googleVoice;
                else if (itVoice) u.voice = itVoice;

                u.lang = 'it-IT'; 
                u.rate = 0.85;
                window.speechSynthesis.speak(u);
            };

            // HANDLECHECK CHE ATTIVA LA REVISIONE
            const handleCheck = async () => {
                if(!text.trim()) return;
                setLoading(true);
                setErrors(null);
                
                try {
                    const res = await checkText(text);
                    setErrors(res);
                    setCorrectedText(text);
                    
                    if(res.length === 0) {
                        speak("Bravissimo! Non ho trovato nessun errore!");
                        addXP(30, 'perfect');
                    } else {
                        speak(`Ho trovato ${res.length} errori. Guarda le parole sottolineate.`);
                        setViewMode('review'); // ATTIVA MODALIT√Ä SOTTOLINEATA
                        addXP(10, 'check');
                    }
                } catch(e) { 
                    alert("Errore: " + e.message); 
                }
                setLoading(false);
            };

            // GENERATORE TESTO EVIDENZIATO
            const renderHighlightedText = () => {
                if (!errors) return text;
                
                let htmlText = text;
                const sortedErrors = [...errors].sort((a, b) => b.original.length - a.original.length);

                sortedErrors.forEach(err => {
                    let colorClass = "";
                    if(err.type === 'ORT') colorClass = "decoration-red-500 bg-red-500/20";
                    else if(err.type === 'PUN') colorClass = "decoration-yellow-500 bg-yellow-500/20";
                    else colorClass = "decoration-purple-500 bg-purple-500/20";
                    
                    const span = `<span class="underline decoration-wavy decoration-2 ${colorClass} font-bold cursor-pointer" title="${err.explanation}">${err.original}</span>`;
                    htmlText = htmlText.replace(err.original, span);
                });

                return <div className="editor-area p-4 whitespace-pre-wrap" dangerouslySetInnerHTML={{__html: htmlText}}></div>;
            };

            const fixError = (idx) => {
                const err = errors[idx];
                const newText = correctedText.replace(err.original, err.correction);
                setCorrectedText(newText);
                setText(newText);
                
                const newErrors = errors.filter((_, i) => i !== idx);
                setErrors(newErrors);
                
                speak(`Corretto! ${err.original} diventa ${err.correction}`);
                addXP(5, 'fix');
                
                if(newErrors.length === 0) {
                    speak("Perfetto! Hai corretto tutto!");
                    setViewMode('edit');
                }
            };

            const fixAll = () => {
                let newText = correctedText;
                errors.forEach(err => {
                    newText = newText.replace(err.original, err.correction);
                });
                setCorrectedText(newText);
                setText(newText);
                setErrors([]);
                speak("Ho corretto tutti gli errori!");
                setViewMode('edit');
                addXP(30, 'perfect');
            };

            const reset = () => {
                setText('');
                setCorrectedText('');
                setErrors(null);
                setViewMode('edit');
                window.speechSynthesis.cancel();
            };

            // === FUNZIONI CONDIVISIONE RIPRISTINATE ===
            const getShareText = () => {
                let shareContent = `CORREZIONE TESTO - EduGamer\n${'='.repeat(30)}\n\n`;
                shareContent += `TESTO ORIGINALE:\n${text}\n\n`;
                
                if(errors && errors.length > 0) {
                    shareContent += `ERRORI TROVATI (${errors.length}):\n`;
                    errors.forEach((e, i) => {
                        shareContent += `${i+1}. "${e.original}" ‚Üí "${e.correction}"\n   (${e.type}) ${e.explanation}\n`;
                    });
                    shareContent += `\nTESTO CORRETTO:\n${correctedText}\n`;
                } else {
                    shareContent += `Nessun errore trovato!\n`;
                }
                
                shareContent += `\n${'='.repeat(30)}\nCorretto con EduGamer`;
                return shareContent;
            };

            const shareViaWhatsApp = () => {
                const msg = encodeURIComponent(getShareText());
                window.open(`https://wa.me/?text=${msg}`, '_blank');
                setShowShareMenu(false);
            };

            const shareViaEmail = () => {
                const subject = encodeURIComponent('Correzione testo - EduGamer');
                const body = encodeURIComponent(getShareText());
                window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
                setShowShareMenu(false);
            };

            const saveAsFile = () => {
                const content = getShareText();
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `correzione_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setShowShareMenu(false);
            };

            const getErrorBadgeClass = (type) => {
                switch(type) {
                    case 'ORT': return 'badge-ort';
                    case 'PUN': return 'badge-pun';
                    case 'SIN': return 'badge-sin';
                    default: return 'bg-slate-600';
                }
            };

            const getErrorLabel = (type) => {
                switch(type) {
                    case 'ORT': return 'Ortografia';
                    case 'PUN': return 'Punteggiatura';
                    case 'SIN': return 'Sintassi';
                    default: return type;
                }
            };

            // MENU CONDIVISIONE RIPRISTINATO
            const renderShareMenu = () => {
                if(!showShareMenu) return null;
                
                return (
                    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setShowShareMenu(false)}>
                        <div className="bg-slate-800 rounded-2xl p-5 w-full max-w-sm border-2 border-slate-600 animate-fade-in" onClick={e => e.stopPropagation()}>
                            <h3 className="text-xl font-bold text-center text-white mb-4">üì§ Condividi Correzione</h3>
                            
                            <div className="flex flex-col gap-3">
                                <button onClick={shareViaWhatsApp} className="share-btn bg-green-600 text-white">
                                    <span className="text-xl">üí¨</span> WhatsApp
                                </button>
                                
                                <button onClick={shareViaEmail} className="share-btn bg-blue-600 text-white">
                                    <span className="text-xl">üìß</span> Email
                                </button>
                                
                                <button onClick={saveAsFile} className="share-btn bg-purple-600 text-white">
                                    <span className="text-xl">üíæ</span> Salva File
                                </button>
                                
                                <button onClick={() => setShowShareMenu(false)} className="share-btn bg-slate-600 text-white mt-2">
                                    ‚úï Chiudi
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col p-3 gap-3 bg-slate-900">
                    {/* HEADER */}
                    <div className="flex gap-2 shrink-0 h-12">
                        <a href="index.html" className="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded-xl font-bold flex items-center justify-center text-xl active:scale-95">üè†</a>
                        <div className="flex-1 flex items-center justify-center">
                            <h1 className="text-xl font-bold text-blue-400">‚úèÔ∏è CORRETTORE ITALIANO</h1>
                        </div>
                        <button onClick={reset} className="bg-red-600 hover:bg-red-500 text-white px-4 rounded-xl font-bold active:scale-95">üóëÔ∏è</button>
                    </div>

                    {/* AREA PRINCIPALE */}
                    <div className="flex-1 flex flex-col lg:flex-row gap-3 overflow-hidden">
                        
                        {/* EDITOR CON VISTA DOPPIA */}
                        <div className="flex-1 flex flex-col bg-slate-950 rounded-2xl border-2 border-slate-700 overflow-hidden relative">
                            <div className="p-2 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                                <span className="text-sm text-slate-400 font-bold">
                                    {viewMode === 'edit' ? 'üìù SCRIVI IL TUO TESTO' : 'üëÄ REVISIONE ERRORI'}
                                </span>
                                {viewMode === 'review' && (
                                    <button 
                                        onClick={() => setViewMode('edit')}
                                        className="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-lg text-white"
                                    >
                                        ‚úèÔ∏è Torna a modificare
                                    </button>
                                )}
                            </div>
                            
                            {viewMode === 'edit' ? (
                                <textarea 
                                    ref={textareaRef}
                                    value={text} 
                                    onChange={e => setText(e.target.value)} 
                                    className="editor-area flex-1 bg-slate-950 p-4 text-white outline-none resize-none"
                                    placeholder="Scrivi qui il tuo testo..."
                                />
                            ) : (
                                <div className="flex-1 bg-slate-900 overflow-y-auto">
                                    {renderHighlightedText()}
                                </div>
                            )}

                            <div className="p-2 bg-slate-800 border-t border-slate-700 flex gap-2">
                                <button 
                                    onClick={handleCheck} 
                                    disabled={loading || !text.trim()} 
                                    className="flex-1 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 text-white font-bold py-3 rounded-xl active:scale-95 transition-all"
                                >
                                    {loading ? '‚è≥ CONTROLLO...' : (viewMode === 'edit' ? 'üîç CONTROLLA' : 'üîÑ RICONTROLLA')}
                                </button>
                            </div>
                        </div>

                        {/* RISULTATI A LATO */}
                        {errors !== null && (
                            <div className="w-full lg:w-80 flex flex-col bg-slate-800 rounded-2xl border-2 border-slate-600 overflow-hidden animate-fade-in">
                                <div className="p-3 bg-slate-700 border-b border-slate-600 flex justify-between items-center">
                                    <span className="font-bold text-yellow-400">
                                        {errors.length === 0 ? '‚úÖ PERFETTO!' : `‚ö†Ô∏è ERRORI (${errors.length})`}
                                    </span>
                                    {errors.length > 0 && (
                                        <button 
                                            onClick={fixAll}
                                            className="bg-green-600 text-white text-sm px-3 py-1 rounded-lg font-bold active:scale-95"
                                        >
                                            Correggi tutti
                                        </button>
                                    )}
                                </div>
                                
                                <div className="scroll-area p-3">
                                    {errors.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center py-8 text-center">
                                            <div className="text-5xl mb-3">üéâ</div>
                                            <p className="text-green-400 font-bold text-lg">Nessun errore trovato!</p>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col gap-3">
                                            {errors.map((e, i) => (
                                                <div key={i} className="error-card bg-slate-900 p-3 rounded-xl border border-slate-700">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className={`${getErrorBadgeClass(e.type)} text-white text-xs px-2 py-1 rounded font-bold`}>
                                                            {getErrorLabel(e.type)}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-red-400 line-through decoration-wavy">{e.original}</span>
                                                        <span className="text-slate-500">‚Üí</span>
                                                        <span 
                                                            className="text-green-400 font-bold cursor-pointer"
                                                            onClick={() => fixError(i)}
                                                        >
                                                            {e.correction}
                                                        </span>
                                                    </div>
                                                    <div className="text-sm text-slate-400 bg-slate-800 p-2 rounded-lg">
                                                        üí° {e.explanation}
                                                    </div>
                                                    <button 
                                                        onClick={() => fixError(i)}
                                                        className="w-full mt-2 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg text-sm active:scale-95"
                                                    >
                                                        ‚úì Applica correzione
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* PULSANTI AZIONE */}
                                <div className="p-3 bg-slate-700 border-t border-slate-600 flex gap-2">
                                    <button 
                                        onClick={() => speak(errors.length === 0 ? "Nessun errore trovato!" : `Hai ${errors.length} errori.`)}
                                        className="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 rounded-xl text-sm active:scale-95"
                                    >
                                        üîä Leggi
                                    </button>
                                    <button 
                                        onClick={() => setShowShareMenu(true)}
                                        className="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-xl text-sm active:scale-95"
                                    >
                                        üì§ Condividi
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* MENU CONDIVISIONE */}
                    {renderShareMenu()}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script src="game-system.js"></script>
</body>
</html>