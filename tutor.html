<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor AI - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FONT OPENDYSLEXIC -->
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">

    <style>
        * {
            letter-spacing: 0.03em;
            word-spacing: 0.08em;
        }

        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body { 
            background-color: #0a0e17; 
            color: white; 
            font-family: 'OpenDyslexic', Verdana, sans-serif; 
            line-height: 1.6;
        }
        
        /* Chat Styles */
        .msg-bubble { 
            padding: 18px; 
            border-radius: 20px; 
            max-width: 85%; 
            font-size: 1.1rem; 
            line-height: 1.8; 
            animation: popIn 0.3s ease-out; 
        }
        .msg-user { 
            background: #166534; 
            margin-left: auto; 
            border-top-right-radius: 4px; 
            border: 2px solid #4ade80; 
        }
        .msg-ai { 
            background: #4c1d95; 
            margin-right: auto; 
            border-top-left-radius: 4px; 
            border: 2px solid #a78bfa; 
        }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .mic-active { background-color: #ef4444 !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } 
        }

        /* Pulsanti rapidi */
        .quick-btn {
            background: linear-gradient(135deg, #1e293b, #334155);
            border: 2px solid #475569;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.95rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quick-btn:active {
            transform: scale(0.95);
            background: #475569;
        }

        /* Controllo velocit√† */
        .speed-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 8px;
            border-radius: 5px;
            background: #475569;
            outline: none;
        }
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #a78bfa;
            cursor: pointer;
        }

        /* Topic badge */
        .topic-badge {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 2px solid #a78bfa;
            animation: glow 2s infinite;
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(167, 139, 250, 0.3); }
            50% { box-shadow: 0 0 20px rgba(167, 139, 250, 0.6); }
        }

        /* Speaking indicator */
        .speaking-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .speaking-dot {
            width: 8px;
            height: 8px;
            background: #a78bfa;
            border-radius: 50%;
            animation: bounce 0.6s infinite;
        }
        .speaking-dot:nth-child(2) { animation-delay: 0.1s; }
        .speaking-dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* AREA CHAT SCROLLABILE - FIX */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const MODEL = "gemini-3-pro-preview";

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        // PROMPT AGGIORNATO PER RAGAZZO (non bambino)
        const SYSTEM_PROMPT = `Sei un Tutor simpatico ed empatico per un ragazzo con DSA.

LINEE GUIDA PER IL TUO STILE:
1. **Tono Umano:** Sii gentile e incoraggiante. Usa frasi come "Ottima domanda!", "Ora ti spiego", "Non preoccuparti".
2. **Chiarezza:** Usa frasi brevi ma complete (Soggetto -> Verbo). Evita parole difficili.
3. **Elenchi Puntati:** Usali SOLO se devi elencare 3 o pi√π cose. Altrimenti usa frasi discorsive.
4. **Lunghezza:** Risposte brevi (massimo 50-60 parole) per non stancare la lettura.
5. **Esempi:** Fai esempi legati alla vita reale (basket, amici, natura).

Esempio di stile giusto:
"La fotosintesi √® il modo in cui le piante mangiano. Immagina che cucinino usando il sole e l'acqua come ingredienti! üåø Cos√¨ crescono forti e ci regalano l'ossigeno."

Obiettivo: Spiegare concetti difficili in modo semplice e amichevole. Rispondi sempre in italiano.`;

        const chatWithAI = async (history, msg, isQuizRequest = false) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            
            let finalMsg = msg;
            if(isQuizRequest) {
                finalMsg = `Basandoti su quello che abbiamo discusso, fammi UNA domanda per verificare se ho capito. 
                La domanda deve essere chiara, con risposta breve.
                Dopo che rispondo, dimmi se √® giusto o sbagliato.`;
            }

            const systemContents = {
                role: "user",
                parts: [{ text: SYSTEM_PROMPT }]
            };

            const modelAck = {
                role: "model", 
                parts: [{ text: "Capito! Sar√≤ un tutor chiaro e user√≤ esempi adatti a un ragazzo. üëç" }]
            };

            const userContents = history.map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.text }]
            }));

            const contents = [systemContents, modelAck, ...userContents, { role: 'user', parts: [{ text: finalMsg }] }];

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents })
            });
            
            if(!res.ok) throw new Error("Errore Chat");
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        const App = () => {
            const [messages, setMessages] = useState([{ 
                role: 'model', 
                text: "Ciao! üëã\n\nSono maurin, il tuo Tutor.\n\nCosa devi studiare oggi?\n\nScrivi o usa i pulsanti qui sotto! üí™" 
            }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [speechRate, setSpeechRate] = useState(0.85);
            const [currentTopic, setCurrentTopic] = useState(null);
            const chatRef = useRef(null);
            const endRef = useRef(null);
            const recognitionRef = useRef(null);

            useEffect(() => {
                if(endRef.current) {
                    endRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            // Pulizia testo per sintesi vocale
            const cleanTextForSpeech = (text) => {
                return text
                    .replace(/[*#_`~]/g, '')
                    .replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                    .replace(/[\u{2600}-\u{26FF}]/gu, '')
                    .replace(/[\u{2700}-\u{27BF}]/gu, '')
                    .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                    .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                    .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                    .replace(/\n+/g, '. ')
                    .replace(/\.+/g, '.')
                    .trim();
            };

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const cleanText = cleanTextForSpeech(text);
                const u = new SpeechSynthesisUtterance(cleanText);
                u.lang = 'it-IT'; 
                u.rate = speechRate;
                u.pitch = 1.0;
                
                u.onstart = () => setIsSpeaking(true);
                u.onend = () => setIsSpeaking(false);
                u.onerror = () => setIsSpeaking(false);
                
                window.speechSynthesis.speak(u);
            };

            const stopSpeaking = () => {
                window.speechSynthesis.cancel();
                setIsSpeaking(false);
            };

            const toggleMic = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("Usa Google Chrome per il microfono!");
                
                if(isListening && recognitionRef.current) {
                    recognitionRef.current.stop();
                    return;
                }

                const recognition = new SpeechRecognition();
                recognitionRef.current = recognition;
                recognition.lang = 'it-IT';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    setInput(prev => (prev + " " + transcript).trim());
                };
                
                recognition.start();
            };

            const send = async (customMsg = null, isQuiz = false) => {
                const msgToSend = customMsg || input.trim();
                if(!msgToSend || loading) return;
                
                const newHist = [...messages, { role: 'user', text: msgToSend }];
                setMessages(newHist); 
                setInput(''); 
                setLoading(true);
                stopSpeaking();

                // Rileva argomento dalla prima domanda sostanziale
                if(!currentTopic && messages.length <= 2 && msgToSend.length > 10) {
                    const words = msgToSend.split(' ').slice(0, 4).join(' ');
                    setCurrentTopic(words.charAt(0).toUpperCase() + words.slice(1));
                }

                try {
                    const reply = await chatWithAI(messages, msgToSend, isQuiz);
                    setMessages([...newHist, { role: 'model', text: reply }]);
                    speak(reply);
                    DB.addXP(isQuiz ? 20 : 10);
                } catch(e) { 
                    setMessages([...newHist, { role: 'model', text: "‚ùå Ops! Qualcosa non ha funzionato. Riprova!" }]); 
                }
                setLoading(false);
            };

            const quickActions = [
                { label: "ü§î Spiegami meglio", msg: "Non ho capito bene, puoi spiegarmelo in modo pi√π semplice con un esempio?" },
                { label: "üìù Esempio", msg: "Puoi farmi un esempio pratico dalla vita reale?" },
                { label: "‚úÖ √à giusto?", msg: "Ho capito bene? Dimmi se √® corretto." },
                { label: "üéØ Quiz!", msg: null, isQuiz: true },
            ];

            const handleQuickAction = (action) => {
                if(action.isQuiz) {
                    send("Fammi una domanda per vedere se ho capito!", true);
                } else {
                    send(action.msg);
                }
            };

            const resetChat = () => {
                if(confirm("Vuoi iniziare una nuova lezione?")) {
                    stopSpeaking();
                    setMessages([{ 
                        role: 'model', 
                        text: "Ok, ricominciamo! üîÑ\n\nCosa vuoi studiare adesso?" 
                    }]);
                    setCurrentTopic(null);
                }
            };

            // Scroll to top della chat
            const scrollToTop = () => {
                if(chatRef.current) {
                    chatRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            return (
                <div className="chat-container bg-slate-900">
                    {/* HEADER FISSO */}
                    <div className="flex-shrink-0 p-3 bg-slate-800 border-b border-slate-700 flex items-center gap-3 shadow-lg z-10">
                        <a href="index.html" className="bg-slate-700 hover:bg-slate-600 px-4 py-3 rounded-xl text-white font-bold text-lg active:scale-95 transition-transform">
                            üè† Menu
                        </a>
                        
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-3">
    						<img src="maurin-avatar.jpg" alt="Maurin" className="w-12 h-12 rounded-full border-2 border-purple-400" />
    						<div className="font-bold text-purple-400 text-lg">MAURIN üéì</div>
						</div>
                            {currentTopic && (
                                <div className="topic-badge inline-block mt-1 truncate max-w-[150px]">
                                    üìö {currentTopic}
                                </div>
                            )}
                        </div>

                        {/* Controllo velocit√† */}
                        <div className="hidden sm:flex items-center gap-2 bg-slate-700 px-3 py-2 rounded-xl">
                            <span className="text-xs text-slate-400">üê¢</span>
                            <input 
                                type="range" 
                                min="0.6" 
                                max="1.1" 
                                step="0.05"
                                value={speechRate}
                                onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
                                className="speed-slider"
                            />
                            <span className="text-xs text-slate-400">üêá</span>
                        </div>

                        <button 
                            onClick={resetChat}
                            className="bg-red-600 hover:bg-red-500 px-3 py-3 rounded-xl text-white font-bold active:scale-95 transition-transform"
                        >
                            üîÑ
                        </button>
                    </div>

                    {/* CHAT AREA SCROLLABILE */}
                    <div className="chat-messages space-y-4" ref={chatRef}>
                        {messages.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role==='user'?'items-end':'items-start'}`}>
                                <div className={`msg-bubble ${m.role==='user'?'msg-user':'msg-ai'}`}>
                                    {m.text.split('\n').map((line, j) => (
                                        <p key={j} className={line ? '' : 'h-2'}>{line}</p>
                                    ))}
                                </div>
                                {m.role==='model' && (
                                    <button 
                                        onClick={() => speak(m.text)} 
                                        className="text-xs text-slate-500 mt-1 ml-2 hover:text-purple-400 active:scale-95"
                                    >
                                        üîä Rileggi
                                    </button>
                                )}
                            </div>
                        ))}
                        
                        {loading && (
                            <div className="flex items-center gap-3 text-purple-400 p-4">
                                <div className="speaking-indicator">
                                    <div className="speaking-dot"></div>
                                    <div className="speaking-dot"></div>
                                    <div className="speaking-dot"></div>
                                </div>
                                <span>Sto pensando...</span>
                            </div>
                        )}
                        <div ref={endRef}></div>
                    </div>

                    {/* PULSANTE TORNA SU (appare se ci sono molti messaggi) */}
                    {messages.length > 3 && (
                        <button 
                            onClick={scrollToTop}
                            className="absolute right-4 bottom-48 bg-slate-700 hover:bg-slate-600 p-3 rounded-full shadow-lg z-20 active:scale-95"
                        >
                            ‚¨ÜÔ∏è
                        </button>
                    )}

                    {/* PULSANTI RAPIDI */}
                    <div className="flex-shrink-0 px-4 py-2 bg-slate-800/80 border-t border-slate-700 flex gap-2 overflow-x-auto">
                        {quickActions.map((action, i) => (
                            <button
                                key={i}
                                onClick={() => handleQuickAction(action)}
                                disabled={loading}
                                className="quick-btn"
                            >
                                {action.label}
                            </button>
                        ))}
                    </div>

                    {/* INPUT AREA */}
                    <div className="flex-shrink-0 p-3 bg-slate-800 border-t border-slate-700 flex gap-2 items-center">
                        {/* Microfono */}
                        <button 
                            onClick={toggleMic} 
                            className={`p-4 rounded-xl text-xl ${isListening ? 'mic-active text-white' : 'bg-slate-700 text-slate-300'} active:scale-95 transition-transform`}
                        >
                            üé§
                        </button>

                        {/* Stop voce */}
                        {isSpeaking && (
                            <button 
                                onClick={stopSpeaking}
                                className="p-4 rounded-xl bg-red-600 text-white text-xl animate-pulse active:scale-95"
                            >
                                ‚èπÔ∏è
                            </button>
                        )}

                        {/* Input */}
                        <input 
                            value={input} 
                            onChange={e => setInput(e.target.value)} 
                            onKeyDown={e => e.key === 'Enter' && send()} 
                            className="flex-1 bg-slate-900 border-2 border-slate-600 rounded-xl p-4 text-white outline-none text-lg focus:border-purple-500 min-w-0"
                            placeholder="Scrivi o parla..." 
                        />

                        {/* Invia */}
                        <button 
                            onClick={() => send()} 
                            disabled={loading || !input.trim()} 
                            className="bg-purple-600 hover:bg-purple-500 disabled:bg-slate-600 text-white p-4 rounded-xl font-bold text-xl active:scale-95 transition-transform"
                        >
                            ‚û§
                        </button>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
	<script src="game-system.js"></script>
</body>

</html>

