<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor AI - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0a0e17; color: white; font-family: 'Verdana', sans-serif; height: 100dvh; overflow: hidden; }
        
        /* Chat Styles */
        .msg-bubble { padding: 15px; border-radius: 20px; max-width: 85%; font-size: 1.1rem; line-height: 1.6; animation: popIn 0.3s ease-out; }
        .msg-user { background: #166534; margin-left: auto; border-top-right-radius: 4px; border: 2px solid #4ade80; }
        .msg-ai { background: #4c1d95; margin-right: auto; border-top-left-radius: 4px; border: 2px solid #a78bfa; }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .mic-active { background-color: #ef4444 !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const MODEL = "gemini-2.0-flash"; // Stabile

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                return next;
            }
        };

        const chatWithAI = async (history, msg) => {
            const key = DB.getKey();
            if(!key) throw new Error("Manca API Key!");
            
            const systemContents = {
                role: "user",
                parts: [{ text: "Sei un Tutor per un bambino di 9 anni. Rispondi in modo semplice, breve e usa emoji. Dividi il testo in paragrafi corti." }]
            };

            const userContents = history.map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.text }]
            }));

            const contents = [systemContents, ...userContents, { role: 'user', parts: [{ text: msg }] }];

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents })
            });
            
            if(!res.ok) throw new Error("Errore Chat");
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        const App = () => {
            const [messages, setMessages] = useState([{ role: 'model', text: "Ciao! üëã Sono il tuo Tutor. Cosa studiamo oggi?" }]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
                u.lang = 'it-IT'; u.rate = 0.95;
                window.speechSynthesis.speak(u);
            };

            const toggleMic = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("Usa Google Chrome per il microfono!");
                
                const recognition = new SpeechRecognition();
                recognition.lang = 'it-IT';
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (e) => setInput(prev => prev + " " + e.results[0][0].transcript);
                
                if (isListening) recognition.stop(); else recognition.start();
            };

            const send = async () => {
                if(!input.trim() || loading) return;
                const userMsg = input.trim();
                const newHist = [...messages, { role: 'user', text: userMsg }];
                setMessages(newHist); setInput(''); setLoading(true);

                try {
                    const reply = await chatWithAI(messages, userMsg);
                    setMessages([...newHist, { role: 'model', text: reply }]);
                    speak(reply);
                    DB.addXP(10);
                } catch(e) { setMessages([...newHist, { role: 'model', text: "‚ùå " + e.message }]); }
                setLoading(false);
            };

            return (
                <div className="h-full flex flex-col bg-slate-900">
                    <div className="p-4 bg-slate-800 border-b border-slate-700 flex items-center gap-4 shadow-lg z-10">
                        <a href="index.html" className="bg-slate-700 px-4 py-2 rounded-xl text-white font-bold text-xl">üè†</a>
                        <div>
                            <div className="font-bold text-purple-400 text-lg">TUTOR AI</div>
                            <div className="text-xs text-slate-400">Il tuo assistente di studio</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role==='user'?'items-end':'items-start'}`}>
                                <div className={`msg-bubble ${m.role==='user'?'msg-user':'msg-ai'}`}>{m.text}</div>
                                {m.role==='model' && <button onClick={()=>speak(m.text)} className="text-xs text-slate-500 mt-1 ml-2">üîä Rileggi</button>}
                            </div>
                        ))}
                        {loading && <div className="text-purple-400 animate-pulse p-4">Sto pensando... üß†</div>}
                        <div ref={endRef}></div>
                    </div>

                    <div className="p-4 bg-slate-800 border-t border-slate-700 flex gap-2 items-center">
                        <button onClick={toggleMic} className={`p-4 rounded-xl ${isListening?'mic-active text-white':'bg-slate-700 text-slate-300'}`}>üé§</button>
                        <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} className="flex-1 bg-slate-900 border border-slate-600 rounded-xl p-4 text-white outline-none text-lg" placeholder="Chiedi pure..." />
                        <button onClick={send} disabled={loading} className="bg-purple-600 text-white p-4 rounded-xl font-bold">‚û§</button>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>