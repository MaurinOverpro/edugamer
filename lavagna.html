<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lavagna AI - EduGamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #0a0e17; color: white; font-family: 'Verdana', sans-serif; height: 100dvh; overflow: hidden; }
        
        /* --- SCROLL AREA & CANVAS --- */
        .scroll-container {
            width: 100%;
            height: 100%;
            overflow: auto; /* Abilita lo scroll */
            position: relative;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 40px 40px; /* Griglia di sfondo per orientarsi */
            cursor: grab;
        }
        .scroll-container:active { cursor: grabbing; }

        .big-canvas {
            width: 2500px; /* Tela gigante */
            height: 2500px;
            position: relative;
        }

        /* --- STILI NODI --- */
        .node-base {
            position: absolute;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 15px; border-radius: 20px;
            cursor: pointer; z-index: 20;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            user-select: none;
        }
        .node-base:hover { transform: scale(1.1); z-index: 50; box-shadow: 0 0 25px rgba(74, 222, 128, 0.6); }
        
        .node-central { 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); 
            border: 4px solid #60a5fa; width: 200px; height: 200px; border-radius: 50%;
            font-size: 1.3rem; font-weight: bold;
        }
        
        .node-satellite { 
            background: linear-gradient(135deg, #1e293b, #0f172a); 
            border: 2px solid #94a3b8; width: 180px; min-height: 110px; 
            font-size: 1rem;
        }
        
        .node-satellite.active { border-color: #facc15; background: #422006; } /* Selezione Gialla */
        .node-satellite.connected { border-color: #4ade80; background: #064e3b; } /* Collegamento Verde */

        /* Linea Neon */
        .neon-line {
            stroke-dasharray: 1000; stroke-dashoffset: 1000;
            animation: draw 1s forwards;
            filter: drop-shadow(0 0 5px #4ade80);
        }
        @keyframes draw { to { stroke-dashoffset: 0; } }

        /* Loading Spinner per AI */
        .ai-thinking {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95); border: 2px solid #a855f7;
            padding: 10px 20px; border-radius: 30px; color: #e9d5ff;
            display: flex; align-items: center; gap: 10px; z-index: 100;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        /* Pulsante Upload Gigante */
        .btn-upload-big {
            background: linear-gradient(45deg, #3b82f6, #2563eb);
            border: 2px solid #60a5fa;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transition: all 0.3s ease;
        }
        .btn-upload-big:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const MODEL = "gemini-2.0-flash"; // Veloce per la voce in tempo reale

        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            addXP: (amount) => {
                const next = parseInt(localStorage.getItem('edu_xp') || '0') + amount;
                localStorage.setItem('edu_xp', next.toString());
                return next;
            },
            save: (data) => localStorage.setItem('lavagna_data_v4', JSON.stringify(data)),
            load: () => JSON.parse(localStorage.getItem('lavagna_data_v4') || 'null'),
            clear: () => localStorage.removeItem('lavagna_data_v4')
        };

        // --- GESTIONE AI ---
        const AI = {
            // Analisi Iniziale (Mappa)
            analyzeMap: async (images) => {
                const key = DB.getKey();
                if(!key) throw new Error("Manca API Key! Vai su Home.");
                const parts = images.map(img => ({ inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }));
                
                const prompt = `Analizza queste pagine per un bambino DSA.
                1. TEMA PRINCIPALE.
                2. 5-7 CONCETTI CHIAVE.
                3. SPIEGAZIONE BREVE (max 15 parole) per ognuno.
                Rispondi SOLO JSON: { "theme": "Titolo", "nodes": [{ "id": 1, "label": "Nome", "content": "Spiegazione" }] }`;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...parts] }] })
                });
                const data = await res.json();
                let text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                return JSON.parse(text);
            },

            // Sintesi Vocale del Collegamento
            synthesizeConnection: async (label1, label2) => {
                const key = DB.getKey();
                if(!key) return `Hai collegato ${label1} con ${label2}`;

                const prompt = `Un bambino ha appena collegato il concetto "${label1}" con "${label2}" sulla lavagna.
                Spiega in UNA frase semplicissima qual Ã¨ il legame tra i due. Usa un tono incoraggiante.`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    return data.candidates[0].content.parts[0].text;
                } catch(e) {
                    return `Hai collegato ${label1} con ${label2}!`;
                }
            }
        };

        const App = () => {
            const [stage, setStage] = useState('upload');
            const [images, setImages] = useState([]);
            const [mapData, setMapData] = useState(null);
            const [nodes, setNodes] = useState([]);
            const [lines, setLines] = useState([]); // Linee fatte dall'utente