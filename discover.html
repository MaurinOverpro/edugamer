<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISCOVER v3.5 - Debug Panel</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --error: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Header & Navigation */
        .header { text-align: center; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; position: relative; }
        .back-btn { position: absolute; left: 15px; top: 20px; background: white; color: var(--primary); border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; transition: 0.3s; }
        .back-btn:hover { transform: scale(1.05); }
        .xp-bar-bg { background: rgba(0,0,0,0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 15px; }
        .xp-bar-fill { background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; width: 0%; transition: width 0.5s; }

        /* Sticky Problem Box - MIGLIORATO */
        #sticky-problem { 
            background: white; 
            color: #1e293b; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-left: 6px solid var(--primary); 
            display: none; 
            position: sticky; 
            top: 10px; 
            z-index: 100; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        #sticky-problem h4 { 
            color: var(--primary); 
            font-size: 11px; 
            text-transform: uppercase; 
            margin-bottom: 5px; 
            opacity: 0.8; 
        }
        
        /* Problem Type Badges - COLORI DINAMICI */
        .type-badge { 
            display: inline-block; 
            padding: 6px 14px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .type-trasformazione { background: #dbeafe; color: #1e40af; }
        .type-compravendita { background: #fef3c7; color: #92400e; }
        .type-combinazione { background: #d1fae5; color: #065f46; }
        .type-generico { background: #f3e8ff; color: #6b21a8; }

        /* Cards */
        .card { 
            background: white; 
            color: #1e293b; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
            margin-bottom: 20px; 
            display: none; 
            animation: slideUp 0.4s ease; 
        }
        .active { display: block; }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .step-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 10px; 
        }
        .step-num { 
            background: var(--primary); 
            color: white; 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            margin-right: 12px; 
        }
        
        /* Form Elements */
        textarea, input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            margin-top: 8px; 
            font-size: 16px; 
            transition: 0.3s; 
        }
        textarea:focus, input:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1); 
        }
        .btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 20px; 
            transition: 0.3s; 
        }
        .btn:hover { 
            transform: translateY(-2px); 
            filter: brightness(1.1); 
        }
        
        .feedback { 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 15px; 
            font-weight: bold; 
            display: none; 
        }
        .hint { 
            background: #fffbeb; 
            color: #92400e; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 10px; 
            font-size: 14px; 
            border-left: 4px solid #f59e0b; 
            display: none; 
        }

        /* Question Blocks - STILE PULITO */
        .question-block { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #f8fafc; 
            border-radius: 10px; 
            border-left: 3px solid var(--primary); 
        }
        .question-block label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 8px; 
            color: #334155; 
        }

        /* Calculator */
        .calc-toggle { 
            position: fixed; 
            bottom: 25px; 
            right: 25px; 
            width: 60px; 
            height: 60px; 
            background: white; 
            color: var(--primary); 
            border: none; 
            border-radius: 50%; 
            cursor: pointer; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
            font-size: 24px; 
            z-index: 1000; 
            transition: 0.3s; 
        }
        .calc-toggle:hover { 
            transform: scale(1.1); 
        }
        .calc-popup { 
            position: fixed; 
            bottom: 95px; 
            right: 25px; 
            width: 260px; 
            background: white; 
            padding: 15px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
            display: none; 
            z-index: 1000; 
            color: #1e293b; 
        }
        .calc-screen { 
            background: #1e293b; 
            color: #00ff88; 
            padding: 10px; 
            text-align: right; 
            font-size: 22px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            min-height: 50px; 
            font-family: monospace; 
        }
        .calc-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 6px; 
        }
        .c-btn { 
            padding: 12px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            background: #f1f5f9; 
            transition: 0.2s; 
        }
        .c-btn:hover { 
            background: #cbd5e1; 
            transform: scale(1.05); 
        }
        .c-btn.op { 
            background: var(--primary); 
            color: white; 
        }
        
        /* Debug Button */
        .debug-btn {
            position: fixed;
            bottom: 100px;
            right: 25px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            z-index: 1000;
            transition: 0.3s;
        }
        .debug-btn:hover {
            transform: scale(1.05);
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #1e293b;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
            z-index: 2000;
            display: none;
        }
        .debug-panel h3 {
            color: #ef4444;
            margin-bottom: 20px;
        }
        .debug-panel pre {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            overflow: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .debug-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="matematica.html" class="back-btn">‚Üê Home</a>
        <h1>üîç DISCOVER v3.5</h1>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-bar"></div></div>
        <p style="margin-top:8px; font-size: 12px;">LIVELLO <span id="lvl">1</span> ‚Ä¢ <span id="xp">0</span> XP</p>
    </div>

    <div id="sticky-problem">
        <h4>PROBLEMA ATTIVO</h4>
        <div id="problem-type-container"></div>
        <div id="sticky-text" style="font-weight: 500; font-size: 15px;"></div>
    </div>

    <div class="card active" id="step1">
        <div class="step-header"><div class="step-num">1</div><h2>Analisi Problema</h2></div>
        <textarea id="p-input" rows="5" placeholder="Marco ha 6 mele, Anna ne ha 8..."></textarea>
        <button class="btn" onclick="analizza()">Analizza con AI ‚ú®</button>
    </div>

    <div id="loader" style="display:none; text-align:center; padding:30px;">
        <div style="border:4px solid white; border-top:4px solid transparent; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto;"></div>
        <p style="color:white; margin-top:15px;">L'AI sta scomponendo i passaggi per ogni personaggio...</p>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>

    <div class="card" id="step2">
        <div class="step-header"><div class="step-num">2</div><h2>I Numeri</h2></div>
        <p>Scrivi <strong>TUTTI</strong> i numeri che trovi nel testo (anche decimali), separati da virgola:</p>
        <input type="text" id="ans2" placeholder="Es: 6, 8, 2  oppure  3, 0.80, 4, 0.90">
        <button class="btn" onclick="check2()">Verifica ‚úì</button>
        <div class="feedback" id="f2"></div>
    </div>

    <div class="card" id="step3">
        <div class="step-header"><div class="step-num">3</div><h2>Comprensione</h2></div>
        <div id="q3-list"></div>
        <button class="btn" onclick="check3()">Avanti ‚úì</button>
        <div class="feedback" id="f3"></div>
    </div>

    <div class="card" id="step4">
        <div class="step-header"><div class="step-num">4</div><h2>Calcoli Sequenziali</h2></div>
        <div id="q4-list"></div>
        <button class="btn" onclick="check4()">Verifica Calcoli ‚úì</button>
        <div class="feedback" id="f4"></div>
    </div>

    <div class="card" id="step5">
        <div class="step-header"><div class="step-num">5</div><h2>Risposte Finali</h2></div>
        <div id="q5-list"></div>
        <button class="btn" onclick="check5()">Fine üéØ</button>
        <div class="feedback" id="f5"></div>
    </div>
</div>

<button class="calc-toggle" onclick="toggleCalc()">üî¢</button>
<button class="debug-btn" onclick="showDebugPanel()">üêõ DEBUG</button>

<div class="calc-popup" id="calc-box">
    <div class="calc-screen" id="c-screen">0</div>
    <div class="calc-grid" id="c-btns"></div>
</div>

<div class="debug-panel" id="debug-panel">
    <button class="debug-close" onclick="closeDebugPanel()">‚úï</button>
    <h3>üêõ INFORMAZIONI DEBUG</h3>
    <div id="debug-content"></div>
</div>

<script>
let state = { data: null, xp: 0, attempts: {}, testo: "", tipo: "" };
let cVal = "";

const API_KEY = localStorage.getItem('gemini_api_key') || prompt("Inserisci la tua API Key Gemini:");
if(API_KEY) localStorage.setItem('gemini_api_key', API_KEY);

// Calculator functions
function toggleCalc() { 
    const b = document.getElementById('calc-box'); 
    b.style.display = b.style.display === 'block' ? 'none' : 'block'; 
}

function buildCalc() { 
    const g = document.getElementById('c-btns'); 
    const keys = ['C','/','*','-','7','8','9','+','4','5','6','=','1','2','3','0','.']; 
    g.innerHTML = keys.map(k => `<button class="c-btn ${isNaN(k)&&k!=='.'?'op':''}" onclick="doCalc('${k}')">${k}</button>`).join(''); 
}

function doCalc(k) { 
    const s = document.getElementById('c-screen'); 
    if(k === 'C') {
        cVal = ""; 
    } else if(k === '=') { 
        try { 
            const result = eval(cVal);
            // Arrotonda a 2 decimali per evitare errori floating-point
            cVal = (Math.round(result * 100) / 100).toString(); 
        } catch { 
            cVal = "Error"; 
        } 
    } else {
        cVal += k; 
    }
    s.textContent = cVal || "0"; 
}

// Main analysis function
async function analizza() {
    state.testo = document.getElementById('p-input').value.trim();
    if(!state.testo) {
        alert("‚ö†Ô∏è Scrivi prima un problema!");
        return;
    }
    
    document.getElementById('step1').classList.remove('active');
    document.getElementById('loader').style.display = 'block';

    // PROMPT OTTIMIZZATO - Via di mezzo tra lungo e corto
    const prompt = `Analizza questo problema matematico per bambini delle elementari: "${state.testo}".

CLASSIFICAZIONE TIPO:
- TRASFORMAZIONE: situazione iniziale ‚Üí azioni sequenziali ‚Üí risultato finale
- COMPRAVENDITA: acquisti con calcolo totale/resto
- COMBINAZIONE: somma di insiemi gi√† formati
- GENERICO: altri tipi di problema

REGOLE MULTI-PERSONAGGIO:
- Se ci sono pi√π personaggi (es. Marco, Anna, Carlo), crea domande separate per ognuno
- Se un personaggio regala E riceve, separa in due calcoli nello step "calcoli"
- Se il problema chiede pi√π domande (es: "Quante ne ha Anna? Quante ne ha Marco?"), includi tutte le risposte

REGOLE NUMERI:
- In "numeri" inserisci TUTTI i numeri del testo come stringhe separate
- Includi decimali (es: "0.80", "15.5")
- Conta ogni numero separatamente: "3 penne a 0.80‚Ç¨" = DUE numeri ["3", "0.80"]
- NON includere simboli (‚Ç¨, $, ecc.)

ESEMPIO MINIMO:
{
  "tipo": "TRASFORMAZIONE",
  "numeri": ["6", "8", "2"],
  "logica": [{"q": "Chi √® il protagonista?", "a": "Marco", "t": "text"}],
  "calcoli": [{"q": "Mele dopo aver ricevuto:", "a": "8", "t": "number"}],
  "risposte": [{"q": "Mele finali di Marco:", "a": "8", "t": "number"}]
}

Rispondi ESCLUSIVAMENTE con JSON valido (NO markdown, NO backticks).
STRUTTURA OBBLIGATORIA:
{
  "tipo": "TRASFORMAZIONE|COMPRAVENDITA|COMBINAZIONE|GENERICO",
  "numeri": ["array", "di", "stringhe"],
  "logica": [{"q": "domanda", "a": "risposta", "t": "text|number"}],
  "calcoli": [{"q": "domanda", "a": "risposta", "t": "number"}],
  "risposte": [{"q": "domanda", "a": "risposta", "t": "number"}]
}`;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
            method: 'POST', 
            body: JSON.stringify({ 
                contents: [{ 
                    parts: [{ text: prompt }] 
                }] 
            })
        });
        
        if (!resp.ok) {
            throw new Error(`API Error: ${resp.status}`);
        }
        
        const res = await resp.json();
        
        if (!res.candidates || !res.candidates[0]) {
            throw new Error("Risposta API non valida");
        }
        
        let raw = res.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        state.data = JSON.parse(raw);
        state.tipo = state.data.tipo || "GENERICO";
        
        // Update sticky problem with DYNAMIC COLORED BADGE
        document.getElementById('sticky-text').textContent = state.testo;
        
        const badgeMap = {
            "TRASFORMAZIONE": { class: "type-trasformazione", icon: "üîÑ" },
            "COMPRAVENDITA": { class: "type-compravendita", icon: "üõí" },
            "COMBINAZIONE": { class: "type-combinazione", icon: "‚ûï" },
            "GENERICO": { class: "type-generico", icon: "üìù" }
        };
        
        const badge = badgeMap[state.tipo] || badgeMap["GENERICO"];
        document.getElementById('problem-type-container').innerHTML = 
            `<div class="type-badge ${badge.class}">${badge.icon} ${state.tipo}</div>`;
        
        document.getElementById('sticky-problem').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
        showStep(2);
        updateXP(10);
        
    } catch(e) { 
        document.getElementById('loader').style.display = 'none';
        document.getElementById('step1').classList.add('active');
        alert("‚ùå Errore AI: " + e.message + "\n\nControlla:\n- La tua API Key\n- La connessione internet\n- Il formato del problema"); 
    }
}

// Step navigation
function showStep(n) {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById(`step${n}`).classList.add('active');
    if(n === 3) renderQs('q3-list', state.data.logica, 's3');
    if(n === 4) renderQs('q4-list', state.data.calcoli, 's4');
    if(n === 5) renderQs('q5-list', state.data.risposte, 's5');
}

// Render questions
function renderQs(id, list, prefix) {
    document.getElementById(id).innerHTML = list.map((item, i) => `
        <div class="question-block">
            <label>${item.q}</label>
            <input type="text" id="${prefix}-${i}" autocomplete="off" placeholder="Scrivi la risposta...">
            <div id="hint-${prefix}-${i}" class="hint">üí° Riguarda il testo del problema in alto!</div>
        </div>
    `).join('');
}

// Validation function - NO CONSOLE VERSION (compatible with all environments)
function validate(val, exp, type) {
    if(!val) return false;
    
    // Normalizza input e expected
    let v = val.toString().toLowerCase().trim();
    let e = exp.toString().toLowerCase().trim();
    
    if(type === 'number') {
        // Rimuovi unit√† comuni prima del parsing
        const cleanV = v.replace(/euro|‚Ç¨|\$|cent|centesimi/gi, '').trim();
        const cleanE = e.replace(/euro|‚Ç¨|\$|cent|centesimi/gi, '').trim();
        
        // Sostituisci virgola con punto
        const normalizedV = cleanV.replace(',', '.');
        const normalizedE = cleanE.replace(',', '.');
        
        // Estrai SOLO numeri con decimali
        const vMatch = normalizedV.match(/\d+\.?\d*/);
        const eMatch = normalizedE.match(/\d+\.?\d*/);
        
        if(!vMatch || !eMatch) {
            return false;
        }
        
        let nV = parseFloat(vMatch[0]);
        let nE = parseFloat(eMatch[0]);
        
        // Tolleranza per gestire 1.6 vs 1.60 e piccoli errori floating-point
        const isValid = Math.abs(nV - nE) < 0.02;
        
        // DEBUG VISIVO: mostra nella pagina invece che in console
        if(!isValid && window.debugMode) {
            showDebugInfo(`‚ùå ${val} ‚â† ${exp} (diff: ${Math.abs(nV - nE).toFixed(4)})`);
        }
        
        return isValid;
    }
    
    // Per il testo: validazione flessibile
    return v.includes(e) || e.includes(v);
}

// Funzione per mostrare debug info nella pagina
function showDebugInfo(msg) {
    const debugDiv = document.getElementById('debug-info');
    if(debugDiv) {
        debugDiv.innerHTML += `<p style="font-size:12px; color:#dc2626;">${msg}</p>`;
        debugDiv.style.display = 'block';
    }
}

// Step 2: Check numbers (70% threshold)
function check2() {
    let input = document.getElementById('ans2').value;
    // Estrae numeri interi e decimali
    let found = input.match(/\d+(?:\.\d+)?/g) || [];
    let expected = state.data.numeri || [];
    
    // VALIDAZIONE PERMISSIVA: 70% dei numeri
    const threshold = Math.ceil(expected.length * 0.7);
    
    if(found.length >= threshold) { 
        showFeedback('f2', true, `‚úÖ Ottimo! Hai trovato ${found.length} numeri su ${expected.length} attesi.`); 
        setTimeout(() => showStep(3), 800); 
        updateXP(20); 
    } else { 
        showFeedback('f2', false, `‚ùå Cerca ancora! Dovresti trovarne almeno ${threshold}. (Hai trovato: ${found.length})`); 
    }
}

// Generic step handler
function handleStep(list, prefix, next, fId) {
    let ok = true;
    let firstError = -1;
    
    list.forEach((it, i) => {
        const userAnswer = document.getElementById(`${prefix}-${i}`).value;
        
        if(!validate(userAnswer, it.a, it.t)) {
            ok = false;
            if(firstError === -1) firstError = i;
            
            // Increment attempts and show hint after 2 tries
            state.attempts[prefix+i] = (state.attempts[prefix+i] || 0) + 1;
            if(state.attempts[prefix+i] >= 2) {
                document.getElementById(`hint-${prefix}-${i}`).style.display = 'block';
            }
        }
    });
    
    if(ok) { 
        showFeedback(fId, true, "‚úÖ Esatto! Tutte le risposte sono corrette!"); 
        updateXP(30); 
        setTimeout(() => next ? showStep(next) : fine(), 800); 
    } else { 
        showFeedback(fId, false, `‚ùå Controlla la risposta numero ${firstError + 1}!`); 
    }
}

// Step handlers
function check3() { handleStep(state.data.logica, 's3', 4, 'f3'); }
function check4() { handleStep(state.data.calcoli, 's4', 5, 'f4'); }
function check5() { handleStep(state.data.risposte, 's5', null, 'f5'); }

function fine() { 
    alert(`üéâ COMPLIMENTI!\n\nHai risolto il problema!\nTipo: ${state.tipo}\nXP totali guadagnati: ${state.xp}`); 
    location.reload(); 
}

// Feedback display
function showFeedback(id, ok, msg) {
    const f = document.getElementById(id); 
    f.style.display = 'block';
    f.style.background = ok ? '#d1fae5' : '#fee2e2'; 
    f.style.color = ok ? '#065f46' : '#991b1b'; 
    f.textContent = msg;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if(!ok) f.style.display = 'none';
    }, 5000);
}

// XP system
function updateXP(n) { 
    state.xp += n; 
    document.getElementById('xp-bar').style.width = (state.xp % 100) + '%'; 
    document.getElementById('xp').textContent = state.xp; 
    document.getElementById('lvl').textContent = Math.floor(state.xp/100) + 1; 
}

// Initialize
buildCalc();

// Debug Panel Functions
function showDebugPanel() {
    const panel = document.getElementById('debug-panel');
    const content = document.getElementById('debug-content');
    
    let html = '<h4>üìä State Globale:</h4>';
    html += '<pre>' + JSON.stringify({
        xp: state.xp,
        tipo: state.tipo,
        testo: state.testo,
        attempts: state.attempts
    }, null, 2) + '</pre>';
    
    if(state.data) {
        html += '<h4>üìù Dati AI - Numeri Attesi:</h4>';
        html += '<pre>' + JSON.stringify(state.data.numeri, null, 2) + '</pre>';
        
        html += '<h4>üß† Dati AI - Logica (Step 3):</h4>';
        html += '<pre>' + JSON.stringify(state.data.logica, null, 2) + '</pre>';
        
        html += '<h4>üî¢ Dati AI - Calcoli (Step 4):</h4>';
        html += '<pre>' + JSON.stringify(state.data.calcoli, null, 2) + '</pre>';
        
        html += '<h4>‚úÖ Dati AI - Risposte (Step 5):</h4>';
        html += '<pre>' + JSON.stringify(state.data.risposte, null, 2) + '</pre>';
        
        html += '<h4>üìå Tipo Problema:</h4>';
        html += '<pre>' + (state.data.tipo || 'Non specificato') + '</pre>';
    } else {
        html += '<p style="color:#ef4444;">‚ö†Ô∏è Nessun dato AI caricato. Analizza prima un problema!</p>';
    }
    
    content.innerHTML = html;
    panel.style.display = 'block';
}

function closeDebugPanel() {
    document.getElementById('debug-panel').style.display = 'none';
}
</script>
</body>
</html>

