<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISCOVER - Risolvi con l'AI</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --error: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Header & XP */
        .header { text-align: center; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .xp-container { background: rgba(0,0,0,0.2); height: 20px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .xp-fill { background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; width: 0%; transition: width 0.5s; }

        /* Card Steps */
        .step-card { background: white; color: #1e293b; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; display: none; animation: slideUp 0.4s ease; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .step-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .step-num { background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }
        
        /* Form elements */
        textarea, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 8px; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .feedback { padding: 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; display: none; }
        .hint { background: #fffbeb; color: #92400e; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; border-left: 4px solid #f59e0b; display: none; }
        .hidden { display: none; }
        
        /* Loading */
        #loader { text-align: center; padding: 40px; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîç DISCOVER</h1>
        <div class="xp-container"><div class="xp-fill" id="xp-bar"></div></div>
        <p style="margin-top:5px; font-size: 14px;">Livello <span id="lvl">1</span> ‚Ä¢ <span id="xp-text">0</span> XP</p>
    </div>

    <div class="step-card active" id="step1">
        <div class="step-header"><div class="step-num">1</div><h2>Cosa dobbiamo risolvere?</h2></div>
        <p>Incolla qui il testo del problema:</p>
        <textarea id="input-problema" rows="4" placeholder="Es: Maria ha 10 mele, ne regala 3..."></textarea>
        <button class="btn" onclick="analizza()">Inizia l'analisi ‚ú®</button>
    </div>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p style="margin-top:15px">L'AI sta leggendo il problema...</p>
    </div>

    <div class="step-card" id="step2">
        <div class="step-header"><div class="step-num">2</div><h2>I dati del problema</h2></div>
        <div id="testo-ripasso" style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; font-style:italic"></div>
        <label>Quali numeri vedi nel testo? (separali con la virgola)</label>
        <input type="text" id="ans2" placeholder="Es: 10, 3">
        <button class="btn" onclick="check2()">Verifica dati ‚úì</button>
        <div class="feedback" id="f2"></div>
    </div>

    <div class="step-card" id="step3">
        <div class="step-header"><div class="step-num">3</div><h2>Capiamo la situazione</h2></div>
        <div id="q3-container"></div>
        <button class="btn" onclick="check3()">Continua ‚úì</button>
        <div class="feedback" id="f3"></div>
    </div>

    <div class="step-card" id="step4">
        <div class="step-header"><div class="step-num">4</div><h2>Facciamo i calcoli</h2></div>
        <div id="q4-container"></div>
        <button class="btn" onclick="check4()">Verifica calcoli ‚úì</button>
        <div class="feedback" id="f4"></div>
    </div>

    <div class="step-card" id="step5">
        <div class="step-header"><div class="step-num">5</div><h2>La risposta finale</h2></div>
        <div id="q5-container"></div>
        <button class="btn" onclick="check5()">Concludi üéØ</button>
        <div class="feedback" id="f5"></div>
    </div>
</div>

<script>
let state = { data: null, xp: 0, attempts: {} };
const API_KEY = localStorage.getItem('gemini_api_key') || prompt("Inserisci la tua API Key Gemini:");
if(API_KEY) localStorage.setItem('gemini_api_key', API_KEY);

function updateXP(pts) {
    state.xp += pts;
    document.getElementById('xp-bar').style.width = (state.xp % 100) + '%';
    document.getElementById('xp-text').textContent = state.xp;
    document.getElementById('lvl').textContent = Math.floor(state.xp / 100) + 1;
}

// VALIDAZIONE FLESSIBILE
function validate(input, expected, type) {
    if (!input) return false;
    let cleanIn = input.toString().toLowerCase().trim();
    let cleanExp = expected.toString().toLowerCase().trim();

    if (type === 'number') {
        // Estrae il primo numero trovato (gestisce 10,5 e 10.5)
        let numIn = cleanIn.replace(',', '.').match(/(\d+(\.\d+)?)/);
        let numExp = cleanExp.replace(',', '.').match(/(\d+(\.\d+)?)/);
        return numIn && numExp && parseFloat(numIn[0]) === parseFloat(numExp[0]);
    }
    
    // Per il testo: basta che la risposta contenga la parola chiave
    return cleanIn.includes(cleanExp) || cleanExp.includes(cleanIn);
}

async function analizza() {
    const testo = document.getElementById('input-problema').value;
    if(!testo) return;

    document.getElementById('step1').classList.remove('active');
    document.getElementById('loader').classList.remove('hidden');

    const prompt = `Analizza questo problema per un bambino: "${testo}". 
    Rispondi SOLO con un JSON cos√¨:
    {
      "numeri": ["10", "3"],
      "analisi": [{"q": "Chi √® il protagonista?", "a": "Maria", "t": "text"}],
      "calcoli": [{"q": "Quante mele restano?", "c": "10-3", "a": "7", "t": "number"}],
      "finale": [{"q": "Risposta finale:", "a": "7", "t": "number"}]
    }`;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
            method: 'POST',
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const json = await resp.json();
        let raw = json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        state.data = JSON.parse(raw);
        
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('testo-ripasso').textContent = testo;
        document.getElementById('step2').classList.add('active');
        updateXP(10);
    } catch(e) { 
        alert("Errore AI. Controlla la chiave o il testo."); 
        location.reload();
    }
}

function check2() {
    let inNums = document.getElementById('ans2').value.match(/\d+/g) || [];
    if(inNums.length >= state.data.numeri.length) {
        showFeedback('f2', true, "Ottimo! Hai trovato tutti i numeri.");
        setTimeout(() => { 
            document.getElementById('step2').classList.remove('active');
            renderQuestions('q3-container', state.data.analisi, 's3');
            document.getElementById('step3').classList.add('active');
        }, 1000);
        updateXP(20);
    } else {
        showFeedback('f2', false, "Manca qualche numero, guarda bene!");
    }
}

function renderQuestions(id, list, prefix) {
    const container = document.getElementById(id);
    container.innerHTML = list.map((item, i) => `
        <div style="margin-bottom:15px">
            <p><strong>${item.q}</strong></p>
            <input type="text" id="${prefix}-${i}" placeholder="Risposta...">
            <div id="hint-${prefix}-${i}" class="hint">üí° Suggerimento: riguarda il testo!</div>
        </div>
    `).join('');
}

function checkStep(list, prefix, nextStepId, feedbackId, currentStepId) {
    let allOk = true;
    list.forEach((item, i) => {
        let val = document.getElementById(`${prefix}-${i}`).value;
        if(!validate(val, item.a, item.t)) {
            allOk = false;
            state.attempts[`${prefix}-${i}`] = (state.attempts[`${prefix}-${i}`] || 0) + 1;
            if(state.attempts[`${prefix}-${i}`] >= 2) {
                document.getElementById(`hint-${prefix}-${i}`).style.display = 'block';
            }
        }
    });

    if(allOk) {
        showFeedback(feedbackId, true, "Grandioso! Tutto giusto.");
        updateXP(30);
        setTimeout(() => {
            document.getElementById(currentStepId).classList.remove('active');
            if(nextStepId === 'step4') renderQuestions('q4-container', state.data.calcoli, 's4');
            if(nextStepId === 'step5') renderQuestions('q5-container', state.data.finale, 's5');
            if(nextStepId) document.getElementById(nextStepId).classList.add('active');
            else document.getElementById('victory-screen').style.display = 'flex';
        }, 1000);
    } else {
        showFeedback(feedbackId, false, "C'√® un piccolo errore, riprova!");
    }
}

function check3() { checkStep(state.data.analisi, 's3', 'step4', 'f3', 'step3'); }
function check4() { checkStep(state.data.calcoli, 's4', 'step5', 'f4', 'step4'); }
function check5() { 
    showFeedback('f5', true, "Problema Risolto! Sei un campione!");
    updateXP(50);
    setTimeout(() => alert("üéâ COMPLIMENTI! Hai completato il problema!"), 1000);
}

function showFeedback(id, isOk, msg) {
    const el = document.getElementById(id);
    el.style.display = 'block';
    el.style.background = isOk ? '#d1fae5' : '#fee2e2';
    el.style.color = isOk ? '#065f46' : '#991b1b';
    el.textContent = msg;
}
</script>

</body>
</html>

