<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISCOVER v3.5 - Total Precision</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --error: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 100px; }
        
        /* Header & Navigation */
        .header { text-align: center; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; position: relative; }
        .back-btn { position: absolute; left: 15px; top: 20px; background: white; color: var(--primary); border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; transition: 0.3s; }
        .xp-bar-bg { background: rgba(0,0,0,0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 15px; }
        .xp-bar-fill { background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; width: 0%; transition: width 0.5s; }

        /* Sticky Problem Box */
        #sticky-problem { 
            background: white; color: #1e293b; border-radius: 15px; padding: 20px; margin-bottom: 20px; 
            border-left: 6px solid var(--primary); display: none; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        #sticky-problem h4 { color: var(--primary); font-size: 11px; text-transform: uppercase; margin-bottom: 5px; opacity: 0.8; }
        
        .type-badge { display: inline-block; padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .type-trasformazione { background: #dbeafe; color: #1e40af; }
        .type-compravendita { background: #fef3c7; color: #92400e; }
        .type-combinazione { background: #d1fae5; color: #065f46; }

        /* Cards */
        .card { background: white; color: #1e293b; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; display: none; animation: slideUp 0.4s ease; }
        .active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .step-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .step-num { background: var(--primary); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        
        textarea, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 8px; font-size: 16px; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; }
        
        .feedback { padding: 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; display: none; }
        .hint { background: #fffbeb; color: #92400e; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; border-left: 4px solid #f59e0b; display: none; }

        .question-block { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border-left: 3px solid var(--primary); }

        /* Calculator */
        .calc-toggle { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: white; color: var(--primary); border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 24px; z-index: 1000; }
        .calc-popup { position: fixed; bottom: 95px; right: 25px; width: 260px; background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: none; z-index: 1000; color: #1e293b; }
        .calc-screen { background: #1e293b; color: #00ff88; padding: 10px; text-align: right; font-size: 22px; border-radius: 10px; margin-bottom: 10px; min-height: 50px; font-family: monospace; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .c-btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #f1f5f9; }
        .c-btn.op { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="matematica.html" class="back-btn">‚Üê Home</a>
        <h1>üîç DISCOVER v3.5</h1>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-bar"></div></div>
        <p style="margin-top:8px; font-size: 12px;">LIVELLO <span id="lvl">1</span> ‚Ä¢ <span id="xp">0</span> XP</p>
    </div>

    <div id="sticky-problem">
        <h4>PROBLEMA ATTIVO</h4>
        <div id="problem-type-container"></div>
        <div id="sticky-text" style="font-weight: 500; font-size: 15px;"></div>
    </div>

    <div class="card active" id="step1">
        <div class="step-header"><div class="step-num">1</div><h2>Analisi Problema</h2></div>
        <textarea id="p-input" rows="5" placeholder="Marco ha 6 mele, Anna ne ha 8..."></textarea>
        <button class="btn" onclick="analizza()">Analizza con AI ‚ú®</button>
    </div>

    <div id="loader" style="display:none; text-align:center; padding:30px;">
        <div style="border:4px solid white; border-top:4px solid transparent; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto;"></div>
        <p style="color:white; margin-top:15px;">Scomponendo il problema per ogni personaggio...</p>
    </div>

    <div class="card" id="step2">
        <div class="step-header"><div class="step-num">2</div><h2>I Numeri</h2></div>
        <p>Elenca i numeri del testo separati da virgola:</p>
        <input type="text" id="ans2" placeholder="Es: 6, 8, 2, 3">
        <button class="btn" onclick="check2()">Verifica ‚úì</button>
        <div class="feedback" id="f2"></div>
    </div>

    <div class="card" id="step3">
        <div class="step-header"><div class="step-num">3</div><h2>Comprensione</h2></div>
        <div id="q3-list"></div>
        <button class="btn" onclick="check3()">Avanti ‚úì</button>
        <div class="feedback" id="f3"></div>
    </div>

    <div class="card" id="step4">
        <div class="step-header"><div class="step-num">4</div><h2>Passaggi di Calcolo</h2></div>
        <div id="q4-list"></div>
        <button class="btn" onclick="check4()">Verifica Calcoli ‚úì</button>
        <div class="feedback" id="f4"></div>
    </div>

    <div class="card" id="step5">
        <div class="step-header"><div class="step-num">5</div><h2>Risposte Finali</h2></div>
        <div id="q5-list"></div>
        <button class="btn" onclick="check5()">Concludi üéØ</button>
        <div class="feedback" id="f5"></div>
    </div>
</div>

<button class="calc-toggle" onclick="toggleCalc()">üî¢</button>
<div class="calc-popup" id="calc-box">
    <div class="calc-screen" id="c-screen">0</div>
    <div class="calc-grid" id="c-btns"></div>
</div>

<script>
let state = { data: null, xp: 0, attempts: {}, testo: "", tipo: "" };
let cVal = "";

const API_KEY = localStorage.getItem('gemini_api_key') || prompt("Inserisci la tua API Key Gemini:");
if(API_KEY) localStorage.setItem('gemini_api_key', API_KEY);

function toggleCalc() { const b = document.getElementById('calc-box'); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }
function buildCalc() { 
    const g = document.getElementById('c-btns'); 
    const keys = ['C','/','*','-','7','8','9','+','4','5','6','=','1','2','3','0','.']; 
    g.innerHTML = keys.map(k => `<button class="c-btn ${isNaN(k)&&k!=='.'?'op':''}" onclick="doCalc('${k}')">${k}</button>`).join(''); 
}
function doCalc(k) { 
    const s = document.getElementById('c-screen'); 
    if(k === 'C') cVal = ""; 
    else if(k === '=') { try { cVal = eval(cVal).toString(); } catch { cVal = "Error"; } } 
    else cVal += k; 
    s.textContent = cVal || "0"; 
}

async function analizza() {
    state.testo = document.getElementById('p-input').value.trim();
    if(!state.testo) return;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('loader').style.display = 'block';

    const prompt = `Analizza questo problema matematico per bambini: "${state.testo}". 
    REGOLE CRITICHE:
    - Se ci sono pi√π personaggi (es. Marco, Anna, Carlo), crea domande separate per ognuno.
    - Se un personaggio regala e riceve, dividi in due calcoli nello step "calcoli".
    - In "numeri" metti tutti i numeri (es. 0.80, 15, 3).
    - Rispondi SOLO in formato JSON valido, senza testo aggiuntivo.
    
    {
      "tipo": "TRASFORMAZIONE|COMPRAVENDITA|COMBINAZIONE",
      "numeri": ["6", "8", "2", "3"],
      "logica": [{"q": "Chi sono i protagonisti?", "a": "Marco, Anna e Carlo", "t": "text"}],
      "calcoli": [{"q": "Mele di Marco dopo il regalo:", "a": "4", "t": "number"}],
      "risposte": [{"q": "Mele finali di Marco:", "a": "7", "t": "number"}]
    }`;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
            method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const res = await resp.json();
        let raw = res.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        state.data = JSON.parse(raw);
        
        document.getElementById('sticky-text').textContent = state.testo;
        document.getElementById('problem-type-container').innerHTML = `<div class="type-badge type-trasformazione">${state.data.tipo || 'PROBLEMA'}</div>`;
        document.getElementById('sticky-problem').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
        showStep(2);
        updateXP(10);
    } catch(e) { console.error(e); alert("Errore AI. Riprova."); location.reload(); }
}

function showStep(n) {
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    document.getElementById(`step${n}`).classList.add('active');
    if(n === 3) renderQs('q3-list', state.data.logica, 's3');
    if(n === 4) renderQs('q4-list', state.data.calcoli, 's4');
    if(n === 5) renderQs('q5-list', state.data.risposte, 's5');
}

function renderQs(id, list, prefix) {
    document.getElementById(id).innerHTML = list.map((item, i) => `
        <div class="question-block">
            <label>${item.q}</label>
            <input type="text" id="${prefix}-${i}" autocomplete="off">
            <div id="hint-${prefix}-${i}" class="hint">üí° Riguarda bene il testo del problema.</div>
        </div>
    `).join('');
}

function validate(val, exp, type) {
    if(!val) return false;
    let v = val.toLowerCase().trim();
    let e = exp.toString().toLowerCase().trim();
    if(type === 'number') {
        // Estrae solo il valore numerico ignorando testo extra (es. "7 mele" -> 7)
        let nVMatch = v.replace(',', '.').match(/[\d.]+/);
        let nEMatch = e.replace(',', '.').match(/[\d.]+/);
        if(!nVMatch || !nEMatch) return false;
        return Math.abs(parseFloat(nVMatch[0]) - parseFloat(nEMatch[0])) < 0.01;
    }
    return v.includes(e) || e.includes(v);
}

function check2() {
    let input = document.getElementById('ans2').value;
    let found = input.match(/\d+(?:\.\d+)?/g) || [];
    if(found.length >= Math.ceil(state.data.numeri.length * 0.7)) { 
        showFeedback('f2', true, "Numeri trovati!"); 
        setTimeout(() => showStep(3), 800); 
        updateXP(20); 
    } else showFeedback('f2', false, "Rileggi bene il testo!");
}

function handleStep(list, prefix, next, fId) {
    let ok = true;
    list.forEach((it, i) => {
        if(!validate(document.getElementById(`${prefix}-${i}`).value, it.a, it.t)) {
            ok = false;
            state.attempts[prefix+i] = (state.attempts[prefix+i] || 0) + 1;
            if(state.attempts[prefix+i] >= 2) document.getElementById(`hint-${prefix}-${i}`).style.display = 'block';
        }
    });
    if(ok) { showFeedback(fId, true, "Esatto!"); updateXP(30); setTimeout(() => next ? showStep(next) : fine(), 800); }
    else showFeedback(fId, false, "Qualcosa non √® corretto!");
}

function check3() { handleStep(state.data.logica, 's3', 4, 'f3'); }
function check4() { handleStep(state.data.calcoli, 's4', 5, 'f4'); }
function check5() { handleStep(state.data.risposte, 's5', null, 'f5'); }
function fine() { alert("Ottimo lavoro! Hai risolto il problema."); location.reload(); }

function showFeedback(id, ok, msg) {
    const f = document.getElementById(id); f.style.display = 'block';
    f.style.background = ok ? '#d1fae5' : '#fee2e2'; f.style.color = ok ? '#065f46' : '#991b1b'; f.textContent = msg;
}

function updateXP(n) { state.xp += n; document.getElementById('xp-bar').style.width = (state.xp % 100) + '%'; document.getElementById('xp').textContent = state.xp; document.getElementById('lvl').textContent = Math.floor(state.xp/100)+1; }
buildCalc();
</script>
</body>
</html>
