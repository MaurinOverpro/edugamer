<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISCOVER v4.0 - Metodo Guidato DSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">

    <style>
        * { letter-spacing: 0.02em; }
        
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body { 
            background: linear-gradient(135deg, #0a0e17 0%, #1a1f2e 100%);
            color: white; 
            font-family: 'OpenDyslexic', Verdana, sans-serif;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* PROGRESS BAR ANIMATA */
        @keyframes progress-fill {
            from { width: 0%; }
        }
        .progress-fill {
            animation: progress-fill 0.8s ease-out;
            transition: width 0.5s ease;
        }

        /* FADE IN ANIMATION */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeIn 0.4s ease-out; }

        /* PULSE ANIMATION */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .animate-pulse { animation: pulse 2s infinite; }

        /* GLOW EFFECT */
        .glow-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5),
                        0 0 40px rgba(16, 185, 129, 0.3);
        }
        .glow-blue {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5),
                        0 0 40px rgba(59, 130, 246, 0.3);
        }
        .glow-yellow {
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.5),
                        0 0 40px rgba(250, 204, 21, 0.3);
        }

        /* CALCULATOR BUTTONS */
        .calc-btn {
            width: 100%;
            height: 48px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.1s;
            box-shadow: 0 2px 0 #1e293b;
        }
        .calc-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* INPUT FIELDS */
        .answer-input {
            background: rgba(30, 41, 59, 0.8);
            border: 3px solid #475569;
            border-radius: 12px;
            padding: 16px;
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            color: white;
            width: 100%;
            transition: all 0.3s;
        }
        .answer-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }
        .answer-input.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        .answer-input.incorrect {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        /* HINT BOX */
        .hint-box {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 16px;
            animation: fadeIn 0.3s ease-out;
        }

        /* STEP CARD */
        .step-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid #334155;
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s;
        }
        .step-card.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        /* PROBLEM BOX */
        .problem-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border: 2px solid rgba(99, 102, 241, 0.5);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
        }

        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-info { background: #3b82f6; color: white; }

        /* SCROLL AREA */
        .scroll-area {
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .calc-btn { height: 42px; font-size: 1rem; }
            .answer-input { font-size: 1.1rem; padding: 12px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const MODEL = "gemini-2.0-flash-exp";
        
        // DATABASE & UTILITY
        const DB = {
            getKey: () => localStorage.getItem('gemini_api_key'),
            getXP: () => parseInt(localStorage.getItem('edu_xp') || '0'),
            addXP: (amount) => {
                const next = DB.getXP() + amount;
                localStorage.setItem('edu_xp', next.toString());
                window.dispatchEvent(new Event('xpChanged'));
                return next;
            }
        };

        // MASTER PROMPT per Gemini
        const MASTER_PROMPT = `Sei un tutor esperto per studenti con DSA (discalculia, dislessia) di et√† 9-12 anni.

TIPI DI PROBLEMI CHE POTRESTI INCONTRARE:
1. SEMPLICI: 1 operazione diretta (es: "5 mele + 3 mele")
2. COMPRAVENDITA: quantit√† √ó prezzo (es: "5 penne a 2‚Ç¨")
3. PROPORZIONI: doppio/triplo/met√†/quadruplo (es: "Davide ha il quadruplo")
4. FRAZIONI: parte di quantit√† (es: "3/4 del percorso")
5. MULTI-STEP: operazioni in sequenza (es: "compra X, poi vende Y")
6. DOMANDE NASCOSTE: devi calcolare prima un dato intermedio non chiesto esplicitamente
7. INVERSI: dato il risultato, trova l'inizio (es: "restano 7, ne ha mangiati 3, quante ne aveva?")
8. PESO LORDO/NETTO/TARA: contenitore + contenuto
9. DISTANZE/PERCORSI: totale - fatto = mancano
10. CONFRONTO: "pi√π di", "meno di", "differenza"

GENERA UN JSON COS√å (SOLO JSON, NESSUN TESTO EXTRA):

{
  "testo_problema": "testo completo trascritto dall'immagine",
  "tipo_problema": "uno dei tipi sopra",
  "complessita": 1-5,
  "dati": {
    "numeri": [lista numeri trovati],
    "personaggi": [lista nomi],
    "oggetti_misure": [lista oggetti o unit√†],
    "domande": ["domanda principale del problema"]
  },
  "workflow": [
    {
      "step": 1,
      "tipo": "estrazione_dati",
      "titolo": "TROVA I DATI",
      "domanda": "Quali sono i numeri importanti nel problema?",
      "risposta_corretta": "16, 2, 3, 4",
      "accetta_anche": ["16 2 3 4", "16km, 2ore, 3/4"],
      "hint_1": "Guida ragionamento: 'Rileggi il problema con attenzione. Cerca tutti i numeri che vedi scritti'",
      "hint_2": "Guida ragionamento: 'Ci sono numeri che indicano distanze? E numeri che formano una frazione?'",
      "hint_3": "Risposta diretta: 'I numeri sono: 16 (distanza totale in km), 2 (ore), 3 e 4 (formano la frazione 3/4)'"
    },
    {
      "step": 2,
      "tipo": "calcolo",
      "titolo": "RAGIONA SUL CALCOLO",
      "domanda": "Marco ha fatto 3/4 del percorso di 16 km. Quanti km ha camminato?",
      "risposta_corretta": "12",
      "accetta_anche": ["12 km", "12km", "dodici"],
      "hint_1": "Guida ragionamento: 'Quando devi trovare una frazione di un numero, devi pensare a come dividere quel numero in parti'",
      "hint_2": "Guida ragionamento: 'Se devi trovare 3/4 di 16, puoi prima pensare: quanto √® 1/4 di 16? Poi moltiplichi per 3'",
      "hint_3": "Risposta diretta con operazione: 'Devi fare: 16 √ó 3 √∑ 4. Cio√®: 16 √ó 3 = 48, poi 48 √∑ 4 = 12 km'"
    }
  ],
  "risposta_finale": "Mancano 4 km per arrivare da Matteo",
  "xp_guadagnati": 60
}

REGOLE IMPORTANTISSIME:

**HINTS PROGRESSIVI (FONDAMENTALE - LEGGI CON ATTENZIONE!):**

**hint_1** - Aiuto al RAGIONAMENTO (NO formule, NO operazioni):
  - Fai domande che stimolano il pensiero
  - Guida a capire COSA fare, non COME fare matematicamente
  - Usa metafore, esempi concreti, visualizzazioni
  
  ‚úÖ ESEMPI CORRETTI:
  "Pensa: se dividi 16 km in 4 parti uguali, quanto √® grande ogni parte?"
  "Ragiona: cosa significa 'il quadruplo'? Se Paolo ha 7, quante volte 7 deve avere Davide?"
  "Immagina di dividere una torta in 4 pezzi uguali. Se ne prendi 3, quanta torta hai?"
  
  ‚ùå ESEMPI SBAGLIATI:
  "Devi moltiplicare 16 per 3 e dividere per 4"
  "L'operazione √®: 16 √ó 3 √∑ 4"
  "Fai 16 per 3 diviso 4"

**hint_2** - Guida al PROCESSO LOGICO (ancora NO operazioni esatte):
  - Spiega i PASSI da seguire senza dare la formula
  - Aiuta a scomporre il problema in sotto-problemi
  - Suggerisci la sequenza di ragionamento
  
  ‚úÖ ESEMPI CORRETTI:
  "Prima trova quanto vale una sola parte (1/4). Poi moltiplica per 3 quella parte"
  "Step 1: Scopri quanto √® un quarto. Step 2: Prendi quel valore e moltiplicalo per tre"
  "Dividi il totale per 4 per trovare una parte. Poi prendi 3 di quelle parti"
  
  ‚ùå ESEMPI SBAGLIATI:
  "Fai 16 √∑ 4 = 4, poi 4 √ó 3 = 12"
  "16 √ó 3 √∑ 4"
  "Calcola: 16 per 3 diviso 4"

**hint_3** - RISPOSTA COMPLETA (QUI s√¨ che dai tutto):
  - Fornisci l'operazione matematica esatta
  - Mostra i calcoli passo per passo
  - Spiega il PERCH√â di ogni passaggio
  
  ‚úÖ ESEMPIO CORRETTO:
  "Ecco come si risolve: Devi calcolare 3/4 di 16 km. L'operazione √®: 16 √ó 3 √∑ 4. Facciamo i calcoli: 16 √ó 3 = 48 km (questo √® 3 volte il percorso intero). Poi 48 √∑ 4 = 12 km (dividiamo in 4 parti). Quindi Marco ha camminato 12 km."

**CRUCIALE:** NON includere MAI il campo "operazione" come propriet√† separata nello step JSON! 
L'operazione matematica deve apparire SOLO nell'hint_3, mai come campo "operazione": "16 √ó 3 √∑ 4"

Altre regole: Domande SEMPRE concrete e chiare (MAI vaghe come "cosa cerchi?")
- Ogni step = 1 domanda + 1 risposta inequivocabile
- Minimo 2 step, massimo 6 step
- SEMPRE includere unit√† di misura nelle risposte
- Per problemi complessi: spezzali in micro-step semplici
- Se c'√® domanda nascosta: crea step apposito prima della domanda finale
- "accetta_anche" deve includere varianti ragionevoli (con/senza spazi, con/senza unit√†)
- XP: 30-50 per semplici, 60-80 per medi, 90-120 per complessi

ESEMPI DOMANDE CONCRETE (BUONE):
‚úÖ "Qual √® la distanza totale in km?"
‚úÖ "Quanti km ha gi√† camminato Marco?"
‚úÖ "Quanto costa 1 penna?"
‚úÖ "Quante mele aveva Marco all'inizio?"

ESEMPI DOMANDE VAGHE (CATTIVE - NON USARE):
‚ùå "Cosa devi trovare?"
‚ùå "Quale strategia usi?"
‚ùå "Come lo risolvi?"
‚ùå "Ragiona sul problema"

Rispondi SOLO con il JSON, senza markdown, senza prefissi.`;

        // CHIAMATA GEMINI con immagine
        async function analyzeImage(imageData) {
            const key = DB.getKey();
            if (!key) throw new Error("Manca API Key Gemini!");
            
            const body = {
                contents: [{
                    parts: [
                        { text: MASTER_PROMPT },
                        { 
                            inlineData: { 
                                mimeType: "image/jpeg", 
                                data: imageData.split(',')[1] 
                            } 
                        }
                    ]
                }]
            };
            
            const res = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }
            );
            
            if (!res.ok) throw new Error("Errore chiamata Gemini");
            
            const data = await res.json();
            let text = data.candidates[0].content.parts[0].text;
            
            // Pulisci JSON da eventuali markdown
            text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            return JSON.parse(text);
        }

        // CHIAMATA GEMINI per hint dinamico
        async function generateDynamicHint(problemText, stepData, userAnswer, attemptCount) {
            const key = DB.getKey();
            if (!key) return null;
            
            const prompt = `Problema: ${problemText}
Domanda: ${stepData.domanda}
Risposta corretta: ${stepData.risposta_corretta}
Risposta studente: ${userAnswer}
Tentativo numero: ${attemptCount}

Genera un hint di livello ${attemptCount}:
- Livello 1: suggerimento generico per orientarlo
- Livello 2: suggerimento specifico con procedura
- Livello 3: risposta diretta + spiegazione completa

Rispondi SOLO con il testo dell'hint, senza prefissi.`;
            
            try {
                const body = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                
                const res = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${key}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }
                );
                
                const data = await res.json();
                return data.candidates[0].content.parts[0].text.trim();
            } catch {
                return null;
            }
        }

        // VALIDAZIONE RISPOSTA
        function validateAnswer(userAnswer, correctAnswer, acceptVariants = []) {
            const clean = (s) => String(s).toLowerCase().trim()
                .replace(/\s+/g, ' ')
                .replace(/[.,!?;:]/g, '');
            
            const userClean = clean(userAnswer);
            const correctClean = clean(correctAnswer);
            
            // Match esatto
            if (userClean === correctClean) return true;
            
            // Match con varianti
            for (const variant of acceptVariants) {
                if (userClean === clean(variant)) return true;
                
                // Match parziale (contiene)
                if (userClean.includes(clean(variant)) || clean(variant).includes(userClean)) {
                    return true;
                }
            }
            
            // Match numerico (estrae numeri e confronta)
            const userNum = userClean.match(/\d+([.,]\d+)?/);
            const correctNum = correctClean.match(/\d+([.,]\d+)?/);
            if (userNum && correctNum) {
                const uNum = parseFloat(userNum[0].replace(',', '.'));
                const cNum = parseFloat(correctNum[0].replace(',', '.'));
                if (Math.abs(uNum - cNum) < 0.01) return true;
            }
            
            return false;
        }

        // ESTRAE OPERAZIONE DA HINT_3
        function extractOperationFromHint(hint3) {
            if (!hint3) return null;
            
            // Cerca pattern tipo "16 √ó 3 √∑ 4" o "16 + 12" etc
            const patterns = [
                /(\d+\s*[√ó\*]\s*\d+\s*[√∑\/]\s*\d+)/,  // 16 √ó 3 √∑ 4
                /(\d+\s*[+\-√ó\*√∑\/]\s*\d+)/,          // 16 + 12, 16 - 4, etc
                /(\d+\s*[+\-√ó\*√∑\/]\s*\d+\s*[+\-√ó\*√∑\/]\s*\d+)/  // operazioni multiple
            ];
            
            for (const pattern of patterns) {
                const match = hint3.match(pattern);
                if (match) {
                    return match[1].trim();
                }
            }
            
            return null;
        }

        // ============ REACT APP ============
        const { useState, useEffect, useRef } = React;

        // COMPONENTE MODAL API KEY
        const APIKeyModal = ({ onSave }) => {
            const [apiKey, setApiKey] = useState('');
            const [error, setError] = useState('');

            const handleSave = () => {
                if (!apiKey.trim()) {
                    setError('Inserisci una chiave API!');
                    return;
                }
                
                if (!apiKey.startsWith('AIza')) {
                    setError('La chiave API deve iniziare con "AIza"');
                    return;
                }
                
                if (apiKey.length < 30) {
                    setError('La chiave sembra troppo corta');
                    return;
                }
                
                localStorage.setItem('gemini_api_key', apiKey.trim());
                onSave();
            };

            return (
                <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 max-w-lg w-full border-2 border-blue-500 shadow-2xl animate-fade">
                        <div className="text-center mb-6">
                            <div className="text-6xl mb-4">üîë</div>
                            <h2 className="text-3xl font-bold text-blue-400 mb-2">API Key Richiesta</h2>
                            <p className="text-slate-400">Inserisci la tua chiave API Gemini per continuare</p>
                        </div>

                        <div className="bg-yellow-900/30 border-2 border-yellow-600 rounded-xl p-4 mb-6">
                            <div className="flex items-start gap-3">
                                <span className="text-2xl">üí°</span>
                                <div className="text-sm">
                                    <div className="font-bold text-yellow-400 mb-1">Come ottenere la chiave:</div>
                                    <ol className="list-decimal list-inside space-y-1 text-yellow-200">
                                        <li>Vai su: <a href="https://aistudio.google.com/apikey" target="_blank" className="underline text-blue-400">aistudio.google.com/apikey</a></li>
                                        <li>Fai login con Google</li>
                                        <li>Clicca "Create API Key"</li>
                                        <li>Copia la chiave e incollala qui sotto</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="block text-sm font-bold text-slate-300 mb-2">
                                üîë Chiave API Gemini:
                            </label>
                            <input
                                type="text"
                                value={apiKey}
                                onChange={(e) => {
                                    setApiKey(e.target.value);
                                    setError('');
                                }}
                                placeholder="AIzaSy..."
                                className="w-full bg-slate-950 border-2 border-slate-600 rounded-xl p-4 text-white font-mono text-sm focus:border-blue-500 focus:outline-none"
                                autoFocus
                            />
                            {error && (
                                <div className="mt-2 text-red-400 text-sm flex items-center gap-2">
                                    <span>‚ö†Ô∏è</span>
                                    <span>{error}</span>
                                </div>
                            )}
                        </div>

                        <button
                            onClick={handleSave}
                            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl text-lg active:scale-95 glow-blue transition-all"
                        >
                            üíæ SALVA E CONTINUA
                        </button>

                        <div className="mt-4 text-xs text-slate-500 text-center">
                            La chiave verr√† salvata solo nel tuo browser locale
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [showAPIKeyModal, setShowAPIKeyModal] = useState(false);
            const [screen, setScreen] = useState('upload'); // upload | workflow | victory
            const [imageData, setImageData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [problemData, setProblemData] = useState(null);
            const [currentStep, setCurrentStep] = useState(0);
            const [stepAnswers, setStepAnswers] = useState({});
            const [stepAttempts, setStepAttempts] = useState({});
            const [stepHints, setStepHints] = useState({});
            const [userXP, setUserXP] = useState(DB.getXP());
            const [calcDisplay, setCalcDisplay] = useState('');
            const [showCalc, setShowCalc] = useState(false);
            const [showSuccessMessage, setShowSuccessMessage] = useState(null); // { type: 'success' | 'continue', message: '...' }

            // Controlla API key all'avvio
            useEffect(() => {
                const key = DB.getKey();
                if (!key) {
                    setShowAPIKeyModal(true);
                }
            }, []);

            useEffect(() => {
                const handler = () => setUserXP(DB.getXP());
                window.addEventListener('xpChanged', handler);
                return () => window.removeEventListener('xpChanged', handler);
            }, []);

            // UPLOAD SCREENSHOT
            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    setImageData(evt.target.result);
                };
                reader.readAsDataURL(file);
            };

            // ANALIZZA PROBLEMA
            const analyzeProblem = async () => {
                if (!imageData) return;
                
                setLoading(true);
                try {
                    const data = await analyzeImage(imageData);
                    setProblemData(data);
                    setScreen('workflow');
                    setCurrentStep(0);
                    setStepAnswers({});
                    setStepAttempts({});
                    setStepHints({});
                } catch (err) {
                    alert("Errore: " + err.message);
                }
                setLoading(false);
            };

            // FUNZIONE PER CONTINUARE DOPO LA SCHERMATA DI SPIEGAZIONE
            const handleContinueAfterExplanation = () => {
                setShowSuccessMessage(null);
                
                if (currentStep < problemData.workflow.length - 1) {
                    setCurrentStep(currentStep + 1);
                    setStepHints({});
                } else {
                    const totalXP = Math.max(10, (problemData.xp_guadagnati || 50) - 20);
                    DB.addXP(totalXP);
                    setScreen('victory');
                }
            };

            // VALIDA STEP
            const validateStep = async () => {
                const step = problemData.workflow[currentStep];
                const userAnswer = stepAnswers[currentStep] || '';
                
                if (!userAnswer.trim()) {
                    alert("Scrivi una risposta prima di continuare!");
                    return;
                }
                
                const isCorrect = validateAnswer(
                    userAnswer, 
                    step.risposta_corretta, 
                    step.accetta_anche || []
                );
                
                if (isCorrect) {
                    // RISPOSTA CORRETTA
                    const attempts = stepAttempts[currentStep] || 0;
                    const bonusXP = attempts === 0 ? 10 : attempts === 1 ? 5 : 0;
                    DB.addXP(bonusXP);
                    
                    // MOSTRA MESSAGGIO DI SUCCESSO
                    const messages = [
                        'üéâ Esatto! Ben fatto!',
                        '‚úÖ Corretto! Ottimo lavoro!',
                        'üåü Perfetto! Continua cos√¨!',
                        'üí™ Giusto! Sei bravissimo!',
                        'üéØ Risposta corretta!'
                    ];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    
                    setShowSuccessMessage({ 
                        type: 'success', 
                        message: randomMsg,
                        xp: bonusXP
                    });
                    
                    // Dopo 2 secondi, passa allo step successivo
                    setTimeout(() => {
                        setShowSuccessMessage(null);
                        
                        if (currentStep < problemData.workflow.length - 1) {
                            // Vai al prossimo step
                            setCurrentStep(currentStep + 1);
                            setStepHints({});
                        } else {
                            // PROBLEMA COMPLETATO
                            const totalXP = problemData.xp_guadagnati || 50;
                            DB.addXP(totalXP);
                            setScreen('victory');
                        }
                    }, 2000);
                } else {
                    // RISPOSTA ERRATA
                    const attempts = (stepAttempts[currentStep] || 0) + 1;
                    setStepAttempts({ ...stepAttempts, [currentStep]: attempts });
                    
                    // Mostra hint progressivo
                    let hint = '';
                    if (attempts === 1) hint = step.hint_1;
                    else if (attempts === 2) hint = step.hint_2;
                    else if (attempts >= 3) hint = step.hint_3;
                    
                    // Prova hint dinamico da Gemini se disponibile
                    if (!hint && attempts <= 3) {
                        const dynamicHint = await generateDynamicHint(
                            problemData.testo_problema,
                            step,
                            userAnswer,
                            attempts
                        );
                        if (dynamicHint) hint = dynamicHint;
                    }
                    
                    setStepHints({ ...stepHints, [currentStep]: hint });
                    
                    // Dopo 3 errori, mostra messaggio completo (rimane finch√© non si preme il pulsante)
                    if (attempts >= 3) {
                        DB.addXP(-5);
                        
                        const operation = extractOperationFromHint(step.hint_3);
                        setShowSuccessMessage({
                            type: 'continue',
                            message: '‚è≠Ô∏è Vediamo la soluzione',
                            correctAnswer: step.risposta_corretta,
                            operation: operation,
                            explanation: step.hint_3,
                            xp: -5
                        });
                    }
                }
            };

            // CALCOLATRICE
            const handleCalc = (val) => {
                if (val === 'C') setCalcDisplay('');
                else if (val === '‚å´') setCalcDisplay(p => p.slice(0, -1));
                else if (val === '=') {
                    try {
                        const result = eval(calcDisplay.replace('√ó', '*').replace('√∑', '/'));
                        setCalcDisplay(String(Math.round(result * 100) / 100));
                    } catch {
                        setCalcDisplay('Err');
                    }
                } else {
                    setCalcDisplay(p => p + val);
                }
            };

            // RENDER API KEY MODAL
            if (showAPIKeyModal) {
                return <APIKeyModal onSave={() => setShowAPIKeyModal(false)} />;
            }

            // RENDER UPLOAD SCREEN
            if (screen === 'upload') {
                return (
                    <div className="min-h-screen flex flex-col p-3 md:p-4 gap-3 md:gap-4">
                        {/* HEADER */}
                        <div className="flex items-center justify-between bg-slate-800/50 backdrop-blur rounded-xl md:rounded-2xl p-3 md:p-4 border-2 border-slate-700">
                            <div className="flex items-center gap-2 md:gap-3">
                                <button 
                                    onClick={() => {
                                        if (imageData || problemData) {
                                            if (window.confirm('Ricominciare da capo? (Il progresso attuale andr√† perso)')) {
                                                setImageData(null);
                                                setProblemData(null);
                                                setScreen('upload');
                                            }
                                        }
                                    }}
                                    className="text-2xl md:text-3xl active:scale-95 cursor-pointer"
                                    title="Ricomincia"
                                >
                                    üè†
                                </button>
                                <div>
                                    <h1 className="text-lg md:text-2xl font-bold text-blue-400">üéØ DISCOVER v4.0</h1>
                                    <p className="text-xs md:text-sm text-slate-400">Metodo Guidato DSA</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 md:gap-3">
                                <button
                                    onClick={() => setShowAPIKeyModal(true)}
                                    className="bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs active:scale-95 transition-all"
                                    title="Modifica API Key"
                                >
                                    üîë
                                </button>
                                <div className="text-right">
                                    <div className="text-xs text-slate-400">XP</div>
                                    <div className="text-lg md:text-2xl font-bold text-yellow-400">{userXP}</div>
                                </div>
                            </div>
                        </div>

                        {/* UPLOAD AREA */}
                        <div className="flex-1 flex flex-col items-center justify-center gap-4 md:gap-6 py-4 px-4">
                            {!imageData ? (
                                <>
                                    <div className="text-6xl md:text-8xl animate-bounce">üìê</div>
                                    <h2 className="text-2xl md:text-3xl font-bold text-center">CARICA IL PROBLEMA</h2>
                                    <p className="text-slate-400 text-center max-w-md text-sm md:text-base">
                                        Scatta una foto o scegli uno screenshot dalla galleria
                                    </p>
                                    <div className="flex flex-col md:flex-row gap-3 md:gap-4 w-full max-w-lg">
                                        <label className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 md:py-4 px-4 md:px-8 rounded-xl md:rounded-2xl cursor-pointer shadow-lg flex items-center justify-center gap-2 md:gap-3 active:scale-95 text-base md:text-xl glow-blue">
                                            <input type="file" onChange={handleUpload} className="hidden" accept="image/*" capture="environment" />
                                            üì∑ SCATTA FOTO
                                        </label>
                                        <label className="flex-1 bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold py-3 md:py-4 px-4 md:px-8 rounded-xl md:rounded-2xl cursor-pointer shadow-lg flex items-center justify-center gap-2 md:gap-3 active:scale-95 text-base md:text-xl glow-green">
                                            <input type="file" onChange={handleUpload} className="hidden" accept="image/*" />
                                            üñºÔ∏è SCEGLI DA GALLERIA
                                        </label>
                                    </div>
                                </>
                            ) : (
                                <div className="w-full max-w-2xl space-y-3 md:space-y-4 animate-fade">
                                    <img src={imageData} className="w-full rounded-xl md:rounded-2xl border-4 border-blue-500 shadow-2xl" />
                                    <div className="flex gap-3">
                                        <button 
                                            onClick={analyzeProblem} 
                                            disabled={loading}
                                            className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 md:py-4 rounded-xl text-lg md:text-xl active:scale-95 glow-green disabled:opacity-50"
                                        >
                                            {loading ? '‚è≥ Analizzo...' : 'üöÄ INIZIA RISOLUZIONE'}
                                        </button>
                                        <button 
                                            onClick={() => setImageData(null)}
                                            className="bg-red-600 text-white font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl text-lg md:text-xl active:scale-95"
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // RENDER WORKFLOW SCREEN
            if (screen === 'workflow' && problemData) {
                const step = problemData.workflow[currentStep];
                const progress = ((currentStep + 1) / problemData.workflow.length) * 100;
                const attempts = stepAttempts[currentStep] || 0;
                const hint = stepHints[currentStep];

                return (
                    <div className="min-h-screen flex flex-col p-2 md:p-3 gap-2 md:gap-3 overflow-y-auto">
                        {/* HEADER */}
                        <div className="flex items-center justify-between bg-slate-800/50 backdrop-blur rounded-xl p-3 border-2 border-slate-700 shrink-0">
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => {
                                        if (window.confirm('Tornare all\'inizio? Il progresso attuale andr√† perso.')) {
                                            setScreen('upload');
                                            setImageData(null);
                                            setProblemData(null);
                                        }
                                    }}
                                    className="text-2xl active:scale-95"
                                    title="Torna all'inizio"
                                >
                                    üè†
                                </button>
                                <div>
                                    <h1 className="text-xl font-bold text-blue-400">üéØ DISCOVER</h1>
                                    <div className="text-xs text-slate-400">
                                        <span className="badge badge-info text-xs">{problemData.tipo_problema}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setShowAPIKeyModal(true)}
                                    className="bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded text-xs active:scale-95 transition-all"
                                    title="Modifica API Key"
                                >
                                    üîë
                                </button>
                                <div className="text-right">
                                    <div className="text-xs text-slate-400">XP</div>
                                    <div className="text-xl font-bold text-yellow-400">{userXP}</div>
                                </div>
                            </div>
                        </div>

                        {/* PROBLEM BOX (sempre visibile) */}
                        <div className="problem-box shrink-0">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="text-2xl">üìù</span>
                                <span className="font-bold text-purple-300">PROBLEMA:</span>
                            </div>
                            <p className="text-base leading-relaxed">{problemData.testo_problema}</p>
                        </div>

                        {/* PROGRESS BAR */}
                        <div className="bg-slate-800/50 rounded-xl p-3 shrink-0">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-sm font-bold">STEP {currentStep + 1}/{problemData.workflow.length}</span>
                                <span className="text-sm text-slate-400">{Math.round(progress)}%</span>
                            </div>
                            <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-blue-500 to-purple-500 progress-fill"
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>
                        </div>

                        {/* MAIN CONTENT */}
                        <div className="flex-1 flex gap-3 overflow-hidden">
                            {/* WORKFLOW AREA */}
                            <div className="flex-1 scroll-area">
                                <div className="step-card active">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-2xl font-bold">
                                            {currentStep + 1}
                                        </div>
                                        <div>
                                            <div className="text-sm text-blue-400 font-bold">{step.titolo}</div>
                                            <div className="text-xs text-slate-400">{step.tipo.replace('_', ' ')}</div>
                                        </div>
                                    </div>

                                    <div className="mb-4">
                                        <div className="text-lg font-bold mb-2 text-white">{step.domanda}</div>
                                        
                                        {/* MOSTRA OPERAZIONE SOLO DOPO 3 ERRORI - estratta da hint_3 */}
                                        {attempts >= 3 && step.hint_3 && (
                                            (() => {
                                                const operation = extractOperationFromHint(step.hint_3);
                                                return operation ? (
                                                    <div className="bg-slate-900/50 p-3 rounded-lg border-2 border-yellow-500 mb-3 animate-fade">
                                                        <div className="text-sm text-yellow-400 mb-1">üìä Operazione suggerita:</div>
                                                        <div className="text-2xl font-bold text-center font-mono text-yellow-300">
                                                            {operation}
                                                        </div>
                                                        <div className="text-xs text-slate-400 text-center mt-1">
                                                            (Puoi usare la calcolatrice ‚Üí)
                                                        </div>
                                                    </div>
                                                ) : null;
                                            })()
                                        )}
                                    </div>

                                    <input
                                        type="text"
                                        value={stepAnswers[currentStep] || ''}
                                        onChange={(e) => setStepAnswers({ ...stepAnswers, [currentStep]: e.target.value })}
                                        placeholder="Scrivi la risposta..."
                                        className={`answer-input mb-4 ${
                                            hint && attempts >= 3 ? 'incorrect' : ''
                                        }`}
                                        onKeyPress={(e) => e.key === 'Enter' && validateStep()}
                                    />

                                    {hint && (
                                        <div className="hint-box mb-4">
                                            <div className="flex items-start gap-2">
                                                <span className="text-2xl">üí°</span>
                                                <div>
                                                    <div className="font-bold text-yellow-300 mb-1">
                                                        SUGGERIMENTO ({attempts}/3):
                                                    </div>
                                                    <div className="text-sm">{hint}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex gap-2">
                                        <button
                                            onClick={validateStep}
                                            className="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-3 rounded-xl active:scale-95"
                                        >
                                            ‚úÖ VERIFICA RISPOSTA
                                        </button>
                                        <button
                                            onClick={() => setShowCalc(!showCalc)}
                                            className="bg-blue-600 text-white font-bold py-3 px-5 rounded-xl active:scale-95 md:hidden"
                                        >
                                            üßÆ
                                        </button>
                                    </div>

                                    <div className="mt-4 text-xs text-slate-500 text-center">
                                        Premi INVIO o clicca VERIFICA per controllare la risposta
                                    </div>
                                </div>
                            </div>

                            {/* CALCULATOR (desktop always, mobile toggle) */}
                            <div className={`${showCalc ? 'block' : 'hidden md:block'} w-64 shrink-0`}>
                                <div className="bg-slate-800/80 backdrop-blur rounded-xl p-3 border-2 border-slate-700 sticky top-0">
                                    <div className="text-center font-bold text-yellow-400 mb-2 text-sm">üßÆ CALCOLATRICE</div>
                                    
                                    <div className="bg-slate-950 rounded-lg p-3 mb-2 text-right text-xl font-mono text-yellow-400 h-14 flex items-center justify-end overflow-hidden border-2 border-slate-600">
                                        {calcDisplay || '0'}
                                    </div>

                                    <div className="grid grid-cols-4 gap-1">
                                        {['7','8','9','√∑','4','5','6','√ó','1','2','3','-','0','.','=','+'].map(btn => (
                                            <button
                                                key={btn}
                                                onClick={() => handleCalc(btn)}
                                                className={`calc-btn ${
                                                    btn === '=' ? 'bg-green-600' :
                                                    ['√∑','√ó','-','+'].includes(btn) ? 'bg-blue-600' :
                                                    'bg-slate-700'
                                                } text-white`}
                                            >
                                                {btn}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 gap-1 mt-1">
                                        <button onClick={() => handleCalc('‚å´')} className="calc-btn bg-orange-600 text-white text-sm">‚å´</button>
                                        <button onClick={() => handleCalc('C')} className="calc-btn bg-red-600 text-white text-sm">C</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* SUCCESS MESSAGE OVERLAY */}
                        {showSuccessMessage && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 animate-fade p-4 overflow-y-auto">
                                <div className={`max-w-2xl w-full my-8 p-6 md:p-8 rounded-2xl ${
                                    showSuccessMessage.type === 'success' 
                                        ? 'bg-gradient-to-br from-green-600 to-emerald-600' 
                                        : 'bg-gradient-to-br from-blue-600 to-purple-600'
                                }`}>
                                    {showSuccessMessage.type === 'success' ? (
                                        // MESSAGGIO SUCCESSO SEMPLICE
                                        <>
                                            <div className="text-6xl md:text-7xl mb-4 animate-bounce text-center">üéâ</div>
                                            <div className="text-2xl md:text-3xl font-bold text-white mb-4 text-center">
                                                {showSuccessMessage.message}
                                            </div>
                                            {showSuccessMessage.xp && showSuccessMessage.xp !== 0 && (
                                                <div className="text-xl text-yellow-300 font-bold text-center">
                                                    {showSuccessMessage.xp > 0 ? '+' : ''}{showSuccessMessage.xp} XP
                                                </div>
                                            )}
                                        </>
                                    ) : (
                                        // MESSAGGIO CONTINUE CON SPIEGAZIONE COMPLETA + PULSANTE
                                        <>
                                            <div className="text-5xl md:text-6xl mb-4 text-center">üìñ</div>
                                            <div className="text-xl md:text-2xl font-bold text-white mb-6 text-center">
                                                {showSuccessMessage.message}
                                            </div>
                                            
                                            {/* RISPOSTA CORRETTA */}
                                            <div className="bg-white/20 rounded-xl p-4 mb-4">
                                                <div className="text-sm md:text-base text-yellow-200 font-bold mb-2">‚úÖ RISPOSTA CORRETTA:</div>
                                                <div className="text-xl md:text-2xl font-bold text-white text-center">
                                                    {showSuccessMessage.correctAnswer}
                                                </div>
                                            </div>
                                            
                                            {/* OPERAZIONE */}
                                            {showSuccessMessage.operation && (
                                                <div className="bg-white/20 rounded-xl p-4 mb-4">
                                                    <div className="text-sm md:text-base text-yellow-200 font-bold mb-2">üìä OPERAZIONE:</div>
                                                    <div className="text-xl md:text-2xl font-mono font-bold text-white text-center">
                                                        {showSuccessMessage.operation}
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {/* SPIEGAZIONE */}
                                            <div className="bg-white/20 rounded-xl p-4 mb-4">
                                                <div className="text-sm md:text-base text-yellow-200 font-bold mb-2">üí° SPIEGAZIONE:</div>
                                                <div className="text-sm md:text-base text-white leading-relaxed">
                                                    {showSuccessMessage.explanation}
                                                </div>
                                            </div>
                                            
                                            {showSuccessMessage.xp && showSuccessMessage.xp !== 0 && (
                                                <div className="text-lg text-yellow-300 font-bold text-center mb-4">
                                                    {showSuccessMessage.xp > 0 ? '+' : ''}{showSuccessMessage.xp} XP
                                                </div>
                                            )}
                                            
                                            {/* PULSANTE PER CONTINUARE */}
                                            <button
                                                onClick={handleContinueAfterExplanation}
                                                className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white font-bold py-4 rounded-xl text-lg md:text-xl active:scale-95 glow-green transition-all"
                                            >
                                                ‚úÖ HO CAPITO, CONTINUA
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // RENDER VICTORY SCREEN
            if (screen === 'victory' && problemData) {
                const totalXP = problemData.xp_guadagnati || 50;
                
                return (
                    <div className="h-screen overflow-y-auto p-4 flex items-center justify-center">
                        <div className="max-w-2xl w-full animate-fade py-8">
                            <div className="text-center mb-6">
                                <div className="text-7xl md:text-9xl mb-3 animate-pulse">üéâ</div>
                                <h1 className="text-3xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-3">
                                    PROBLEMA RISOLTO!
                                </h1>
                                <p className="text-xl md:text-2xl text-green-400 font-bold">
                                    Hai guadagnato +{totalXP} XP!
                                </p>
                            </div>

                            <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-4 md:p-6 border-2 border-green-500 mb-4">
                                <div className="text-center mb-3">
                                    <div className="text-sm text-slate-400 mb-1">XP TOTALI</div>
                                    <div className="text-4xl md:text-5xl font-bold text-yellow-400">{userXP}</div>
                                </div>

                                <div className="grid grid-cols-3 gap-3 md:gap-4 mb-3">
                                    <div className="text-center">
                                        <div className="text-2xl md:text-3xl mb-1">üìä</div>
                                        <div className="text-xs md:text-sm text-slate-400">Complessit√†</div>
                                        <div className="font-bold text-sm md:text-base">{problemData.complessita}/5</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl md:text-3xl mb-1">üéØ</div>
                                        <div className="text-xs md:text-sm text-slate-400">Step Completati</div>
                                        <div className="font-bold text-sm md:text-base">{problemData.workflow.length}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl md:text-3xl mb-1">üí°</div>
                                        <div className="text-xs md:text-sm text-slate-400">Hint Usati</div>
                                        <div className="font-bold text-sm md:text-base">{Object.keys(stepHints).length}</div>
                                    </div>
                                </div>

                                <div className="bg-green-900/30 border-2 border-green-500 rounded-xl p-3 md:p-4">
                                    <div className="font-bold text-green-400 mb-2 text-sm md:text-base">‚úÖ RISPOSTA FINALE:</div>
                                    <div className="text-base md:text-xl">{problemData.risposta_finale}</div>
                                </div>
                            </div>

                            <div className="flex flex-col md:flex-row gap-3">
                                <button
                                    onClick={() => {
                                        setScreen('upload');
                                        setImageData(null);
                                        setProblemData(null);
                                    }}
                                    className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 rounded-xl text-lg md:text-xl active:scale-95"
                                >
                                    üîÑ NUOVO PROBLEMA
                                </button>
                                <button
                                    onClick={() => {
                                        window.location.href = 'index.html';
                                    }}
                                    className="bg-slate-700 text-white font-bold py-4 px-6 rounded-xl text-lg md:text-xl active:scale-95 flex items-center justify-center"
                                    title="Torna alla home di EduGamer"
                                >
                                    üè†
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        // RENDER
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
