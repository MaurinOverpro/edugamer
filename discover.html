<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISCOVER - Risolvi con l'AI</title>
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #10b981; --error: #ef4444; --bg-light: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Header & Back Button */
        .header { text-align: center; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; position: relative; }
        .back-btn { position: absolute; left: 15px; top: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; transition: 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* XP Bar */
        .xp-container { background: rgba(0,0,0,0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-top: 15px; }
        .xp-fill { background: linear-gradient(90deg, #f093fb, #f5576c); height: 100%; width: 0%; transition: width 0.5s; }

        /* Box Problema Persistente */
        #problem-sticky-box { background: white; color: #1e293b; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--primary); display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: fadeIn 0.5s ease; }
        #problem-sticky-box h4 { color: var(--primary); font-size: 14px; text-transform: uppercase; margin-bottom: 5px; }
        #problem-text-display { font-size: 17px; line-height: 1.5; font-style: italic; }

        /* Card Steps */
        .step-card { background: white; color: #1e293b; border-radius: 20px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 20px; display: none; }
        .active { display: block; animation: slideUp 0.4s ease; }

        .step-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        .step-num { background: var(--primary); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        
        textarea, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 8px; font-size: 16px; transition: 0.3s; }
        .btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .feedback { padding: 15px; border-radius: 10px; margin-top: 15px; font-weight: bold; display: none; }
        .hint { background: #fffbeb; color: #92400e; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; border-left: 4px solid #f59e0b; display: none; }
        
        /* CALCOLATRICE POPUP */
        .calc-toggle { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: white; color: var(--primary); border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.3); font-size: 24px; z-index: 1000; transition: 0.3s; }
        .calc-toggle:hover { transform: scale(1.1); }
        
        .calc-popup { position: fixed; bottom: 100px; right: 30px; width: 260px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: none; z-index: 1000; border: 1px solid rgba(255,255,255,0.3); }
        .calc-display { background: #1e293b; color: #00ff88; padding: 15px; text-align: right; font-size: 20px; border-radius: 10px; margin-bottom: 10px; font-family: monospace; overflow-x: auto; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .c-btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; background: #e2e8f0; color: #1e293b; transition: 0.2s; }
        .c-btn:hover { background: #cbd5e1; }
        .c-btn.op { background: var(--primary); color: white; }
        .c-btn.eq { background: var(--success); color: white; grid-column: span 2; }
        .c-btn.clr { background: var(--error); color: white; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <a href="matematica.html" class="back-btn">‚Üê Matematica</a>
        <h1>üîç DISCOVER</h1>
        <div class="xp-container"><div class="xp-fill" id="xp-bar"></div></div>
        <p style="margin-top:5px; font-size: 13px;">Livello <span id="lvl">1</span> ‚Ä¢ <span id="xp-text">0</span> XP</p>
    </div>

    <div id="problem-sticky-box">
        <h4>üìù Il Problema da risolvere:</h4>
        <div id="problem-text-display"></div>
    </div>

    <div class="step-card active" id="step1">
        <div class="step-header"><div class="step-num">1</div><h2>Cosa dobbiamo risolvere?</h2></div>
        <textarea id="input-problema" rows="5" placeholder="Es: Maria ha 20 euro, ne spende 5 per un gelato e 2 per una bibita. Quanto le resta?"></textarea>
        <button class="btn" onclick="analizza()">Analizza Problema ‚ú®</button>
    </div>

    <div id="loader" style="display:none; text-align:center; padding:40px;">
        <div class="spinner" style="border:4px solid white; border-top:4px solid transparent; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto;"></div>
        <p style="margin-top:15px; color:white;">L'AI sta preparando la sfida...</p>
    </div>

    <div class="step-card" id="step2">
        <div class="step-header"><div class="step-num">2</div><h2>I dati importanti</h2></div>
        <input type="text" id="ans2" placeholder="Scrivi i numeri separati da virgola...">
        <button class="btn" onclick="check2()">Verifica Dati ‚úì</button>
        <div class="feedback" id="f2"></div>
    </div>

    <div class="step-card" id="step3">
        <div class="step-header"><div class="step-num">3</div><h2>Capiamo la situazione</h2></div>
        <div id="q3-container"></div>
        <button class="btn" onclick="check3()">Continua ‚úì</button>
        <div class="feedback" id="f3"></div>
    </div>

    <div class="step-card" id="step4">
        <div class="step-header"><div class="step-num">4</div><h2>Facciamo i calcoli</h2></div>
        <div id="q4-container"></div>
        <button class="btn" onclick="check4()">Verifica Passaggi ‚úì</button>
        <div class="feedback" id="f4"></div>
    </div>

    <div class="step-card" id="step5">
        <div class="step-header"><div class="step-num">5</div><h2>La risposta finale</h2></div>
        <div id="q5-container"></div>
        <button class="btn" onclick="check5()">Concludi üéØ</button>
        <div class="feedback" id="f5"></div>
    </div>
</div>

<button class="calc-toggle" onclick="toggleCalc()">üî¢</button>
<div class="calc-popup" id="calc-box">
    <div class="calc-display" id="calc-screen">0</div>
    <div class="calc-grid">
        <button class="c-btn clr" onclick="calcClear()">C</button>
        <button class="c-btn op" onclick="calcPush('/')">√∑</button>
        <button class="c-btn op" onclick="calcPush('*')">√ó</button>
        <button class="c-btn op" onclick="calcPush('-')">-</button>
        
        <button class="c-btn" onclick="calcPush('7')">7</button>
        <button class="c-btn" onclick="calcPush('8')">8</button>
        <button class="c-btn" onclick="calcPush('9')">9</button>
        <button class="c-btn op" onclick="calcPush('+')">+</button>
        
        <button class="c-btn" onclick="calcPush('4')">4</button>
        <button class="c-btn" onclick="calcPush('5')">5</button>
        <button class="c-btn" onclick="calcPush('6')">6</button>
        <button class="c-btn" onclick="calcPush('.')">,</button>
        
        <button class="c-btn" onclick="calcPush('1')">1</button>
        <button class="c-btn" onclick="calcPush('2')">2</button>
        <button class="c-btn" onclick="calcPush('3')">3</button>
        <button class="c-btn" onclick="calcPush('0')">0</button>
        
        <button class="c-btn eq" onclick="calcSolve()">=</button>
    </div>
</div>

<script>
let state = { data: null, xp: 0, attempts: {}, testoOriginale: "" };
let calcCurrent = "";

const API_KEY = localStorage.getItem('gemini_api_key') || prompt("Inserisci la tua API Key Gemini:");
if(API_KEY) localStorage.setItem('gemini_api_key', API_KEY);

// LOGICA CALCOLATRICE
function toggleCalc() {
    const box = document.getElementById('calc-box');
    box.style.display = box.style.display === 'block' ? 'none' : 'block';
}

function calcPush(val) {
    if(calcCurrent === "0" && val !== ".") calcCurrent = "";
    calcCurrent += val;
    document.getElementById('calc-screen').textContent = calcCurrent.replace('*', '√ó').replace('/', '√∑');
}

function calcClear() {
    calcCurrent = "0";
    document.getElementById('calc-screen').textContent = "0";
}

function calcSolve() {
    try {
        let res = eval(calcCurrent);
        calcCurrent = Number.isInteger(res) ? res.toString() : res.toFixed(2);
        document.getElementById('calc-screen').textContent = calcCurrent;
    } catch {
        document.getElementById('calc-screen').textContent = "Errore";
        calcCurrent = "";
    }
}

// LOGICA DISCOVER (Stesse funzioni dell'aggiornamento precedente)
function updateXP(pts) {
    state.xp += pts;
    document.getElementById('xp-bar').style.width = (state.xp % 100) + '%';
    document.getElementById('xp-text').textContent = state.xp;
    document.getElementById('lvl').textContent = Math.floor(state.xp / 100) + 1;
}

function validate(input, expected, type) {
    if (!input) return false;
    let cleanIn = input.toString().toLowerCase().trim();
    let cleanExp = expected.toString().toLowerCase().trim();
    if (type === 'number') {
        let numIn = cleanIn.replace(',', '.').match(/(\d+(\.\d+)?)/);
        let numExp = cleanExp.replace(',', '.').match(/(\d+(\.\d+)?)/);
        return numIn && numExp && parseFloat(numIn[0]) === parseFloat(numExp[0]);
    }
    return cleanIn.includes(cleanExp) || cleanExp.includes(cleanIn);
}

async function analizza() {
    state.testoOriginale = document.getElementById('input-problema').value.trim();
    if(!state.testoOriginale) return;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('loader').style.display = 'block';

    const prompt = `Analizza questo problema: "${state.testoOriginale}". Rispondi SOLO JSON: 
    {"numeri": ["20", "5", "2"], "analisi": [{"q": "Cosa fa Maria?", "a": "spende", "t": "text"}], "calcoli": [{"q": "Quanto spende in tutto?", "c": "5+2", "a": "7", "t": "number"}], "finale": [{"q": "Resto finale:", "a": "13", "t": "number"}]}`;

    try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`, {
            method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const json = await resp.json();
        let raw = json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
        state.data = JSON.parse(raw);
        document.getElementById('problem-text-display').textContent = state.testoOriginale;
        document.getElementById('problem-sticky-box').style.display = 'block';
        document.getElementById('loader').style.display = 'none';
        document.getElementById('step2').classList.add('active');
        updateXP(10);
    } catch(e) { alert("Errore"); location.reload(); }
}

function check2() {
    let inNums = document.getElementById('ans2').value.match(/\d+/g) || [];
    if(inNums.length >= state.data.numeri.length) {
        showFeedback('f2', true, "Dati corretti!");
        setTimeout(() => { 
            document.getElementById('step2').classList.remove('active');
            renderQuestions('q3-container', state.data.analisi, 's3');
            document.getElementById('step3').classList.add('active');
        }, 800);
        updateXP(20);
    } else showFeedback('f2', false, "Rileggi bene!");
}

function renderQuestions(id, list, prefix) {
    document.getElementById(id).innerHTML = list.map((item, i) => `
        <div style="margin-bottom:15px">
            <p><strong>${item.q}</strong></p>
            <input type="text" id="${prefix}-${i}" autocomplete="off">
            <div id="hint-${prefix}-${i}" class="hint">üí° Rileggi il problema nel riquadro bianco!</div>
        </div>
    `).join('');
}

function checkStep(list, prefix, nextStepId, feedbackId, currentStepId) {
    let allOk = true;
    list.forEach((item, i) => {
        if(!validate(document.getElementById(`${prefix}-${i}`).value, item.a, item.t)) {
            allOk = false;
            state.attempts[`${prefix}-${i}`] = (state.attempts[`${prefix}-${i}`] || 0) + 1;
            if(state.attempts[`${prefix}-${i}`] >= 2) document.getElementById(`hint-${prefix}-${i}`).style.display = 'block';
        }
    });
    if(allOk) {
        showFeedback(feedbackId, true, "Esatto!");
        updateXP(30);
        setTimeout(() => {
            document.getElementById(currentStepId).classList.remove('active');
            if(nextStepId === 'step4') renderQuestions('q4-container', state.data.calcoli, 's4');
            if(nextStepId === 'step5') renderQuestions('q5-container', state.data.finale, 's5');
            if(nextStepId) document.getElementById(nextStepId).classList.add('active');
        }, 800);
    } else showFeedback(feedbackId, false, "Riprova!");
}

function check3() { checkStep(state.data.analisi, 's3', 'step4', 'f3', 'step3'); }
function check4() { checkStep(state.data.calcoli, 's4', 'step5', 'f4', 'step4'); }
function check5() { showFeedback('f5', true, "Fantastico!"); updateXP(50); }

function showFeedback(id, isOk, msg) {
    const el = document.getElementById(id);
    el.style.display = 'block'; el.style.background = isOk ? '#d1fae5' : '#fee2e2';
    el.style.color = isOk ? '#065f46' : '#991b1b'; el.textContent = msg;
}
</script>
</body>
</html>
